<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="#4f46e5">
  <meta name="description" content="Iniciar sesión - Airport">
  <title>Iniciar sesión - Airport</title>
  <link rel="stylesheet" href="css/styles.css">
  <style>
    /* Estilos específicos de la página de login */
    .login-page {
      min-height: 100vh;
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      background-color: var(--color-background);
    }
    .login-card {
      width: 100%;
      max-width: 400px;
      padding: 1.5rem;
      background: var(--color-surface);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-md);
      border: 1px solid var(--color-border);
    }
    .login-title {
      margin: 0 0 0.25rem 0;
      font-size: var(--font-size-xl);
      font-weight: var(--font-weight-semibold);
      color: var(--color-text);
      text-align: center;
    }
    .login-subtitle {
      margin: 0 0 1.5rem 0;
      font-size: var(--font-size-sm);
      color: var(--color-text-muted);
      text-align: center;
    }
    .login-form .form-group:last-of-type {
      margin-bottom: 1.25rem;
    }
    .login-submit {
      width: 100%;
      padding: 0.625rem 1rem;
      font-size: var(--font-size-base);
    }
    .login-error {
      padding: 0.75rem 1rem;
      margin-bottom: 1rem;
      background-color: #fef2f2;
      border: 1px solid #fecaca;
      border-radius: var(--radius-sm);
      color: var(--color-danger);
      font-size: var(--font-size-sm);
      display: none;
    }
    .login-error.visible {
      display: block;
    }
    .login-warning {
      padding: 0.75rem 1rem;
      margin-bottom: 1rem;
      background-color: #fef3c7;
      border: 1px solid #fcd34d;
      border-radius: var(--radius-sm);
      color: #92400e;
      font-size: var(--font-size-sm);
    }
    .login-warning code { background: rgba(0,0,0,0.08); padding: 0.1rem 0.3rem; border-radius: 2px; }
    .login-loading .login-submit {
      position: relative;
      color: transparent;
    }
    .login-loading .login-submit::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      border: 2px solid var(--color-border);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      top: 50%;
      left: 50%;
      margin-top: -10px;
      margin-left: -10px;
    }
  </style>
</head>
<body>
  <div class="login-page">
    <div class="login-card">
      <h1 class="login-title">Airport</h1>
      <p class="login-subtitle">Sistema de gestión de pedidos</p>

      <!-- Aviso: abrir con servidor local (si se abre con file://) -->
      <div id="file-protocol-warning" class="login-warning" role="alert" hidden>
        Para que el inicio de sesión funcione, abre la app con un servidor local.<br>
        En la carpeta <code>airport-app</code> ejecuta: <code>npx serve .</code><br>
        Luego entra a <strong>http://localhost:3000/login.html</strong>
      </div>
      <!-- Mensaje de error (oculto por defecto) -->
      <div id="login-error" class="login-error" role="alert" aria-live="assertive"></div>

      <form id="login-form" class="login-form" novalidate>
        <div class="form-group">
          <label for="user" class="form-label">Usuario o correo</label>
          <input
            type="text"
            id="user"
            name="user"
            class="form-input"
            autocomplete="username"
            placeholder="chanti"
            required
          >
          <span id="user-error" class="form-error" aria-live="polite"></span>
        </div>
        <div class="form-group">
          <label for="password" class="form-label">Contraseña</label>
          <input
            type="password"
            id="password"
            name="password"
            class="form-input"
            autocomplete="current-password"
            required
          >
          <span id="password-error" class="form-error" aria-live="polite"></span>
        </div>
        <button type="submit" class="btn btn--primary login-submit" id="submit-btn">
          Iniciar sesión
        </button>
      </form>
    </div>
  </div>

  <script>
    // Comprobar si se abrió con file:// (doble clic). Los módulos no funcionan así.
    (function () {
      if (window.location.protocol !== 'file:') return;
      var warning = document.getElementById('file-protocol-warning');
      var form = document.getElementById('login-form');
      if (warning) warning.hidden = false;
      // Evitar envío por defecto y que la página "no haga nada" sin explicación
      if (form) {
        form.addEventListener('submit', function (e) {
          e.preventDefault();
          if (warning) {
            warning.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            warning.setAttribute('tabindex', '-1');
            warning.focus();
          }
        });
      }
    })();
  </script>
  <script type="module">
    /**
     * Lógica de la página de login:
     * - Validación básica en cliente
     * - Loading state durante el envío
     * - Manejo de errores con mensajes visibles
     * - Redirección a index.html tras login exitoso
     */
    import { login } from './js/modules/auth.js';

    const form = document.getElementById('login-form');
    const userInput = document.getElementById('user');
    const passwordInput = document.getElementById('password');
    const userError = document.getElementById('user-error');
    const passwordError = document.getElementById('password-error');
    const loginErrorBox = document.getElementById('login-error');
    const submitBtn = document.getElementById('submit-btn');

    /** Muestra el mensaje de error global del formulario */
    function showFormError(message) {
      loginErrorBox.textContent = message || 'Error al iniciar sesión.';
      loginErrorBox.classList.add('visible');
    }

    /** Oculta el mensaje de error global */
    function hideFormError() {
      loginErrorBox.textContent = '';
      loginErrorBox.classList.remove('visible');
    }

    /** Limpia errores inline de los campos */
    function clearFieldErrors() {
      userError.textContent = '';
      passwordError.textContent = '';
      userInput.classList.remove('error');
      passwordInput.classList.remove('error');
    }

    /**
     * Validación: usuario/correo no vacío (si es correo, formato válido), contraseña no vacía.
     * @returns {boolean}
     */
    function validateForm() {
      clearFieldErrors();
      let valid = true;
      const user = userInput.value.trim();
      const password = passwordInput.value;

      if (!user) {
        userError.textContent = 'El usuario o correo es obligatorio.';
        userInput.classList.add('error');
        valid = false;
      } else if (user.includes('@') && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(user)) {
        userError.textContent = 'Introduce un correo válido.';
        userInput.classList.add('error');
        valid = false;
      }

      if (!password) {
        passwordError.textContent = 'La contraseña es obligatoria.';
        passwordInput.classList.add('error');
        valid = false;
      }

      return valid;
    }

    /** Activa/desactiva el estado de carga del botón */
    function setLoading(loading) {
      submitBtn.disabled = loading;
      form.classList.toggle('login-loading', loading);
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      hideFormError();
      if (!validateForm()) return;

      setLoading(true);
      try {
        const result = await login(userInput.value.trim(), passwordInput.value);
        if (result.success) {
          window.location.href = 'app.html';
          return;
        }
        showFormError(result.error || 'Error al iniciar sesión.');
      } catch (err) {
        console.error('Error en submit login:', err);
        showFormError(err.message || 'Error inesperado. Inténtalo de nuevo.');
      } finally {
        setLoading(false);
      }
    });
  </script>
</body>
</html>
