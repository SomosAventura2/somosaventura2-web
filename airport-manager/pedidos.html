<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f2744">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Airport">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Pedidos - Airport Manager</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="images/icon-192.png">
</head>
<body>
    <header class="header">
        <div class="header-content">
            <a href="dashboard.html" class="logo">AIRPORT</a>
            <nav class="nav">
                <div class="nav-scroll" id="navScroll">
                    <a href="dashboard.html" class="nav-item">Dashboard</a>
                    <a href="pedidos.html" class="nav-item active">Pedidos</a>
                    <a href="pagos.html" class="nav-item">Pagos</a>
                    <a href="calendario.html" class="nav-item">Calendario</a>
                    <a href="notas.html" class="nav-item">Notas</a>
                    <a href="estadisticas.html" class="nav-item">Stats</a>
                </div>
                <a href="#" class="nav-logout" onclick="logout()">Salir</a>
            </nav>
        </div>
    </header>

    <main class="container main-content pedidos-page">
        <div class="pedidos-header">
            <h1 class="pedidos-title mb-4">Pedidos</h1>
            <button type="button" class="pedidos-btn-new" onclick="openNewOrderModal()">+ Nuevo</button>
        </div>

        <section class="pedidos-section pedidos-filters">
            <select id="filterStatus" class="pedidos-filter-select">
                <option value="">Todos</option>
                <option value="agendado">Agendado</option>
                <option value="en_produccion">En Producción</option>
                <option value="listo">Listo</option>
                <option value="entregado">Entregado</option>
            </select>
            <input type="text" id="searchCustomer" class="pedidos-filter-search" placeholder="Buscar cliente...">
        </section>

        <div id="ordersList" class="pedidos-list">
            <div class="pedidos-loading"><div class="spinner-container"><div class="spinner"></div></div></div>
        </div>
    </main>

    <!-- Modal Nuevo/Editar Pedido -->
    <div id="orderModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeOrderModal()">&times;</button>
            <h2 id="modalTitle" class="mb-4">Nuevo Pedido</h2>
            <form id="orderForm">
                <input type="hidden" id="orderId">
                <input type="hidden" id="customerId">
                
                <div class="form-group customer-search-wrap">
                    <label class="form-label" for="customerSearch">Cliente*</label>
                    <input type="text" id="customerSearch" class="form-input" placeholder="Buscar o crear cliente..." autocomplete="off">
                    <div id="customerSuggestions" class="customer-suggestions hidden"></div>
                    <div id="selectedCustomerCard" class="customer-card hidden">
                        <div class="customer-card-header">
                            <strong id="selectedCustomerName"></strong>
                            <span id="selectedCustomerBadge" class="badge-vip hidden"></span>
                        </div>
                        <div class="customer-card-meta" id="selectedCustomerMeta"></div>
                        <div class="customer-card-stats" id="selectedCustomerStats"></div>
                        <button type="button" class="btn btn-outline btn-sm" onclick="clearSelectedCustomer()">Cambiar cliente</button>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Productos del Pedido*</label>
                    <div id="itemsContainer"></div>
                    <button type="button" class="btn btn-outline btn-sm mt-2" onclick="addItem()">+ Agregar Producto</button>
                </div>

                <div class="grid grid-2">
                    <div class="form-group">
                        <label class="form-label" for="amountEuros">Monto en Euros (Referencia)*</label>
                        <input type="number" inputmode="decimal" id="amountEuros" class="form-input" step="0.01" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="paymentPercentage">Pago Inicial*</label>
                        <select id="paymentPercentage" class="form-select" required>
                            <option value="0">Ninguno</option>
                            <option value="50">50% - Agendar</option>
                            <option value="100">100% - Completo</option>
                        </select>
                    </div>
                </div>

                <div id="paymentInitialFields">
                    <div class="grid grid-2">
                        <div class="form-group">
                            <label class="form-label" for="paymentAmount">Monto del Pago*</label>
                            <input type="number" inputmode="decimal" id="paymentAmount" class="form-input" step="0.01" placeholder="0.00">
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="paymentCurrency">Moneda*</label>
                            <select id="paymentCurrency" class="form-select">
                                <option value="BS">Bolívares</option>
                                <option value="USD">Dólares</option>
                                <option value="USDT">USDT</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group hidden" id="paymentMethodDollarsGroup">
                        <label class="form-label" for="paymentMethodDollars">Método de pago (dólares)*</label>
                        <select id="paymentMethodDollars" class="form-select">
                            <option value="efectivo_usd">Efectivo</option>
                            <option value="zelle">Zelle</option>
                        </select>
                    </div>

                    <div class="form-group" id="pagoMovilRefGroup">
                        <label class="form-label" for="pagoMovilReference">REF.</label>
                        <input type="tel" inputmode="numeric" pattern="[0-9]*" id="pagoMovilReference" class="form-input" placeholder="Solo números (opcional)">
                    </div>
                </div>

                <div class="grid grid-2">
                    <div class="form-group">
                        <label class="form-label" for="status">Estado*</label>
                        <select id="status" class="form-select" required>
                            <option value="agendado">Agendado</option>
                            <option value="en_produccion">En Producción</option>
                            <option value="listo">Listo</option>
                            <option value="entregado">Entregado</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="deliveryDate">Fecha de Entrega*</label>
                        <input type="date" id="deliveryDate" class="form-input" required>
                    </div>
                </div>

                <div id="formMessage"></div>

                <div class="flex flex-gap-2 mt-4">
                    <button type="submit" class="btn btn-primary">Guardar Pedido</button>
                    <button type="button" class="btn btn-outline" onclick="closeOrderModal()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Ver Detalles -->
    <div id="detailsModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeDetailsModal()">&times;</button>
            <div id="orderDetails"></div>
        </div>
    </div>

    <!-- Modal Nuevo Cliente -->
    <div id="newCustomerModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeNewCustomerModal()">&times;</button>
            <h2 class="mb-3">Nuevo Cliente</h2>
            <form id="newCustomerForm">
                <div class="form-group">
                    <label class="form-label" for="newCustomerFirstName">Nombre*</label>
                    <input type="text" id="newCustomerFirstName" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="newCustomerLastName">Apellido*</label>
                    <input type="text" id="newCustomerLastName" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="newCustomerPhone">Teléfono*</label>
                    <input type="tel" id="newCustomerPhone" class="form-input" placeholder="0424-1234567">
                </div>
                <div class="form-group">
                    <label class="form-label" for="newCustomerEmail">Email (opcional)</label>
                    <input type="email" id="newCustomerEmail" class="form-input" placeholder="cliente@email.com">
                </div>
                <p class="form-hint">Al menos teléfono o email es obligatorio.</p>
                <div id="newCustomerMessage" class="form-message"></div>
                <div class="flex flex-gap-2 mt-3">
                    <button type="submit" class="btn btn-primary">Guardar</button>
                    <button type="button" class="btn btn-outline" onclick="closeNewCustomerModal()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
    <script src="js/supabase-config.js"></script>
    <script src="js/pedidos.js"></script>
</body>
</html>
