<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SomosAventura - Gestión</title>
    <link rel="icon" type="image/png" href="/favicon.png?v=99" sizes="32x32">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png?v=99">
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SomosAventura">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --app-header-content-height: 60px;
            --app-header-total-height: calc(var(--app-header-content-height) + 10px + env(safe-area-inset-top));
            --whatsapp: #25D366;
            --green-primary: #4CAF50;
            --green-mountain: #2d5a3d;
            --green-dark: #1a3a28;
            --bg-dark: #0e2f36;
            --bg-card: #1a3d47;
            --text-primary: #ffffff;
            --text-secondary: #b8c5be;
            --accent: #76c893;
            --shadow: rgba(0, 0, 0, 0.5);
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --border: rgba(118, 200, 147, 0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            background-color: var(--bg-dark);
        }

        body {
            font-family: 'Poppins', sans-serif;
            /* Fondo oscuro "infinito": rebote arriba/abajo muestra mismo color; verde solo en .app-header */
            background-color: var(--bg-dark);
            color: var(--text-primary);
            /* Sin padding-top: el header es fixed y la compensación va en .app */
            padding-bottom: calc(80px + env(safe-area-inset-bottom));
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
            -webkit-font-smoothing: antialiased;
            line-height: 1.6;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }

        .app-header-logo {
            max-height: 50px;
            height: auto;
            width: auto;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }

        /* ===== APP ===== */
        .app {
            max-width: 480px;
            margin: 0 auto;
            display: none;
            background: var(--bg-dark);
            min-height: 100vh;
            /* Compensación: el header es fixed y no ocupa espacio; evita que la primera tarjeta quede detrás */
            padding-top: var(--app-header-total-height);
            --app-header-content-height: 60px;
            --app-header-total-height: calc(var(--app-header-content-height) + 10px + env(safe-area-inset-top));
        }

        .app.active {
            display: block;
        }

        /* Header: FIJO (sticky header definitivo) — no se mueve con el scroll; evita gaps en overscroll iOS */
        .app-header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 9999;
            background: linear-gradient(135deg, var(--green-mountain) 0%, var(--green-dark) 100%);
            color: white;
            padding-top: env(safe-area-inset-top);
            padding-bottom: 10px;
            padding-left: calc(12px + env(safe-area-inset-left));
            padding-right: calc(12px + env(safe-area-inset-right));
            min-height: calc(var(--app-header-content-height) + 10px + env(safe-area-inset-top));
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 16px var(--shadow);
        }

        .app-header .logo-text {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .app-header .logo-text img {
            max-height: 40px;
            height: auto;
            width: auto;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }

        .app-header h1 {
            font-size: 18px;
            font-weight: 800;
            line-height: 1.2;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            border: 2px solid white;
            color: white;
            padding: 8px 14px;
            min-height: 38px;
            min-width: 38px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            -webkit-tap-highlight-color: rgba(255, 255, 255, 0.3);
            touch-action: manipulation;
            white-space: nowrap;
        }

        .logout-btn:hover {
            background: white;
            color: var(--green-mountain);
        }

        /* Tabs: sticky debajo del header fijo; top = altura visual del header */
        .nav-tabs {
            position: sticky;
            top: var(--app-header-total-height);
            z-index: 9990;
            background: var(--bg-card);
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            border-bottom: 2px solid var(--border);
            margin-top: 0;
            box-shadow: 0 2px 8px var(--shadow);
            width: 100%;
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }

        .nav-tab {
            padding: 14px 8px;
            min-height: 44px; /* Touch target mínimo para iPhone */
            min-width: 44px;
            text-align: center;
            cursor: pointer;
            font-size: 11px;
            font-weight: 700;
            color: var(--text-secondary);
            border: none;
            background: transparent;
            white-space: nowrap;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            overflow: hidden;
            text-overflow: ellipsis;
            /* Touch optimizado para iOS */
            -webkit-tap-highlight-color: rgba(118, 200, 147, 0.2);
            touch-action: manipulation;
        }

        @media (min-width: 360px) {
            .nav-tab {
                font-size: 12px;
                padding: 16px 10px;
            }
        }

        @media (min-width: 400px) {
            .nav-tab {
                font-size: 13px;
                padding: 18px 12px;
            }
        }

        .nav-tab:hover {
            color: var(--accent);
            background: rgba(118, 200, 147, 0.1);
        }

        .nav-tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
            background: rgba(118, 200, 147, 0.1);
        }

        /* Solo iconos visibles: texto oculto en todas las pestañas */
        .nav-tab .text,
        .nav-tab span.text {
            display: none !important;
        }

        /* Content */
        .section {
            display: none;
            padding: 20px 16px;
            /* Safe area para iPhone */
            padding-left: calc(16px + env(safe-area-inset-left));
            padding-right: calc(16px + env(safe-area-inset-right));
            /* Scroll optimizado para iOS */
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }

        .section.active {
            display: block;
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 4px 12px var(--shadow);
            border: 1px solid var(--border);
            transition: all 0.3s;
        }

        .card:hover {
            box-shadow: 0 8px 24px rgba(118, 200, 147, 0.2);
            transform: translateY(-2px);
            border-color: rgba(118, 200, 147, 0.3);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 800;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-meta {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* Badges */
        .badge {
            padding: 6px 14px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 700;
            white-space: nowrap;
        }

        .badge-active {
            background: rgba(16, 185, 129, 0.2);
            color: var(--accent);
        }

        .badge-closed {
            background: rgba(239, 68, 68, 0.2);
            color: #ff6b6b;
        }

        .badge-warning {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
        }

        .badge-paid {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
        }

        .badge-pending {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
        }

        /* Stats */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 16px;
        }

        .stat {
            background: rgba(118, 200, 147, 0.1);
            padding: 14px 10px;
            border-radius: 14px;
            text-align: center;
            border: 1px solid var(--border);
        }

        .stat-value {
            font-size: 20px;
            font-weight: 800;
            color: var(--accent);
            display: block;
        }

        .stat-label {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 4px;
            display: block;
        }

        /* Cards de Reserva Compactos */
        .reserva-card {
            padding: 16px;
        }

        .reserva-compact {
            padding: 0;
        }

        .btn-expand-reserva {
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 6px 10px;
            min-width: 44px; /* Touch target mínimo para iPhone */
            min-height: 44px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            /* Touch optimizado para iOS */
            -webkit-tap-highlight-color: rgba(118, 200, 147, 0.2);
            touch-action: manipulation;
        }

        .btn-expand-reserva:hover {
            background: rgba(118, 200, 147, 0.1);
            border-color: rgba(118, 200, 147, 0.3);
            transform: scale(1.05);
        }

        .expand-icon {
            font-size: 14px;
            color: var(--text-secondary);
            transition: transform 0.3s ease;
            display: inline-block;
        }

        .reserva-expanded {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Cards de Asistencia Compactos */
        .asistencia-card {
            padding: 16px;
        }

        .asistencia-compact {
            padding: 0;
        }

        .asistencia-expanded {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
            animation: slideDown 0.3s ease;
        }

        /* Payment Progress */
        .payment-progress {
            margin-top: 16px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 999px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success) 0%, var(--accent) 100%);
            transition: width 0.5s ease;
        }

        .progress-text {
            font-size: 13px;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
        }

        /* Buttons */
        .btn {
            display: block;
            width: 100%;
            padding: 16px;
            min-height: 44px; /* Touch target mínimo para iPhone */
            border-radius: 16px;
            border: none;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            text-align: center;
            text-decoration: none;
            transition: all 0.3s;
            /* Touch optimizado para iOS */
            -webkit-tap-highlight-color: rgba(118, 200, 147, 0.2);
            touch-action: manipulation;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--green-primary) 0%, var(--green-mountain) 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.5);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--accent);
            color: var(--accent);
        }

        .btn-outline:hover {
            background: var(--accent);
            color: var(--bg-dark);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-small {
            padding: 10px 18px;
            min-height: 44px; /* Touch target mínimo para iPhone */
            /* Touch optimizado para iOS */
            -webkit-tap-highlight-color: rgba(118, 200, 147, 0.2);
            touch-action: manipulation;
            font-size: 14px;
            border-radius: 12px;
            display: inline-block;
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            padding: 14px 16px;
            min-height: 44px; /* Touch target mínimo para iPhone */
            border: 2px solid var(--border);
            border-radius: 14px;
            font-size: 16px; /* Mínimo 16px para evitar zoom en iOS */
            transition: all 0.3s;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            /* Prevenir zoom en iOS */
            appearance: none;
            -webkit-appearance: none;
            touch-action: manipulation;
        }

        .form-input::placeholder {
            color: var(--text-secondary);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px rgba(118, 200, 147, 0.2);
            background: rgba(255, 255, 255, 0.15);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        /* =============================================
           BARRAS DE BÚSQUEDA CON FILTRO INTEGRADO
           ============================================= */
        
        .search-filter-container {
            position: relative;
            display: flex;
            align-items: stretch;
            width: 100%;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid var(--border);
            border-radius: 14px;
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .search-filter-container:focus-within {
            border-color: var(--accent);
            box-shadow: 0 0 0 4px rgba(118, 200, 147, 0.2);
            background: rgba(255, 255, 255, 0.15);
        }

        /* Campo de búsqueda */
        .search-box {
            flex: 1;
            min-width: 0;
            padding: 14px 16px 14px 44px;
            min-height: 44px;
            border: none;
            border-radius: 0;
            font-size: 16px;
            background: transparent;
            color: var(--text-primary);
            appearance: none;
            -webkit-appearance: none;
            touch-action: manipulation;
            transition: all 0.3s;
        }

        .search-box::placeholder {
            color: var(--text-secondary);
        }

        .search-box:focus {
            outline: none;
        }

        /* Icono de búsqueda */
        .search-filter-container::before {
            content: '';
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="%23b8c5be" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>') no-repeat center;
            pointer-events: none;
            transition: all 0.3s;
            z-index: 1;
        }

        .search-filter-container:focus-within::before {
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="%2376c893" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>') no-repeat center;
        }

        /* Separador visual */
        .search-filter-separator {
            width: 1px;
            height: 28px;
            background: var(--border);
            flex-shrink: 0;
            align-self: center;
            margin: 0 4px;
        }

        /* Contenedor del filtro */
        .search-filter-wrapper {
            display: flex;
            align-items: center;
            position: relative;
            flex-shrink: 0;
        }

        /* Select del filtro - diseño compacto */
        .search-filter-select {
            padding: 14px 36px 14px 12px;
            min-height: 44px;
            border: none;
            border-radius: 0;
            font-size: 16px;
            background: transparent;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s ease;
            appearance: none;
            -webkit-appearance: none;
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="%23b8c5be" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>');
            background-repeat: no-repeat;
            background-position: right 12px center;
            min-width: 50px;
            width: 50px;
            max-width: 50px;
            flex-shrink: 0;
            -webkit-tap-highlight-color: rgba(118, 200, 147, 0.2);
            touch-action: manipulation;
            overflow: hidden;
            text-indent: -9999px;
        }

        /* Cuando hay valor seleccionado o está enfocado */
        .search-filter-select.has-value,
        .search-filter-select:focus {
            text-indent: 0;
            min-width: 150px;
            width: auto;
            max-width: 200px;
            padding-right: 36px;
            padding-left: 12px;
        }

        .search-filter-select:focus {
            outline: none;
        }

        .search-filter-select option {
            background: var(--bg-card);
            color: var(--text-primary);
            padding: 8px;
        }

        /* Responsive */
        @media (max-width: 480px) {
            .search-filter-container {
                border-radius: 12px;
            }

            .search-box {
                padding: 12px 12px 12px 40px;
                font-size: 16px;
            }

            .search-filter-container::before {
                left: 12px;
                width: 18px;
                height: 18px;
            }

            .search-filter-select {
                min-width: 44px;
                width: 44px;
                max-width: 44px;
                padding: 12px 32px 12px 8px;
            }

            .search-filter-select.has-value,
            .search-filter-select:focus {
                min-width: 120px;
                max-width: 150px;
                padding-right: 32px;
                padding-left: 10px;
            }

            .search-filter-separator {
                height: 24px;
                margin: 0 2px;
            }
        }

        @media (max-width: 375px) {
            .search-filter-select.has-value,
            .search-filter-select:focus {
                min-width: 100px;
                max-width: 130px;
            }
        }

        /* Versión sin filtro (para historial) */
        .search-box-standalone {
            width: 100%;
            padding: 14px 20px 14px 44px;
            min-height: 44px; /* Touch target mínimo para iPhone */
            border: 2px solid var(--border);
            border-radius: 999px;
            font-size: 16px; /* Mínimo 16px para evitar zoom en iOS */
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.1) url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="%23b8c5be" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>') no-repeat 16px center;
            transition: all 0.3s;
            color: var(--text-primary);
            /* Prevenir zoom en iOS */
            appearance: none;
            -webkit-appearance: none;
            touch-action: manipulation;
        }

        .search-box-standalone::placeholder {
            color: var(--text-secondary);
        }

        .search-box-standalone:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px rgba(118, 200, 147, 0.2);
            background: rgba(255, 255, 255, 0.15) url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="%2376c893" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>') no-repeat 16px center;
        }

        /* List Items */
        .list-item {
            padding: 16px 0;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }

        .list-item:last-child {
            border-bottom: none;
        }

        .list-item-info {
            flex: 1;
        }

        .list-item-title {
            font-weight: 700;
            margin-bottom: 4px;
            font-size: 15px;
        }

        .list-item-subtitle {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* Compact Person List */
        .person-list-compact {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .person-item-compact {
            background: rgba(118, 200, 147, 0.05);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 10px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            transition: all 0.2s;
        }

        .person-item-compact:hover {
            background: rgba(118, 200, 147, 0.1);
            border-color: rgba(118, 200, 147, 0.3);
        }

        .person-info-compact {
            flex: 1;
            min-width: 0;
        }

        .person-name-compact {
            font-weight: 700;
            font-size: 14px;
            color: var(--text-primary);
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .person-meta-compact {
            font-size: 11px;
            color: var(--text-secondary);
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .person-meta-compact span {
            white-space: nowrap;
        }

        .person-delete-btn {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ff6b6b;
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 14px;
            min-width: 44px; /* Touch target mínimo para iPhone */
            min-height: 44px;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            /* Touch optimizado para iOS */
            -webkit-tap-highlight-color: rgba(239, 68, 68, 0.2);
            touch-action: manipulation;
        }

        .person-delete-btn:hover {
            background: rgba(239, 68, 68, 0.3);
            border-color: rgba(239, 68, 68, 0.5);
            transform: scale(1.05);
        }

        /* Compact Attendance List */
        .attendance-group-compact {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
            transition: all 0.2s;
        }

        .attendance-group-compact:hover {
            border-color: rgba(118, 200, 147, 0.3);
            box-shadow: 0 2px 8px rgba(118, 200, 147, 0.1);
        }

        .attendance-header-compact {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }

        .attendance-header-info {
            flex: 1;
            min-width: 0;
        }

        .attendance-title-compact {
            font-weight: 800;
            font-size: 14px;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .attendance-meta-compact {
            font-size: 11px;
            color: var(--text-secondary);
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .attendance-badge-compact {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            white-space: nowrap;
            background: rgba(118, 200, 147, 0.2);
            color: var(--accent);
        }

        .attendance-progress-compact {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 999px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .attendance-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success) 0%, var(--accent) 100%);
            transition: width 0.3s ease;
        }

        .attendance-list-compact {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .attendance-item-compact {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 6px 8px;
            border-radius: 8px;
            transition: background 0.2s;
            cursor: pointer;
        }

        .attendance-item-compact:hover {
            background: rgba(118, 200, 147, 0.1);
        }

        .attendance-checkbox-compact {
            width: 24px; /* Aumentado para mejor touch en iPhone */
            height: 24px;
            min-width: 24px;
            min-height: 24px;
            cursor: pointer;
            accent-color: var(--accent);
            flex-shrink: 0;
            /* Touch optimizado para iOS */
            -webkit-tap-highlight-color: rgba(118, 200, 147, 0.2);
            touch-action: manipulation;
        }

        .attendance-name-compact {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            flex: 1;
        }

        .attendance-name-compact.checked {
            color: var(--accent);
        }

        /* Compact Filter */
        .filter-compact {
            margin-bottom: 16px;
        }

        .filter-compact-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(118, 200, 147, 0.05);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 10px 12px;
        }

        .filter-compact-label {
            font-size: 12px;
            font-weight: 700;
            color: var(--text-secondary);
            white-space: nowrap;
            flex-shrink: 0;
        }

        .filter-compact-select {
            flex: 1;
            padding: 8px 12px;
            min-height: 44px; /* Touch target mínimo para iPhone */
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 16px; /* Mínimo 16px para evitar zoom en iOS */
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
            /* Prevenir zoom en iOS */
            appearance: none;
            -webkit-appearance: none;
            touch-action: manipulation;
        }

        .filter-compact-select:focus {
            outline: none;
            border-color: var(--accent);
            background: rgba(255, 255, 255, 0.15);
        }

        .filter-compact-select option {
            background: var(--bg-card);
            color: var(--text-primary);
        }

        /* Checkbox */
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            padding: 12px;
            min-height: 44px; /* Touch target mínimo para iPhone */
            border-radius: 12px;
            transition: background 0.2s;
            /* Touch optimizado para iOS */
            -webkit-tap-highlight-color: rgba(118, 200, 147, 0.2);
            touch-action: manipulation;
        }

        .checkbox-label:hover {
            background: rgba(118, 200, 147, 0.1);
        }

        .checkbox {
            width: 24px;
            height: 24px;
            cursor: pointer;
            accent-color: var(--accent);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state h3 {
            margin-bottom: 8px;
            font-size: 20px;
            color: var(--text-primary);
        }

        /* Bottom Action - DEPRECADO: Reemplazado por FAB */
        .bottom-action {
            display: none; /* Ocultamos los botones estáticos antiguos */
        }

        /* FAB (Floating Action Button) - Material Design */
        .fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--green-primary) 0%, var(--green-mountain) 100%);
            color: white;
            border: none;
            box-shadow: 0 8px 24px rgba(76, 175, 80, 0.5);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: 700;
            z-index: 1000;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            /* Safe area para iPhone */
            bottom: calc(24px + env(safe-area-inset-bottom));
            right: calc(24px + env(safe-area-inset-right));
            max-width: calc(100vw - 48px - env(safe-area-inset-right) - env(safe-area-inset-left));
        }

        .fab:hover {
            transform: scale(1.1) translateY(-4px);
            box-shadow: 0 12px 32px rgba(76, 175, 80, 0.6);
        }

        .fab:active {
            transform: scale(0.95);
        }

        /* El FAB se oculta/muestra dinámicamente con JavaScript según la pestaña activa */

        /* Modal: cubre toda la pantalla física (PWA/iPhone sin hueco inferior) */
        .modal {
            top: 0 !important;
            bottom: 0 !important;
            height: 100% !important;
            padding-bottom: 0 !important;
            display: none;
            position: fixed;
            left: 0;
            right: 0;
            z-index: 1000;
            align-items: flex-end;
            justify-content: center;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(4px);
        }

        /* Modales principales: por encima del header (9999) y nav (9990) */
        #modalNuevaReserva,
        #modalNuevoParticipante,
        #modalDetalleReserva,
        #modalNuevaRuta,
        #modalEditarReserva,
        #modalNuevoGasto,
        #modalAnadirRutaPasada,
        #modalAnadirAventuradoHistorial {
            z-index: 10002 !important;
        }
        
        #modalNuevaReserva.modal.active,
        #modalNuevoParticipante.modal.active,
        #modalDetalleReserva.modal.active,
        #modalNuevaRuta.modal.active,
        #modalEditarReserva.modal.active,
        #modalNuevoGasto.modal.active,
        #modalAnadirRutaPasada.modal.active,
        #modalAnadirAventuradoHistorial.modal.active {
            z-index: 10002 !important;
        }
        
        /* Modales de confirmación/alerta SIEMPRE delante de cualquier otro modal */
        #modalConfirm,
        #modalHistorialRecurrente {
            z-index: 10100 !important;
        }
        
        #modalConfirm.modal.active,
        #modalHistorialRecurrente.modal.active {
            z-index: 10100 !important;
        }
        
        .modal.active:not(#modalConfirm):not(#modalHistorialRecurrente):not(#modalNuevaReserva):not(#modalNuevoParticipante):not(#modalDetalleReserva):not(#modalNuevaRuta):not(#modalEditarReserva):not(#modalNuevoGasto):not(#modalAnadirRutaPasada):not(#modalAnadirAventuradoHistorial) {
            z-index: 1000;
        }

        .modal.active {
            display: flex !important;
        }

        .modal-content {
            position: relative;
            background: var(--bg-card);
            border-radius: 24px 24px 0 0;
            padding: 28px 20px;
            /* Safe area solo aquí (texto no se tapa en iPhone) */
            padding-bottom: calc(20px + env(safe-area-inset-bottom));
            padding-left: calc(20px + env(safe-area-inset-left));
            padding-right: calc(20px + env(safe-area-inset-right));
            margin-bottom: 0;
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
            max-width: 480px;
            width: 100%;
            max-height: calc(85vh - env(safe-area-inset-top) - env(safe-area-inset-bottom));
            overflow-y: auto;
            animation: slideUp 0.3s ease;
            border: 1px solid var(--border);
            -webkit-overflow-scrolling: touch;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }
            to {
                transform: translateY(0);
            }
        }

        .modal-header {
            font-size: 24px;
            font-weight: 800;
            margin-bottom: 24px;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 24px;
        }

        /* Payment Item */
        .payment-item {
            background: rgba(118, 200, 147, 0.1);
            padding: 16px;
            border-radius: 14px;
            margin-bottom: 12px;
            border: 1px solid var(--border);
        }

        .payment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .payment-amount {
            font-size: 18px;
            font-weight: 800;
            color: var(--accent);
        }

        .divider {
            height: 1px;
            background: var(--border);
            margin: 16px 0;
        }

        /* Personas en Reserva */
        .personas-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }

        .personas-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .personas-list {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 16px;
        }

        .persona-item {
            background: rgba(118, 200, 147, 0.1);
            padding: 12px;
            border-radius: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--border);
        }

        .persona-nombre {
            font-weight: 600;
            color: var(--text-primary);
        }

        .persona-remove {
            background: var(--danger);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 700;
            transition: all 0.3s;
        }

        .persona-remove:hover {
            background: #dc2626;
            transform: scale(1.05);
        }

        .personas-input-group {
            display: flex;
            gap: 8px;
        }

        .personas-input-group input {
            flex: 1;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .personas-input-group input::placeholder {
            color: var(--text-secondary);
        }

        .personas-input-group input:focus {
            outline: none;
            border-color: var(--accent);
            background: rgba(255, 255, 255, 0.15);
        }

        .personas-input-group button {
            padding: 12px 20px;
            background: linear-gradient(135deg, var(--green-primary) 0%, var(--green-mountain) 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .personas-input-group button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
        }

        .personas-input-group button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .personas-info {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 8px;
            text-align: center;
        }

        .personas-warning {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
            padding: 10px;
            border-radius: 10px;
            font-size: 13px;
            margin-top: 8px;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        /* AGREGAR al final del CSS existente: */

/* Check-in rápido para día de ruta */
.checkin-rapido {
    position: fixed;
    top: 72px;
    left: 0;
    right: 0;
    background: var(--bg-card);
    padding: 12px 16px;
    z-index: 98;
    border-bottom: 2px solid var(--border);
    display: none;
    box-shadow: 0 2px 8px var(--shadow);
    max-width: 480px;
    margin: 0 auto;
}

.checkin-rapido.active {
    display: block;
    animation: slideDown 0.3s ease;
}

@keyframes slideDown {
    from { transform: translateY(-20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.checkin-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.checkin-title {
    font-size: 14px;
    font-weight: 700;
    color: var(--accent);
    display: flex;
    align-items: center;
    gap: 8px;
}

.checkin-actions {
    display: flex;
    gap: 8px;
}

.checkin-contador {
    font-size: 13px;
    color: var(--text-secondary);
    text-align: center;
    padding: 4px 8px;
    background: rgba(118, 200, 147, 0.1);
    border-radius: 8px;
    border: 1px solid var(--border);
}

.checkin-total {
    font-weight: 700;
    color: var(--accent);
    margin-left: 4px;
}

        select.form-input {
            color: var(--text-primary);
            min-height: 44px; /* Touch target mínimo para iPhone */
            font-size: 16px; /* Mínimo 16px para evitar zoom en iOS */
            /* Prevenir zoom en iOS */
            appearance: none;
            -webkit-appearance: none;
            touch-action: manipulation;
        }

        select.form-input option {
            background: var(--bg-card);
            color: var(--text-primary);
        }
        
        /* Ocultar grupo de reserva cuando viene de una reserva */
        #participanteReservaGroup.hidden-from-reserva {
            display: none !important;
        }
        
        /* LOADER/SPINNER */
        .loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(4px);
        }

        .loader-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(118, 200, 147, 0.3);
            border-top-color: var(--green-mountain);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loader-text {
            margin-top: 16px;
            color: white;
            font-size: 16px;
            font-weight: 600;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* SKELETON SCREEN (carga inicial) */
        .skeleton {
            background: linear-gradient(90deg, rgba(255,255,255,0.06) 0%, rgba(255,255,255,0.12) 50%, rgba(255,255,255,0.06) 100%);
            background-size: 200% 100%;
            animation: skeleton-shimmer 1.2s ease-in-out infinite;
            border-radius: 12px;
        }
        @keyframes skeleton-shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        .loader-skeleton {
            max-width: 480px;
            margin: 0 auto;
            padding: 80px 16px 24px;
            width: 100%;
        }
        .loader-skeleton-header {
            height: 44px;
            margin-bottom: 24px;
            border-radius: 16px;
        }
        .loader-skeleton-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        .loader-skeleton-tab {
            width: 48px;
            height: 40px;
            border-radius: 12px;
        }
        .loader-skeleton-card {
            height: 120px;
            margin-bottom: 16px;
            border-radius: 20px;
        }
        .loader-skeleton-card.small {
            height: 80px;
        }
        .loader-spinner-wrap {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-top: 24px;
            gap: 12px;
        }
        .loader-spinner-wrap .loader-text {
            margin-top: 0;
        }

        /* PULL-TO-REFRESH */
        .pull-refresh-indicator {
            position: fixed;
            top: var(--app-header-total-height);
            left: 50%;
            transform: translate(-50%, -100%);
            z-index: 9998;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 12px 20px;
            background: rgba(26, 61, 71, 0.98);
            border-radius: 0 0 20px 20px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            border: 1px solid var(--border);
            border-top: none;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 600;
            transition: transform 0.2s ease-out;
            pointer-events: none;
        }
        .pull-refresh-indicator.visible {
            transform: translate(-50%, 0);
        }
        .pull-refresh-indicator.refreshing .pull-refresh-spinner {
            display: block;
        }
        .pull-refresh-indicator .pull-refresh-spinner {
            display: none;
            width: 22px;
            height: 22px;
            border: 3px solid rgba(118, 200, 147, 0.3);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        .pull-refresh-indicator .pull-refresh-icon {
            font-size: 18px;
        }
        .pull-refresh-indicator.refreshing .pull-refresh-icon {
            display: none;
        }

        /* TOAST NOTIFICATIONS - MOBILE OPTIMIZED (BOTTOM & DARK GLASS) */
        .toast-container {
            position: fixed;
            /* Ajuste para respetar la barra de gestos (safe area) en iOS */
            bottom: calc(20px + env(safe-area-inset-bottom));
            left: 50%;
            transform: translateX(-50%); /* Centrado horizontalmente */
            z-index: 99999;
            display: flex;
            flex-direction: column-reverse; /* Los nuevos aparecen abajo y empujan hacia arriba */
            gap: 10px;
            pointer-events: none; /* Permite clicks a través del contenedor vacío */
            width: fit-content; /* Compacto: solo lo que ocupa el contenido */
            max-width: 80%; /* No ocupar todo el ancho */
        }

        .toast {
            /* Fondo 'Dark Glass': Petróleo oscuro con transparencia */
            background: rgba(14, 47, 54, 0.95) !important;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 50px; /* Mini: pill shape */
            padding: 8px 16px; /* Mini: menos invasivo */
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5); /* Sombra profunda */
            backdrop-filter: blur(10px); /* Efecto vidrio */
            /* Animación de entrada: Sube desde abajo */
            animation: slideInUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: auto; /* El toast sí recibe clicks */
            display: flex;
            align-items: center;
            gap: 10px;
            width: fit-content; /* Evitar que estire al ancho del contenedor */
            max-width: 100%;
        }

        @keyframes slideInUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes slideOutDown {
            from {
                transform: translateY(0);
                opacity: 1;
            }
            to {
                transform: translateY(100%);
                opacity: 0;
            }
        }

        /* Bordes de Estado (Izquierda) - Colores Matatán */
        .toast.success {
            border-left: 5px solid #4CAF50; /* Verde Marca */
        }

        .toast.error {
            border-left: 5px solid #ef4444; /* Rojo Error */
        }

        .toast.warning {
            border-left: 5px solid #f59e0b; /* Ambar Alerta */
        }

        .toast.info {
            border-left: 5px solid #3b82f6; /* Azul Info */
        }

        .toast.fade-out {
            animation: slideOutDown 0.3s ease forwards;
        }

        .toast-icon {
            font-size: 18px;
            flex-shrink: 0;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        }

        .toast-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .toast-title {
            font-weight: 700;
            font-size: 13px;
            margin-bottom: 1px;
            color: #ffffff; /* Blanco puro para título */
            letter-spacing: 0.3px;
        }

        .toast-message {
            font-size: 12px;
            color: #cfd8d3; /* Gris perla suave para lectura cómoda */
            line-height: 1.3;
        }

        /* Nav tabs más compactos en iPhone - solo iconos, tamaño más grande */
        @media (max-width: 768px) {
            .nav-tabs {
                grid-template-columns: repeat(8, 1fr);
                gap: 0;
            }
            
            .nav-tab {
                padding: 12px 4px;
                font-size: 20px; /* Solo iconos, tamaño más grande */
                min-height: 44px;
            }
            
            /* Asegurar que los botones sean táctiles */
            .btn, .btn-small {
                min-height: 48px; /* Más grande en iPhone para mejor touch */
            }
            
            /* Inputs optimizados */
            .form-input, .search-box, .search-box-standalone {
                font-size: 16px; /* Mantener 16px para evitar zoom */
            }
            
            /* Modales ajustados */
            .modal-content {
                max-height: calc(85vh - env(safe-area-inset-bottom));
                border-radius: 24px 24px 0 0;
            }
        }

        /* Optimizaciones específicas para iOS */
        @supports (-webkit-touch-callout: none) {
            /* Solo se aplica en iOS */
            body {
                /* Prevenir pull-to-refresh accidental */
                overscroll-behavior-y: contain;
            }
            
            /* Mejorar scroll en iOS */
            .section {
                -webkit-overflow-scrolling: touch;
            }
            
            /* Inputs sin zoom */
            input[type="text"],
            input[type="number"],
            input[type="password"],
            input[type="date"],
            input[type="email"],
            textarea,
            select {
                font-size: 16px !important;
            }
            
            /* Mejorar touch en todos los elementos interactivos */
            button, a, [onclick], [role="button"] {
                min-height: 44px;
                min-width: 44px;
            }
            
            /* Checkboxes más grandes en iPhone */
            input[type="checkbox"] {
                width: 24px !important;
                height: 24px !important;
                min-width: 24px !important;
                min-height: 24px !important;
            }
        }
        
        /* Optimizaciones táctiles para iPhone - PERMITIR TECLADO EN INPUTS */
        @media (max-width: 768px) {
            /* CRÍTICO: Inputs deben ser completamente interactivos */
            input, 
            textarea, 
            select, 
            [contenteditable="true"],
            [contenteditable] {
                -webkit-user-select: auto !important;
                user-select: auto !important;
                -webkit-touch-callout: default !important;
                pointer-events: auto !important;
                -webkit-tap-highlight-color: rgba(118, 200, 147, 0.2) !important;
                /* Forzar que iOS reconozca estos como campos editables */
                cursor: text !important;
            }
            
            /* Solo prevenir selección en elementos de interfaz NO editables */
            body:not(input):not(textarea):not(select), 
            div:not([contenteditable]), 
            span:not([contenteditable]), 
            p, h1, h2, h3, h4, h5, h6,
            button, a,
            label:not([for]), 
            img, svg {
                -webkit-user-select: none;
                user-select: none;
                -webkit-touch-callout: none;
            }
        }

        @media (max-width: 768px) {
            .reserva-compact {
                flex-direction: column;
                gap: 8px;
            }

            .person-meta-compact {
                flex-wrap: wrap;
                font-size: 11px;
            }

            .modal-content {
                max-height: 90vh;
                overflow-y: auto;
            }
        }
    </style>
</head>
<body>
    <!-- Loader: skeleton screen + spinner mientras se verifica sesión y cargan datos -->
    <div id="loader" class="loader" style="display: flex; align-items: flex-start; padding-top: 0;">
        <div class="loader-skeleton">
            <div class="skeleton loader-skeleton-header"></div>
            <div class="loader-skeleton-tabs">
                <div class="skeleton loader-skeleton-tab"></div>
                <div class="skeleton loader-skeleton-tab"></div>
                <div class="skeleton loader-skeleton-tab"></div>
                <div class="skeleton loader-skeleton-tab"></div>
            </div>
            <div class="skeleton loader-skeleton-card"></div>
            <div class="skeleton loader-skeleton-card small"></div>
            <div class="skeleton loader-skeleton-card"></div>
            <div class="loader-spinner-wrap">
                <div class="loader-spinner" style="width: 40px; height: 40px; border-width: 3px;"></div>
                <div class="loader-text">Cargando datos...</div>
            </div>
        </div>
    </div>

    <!-- MODAL DE CONFIRMACIÓN GENÉRICO -->
    <div id="modalConfirm" class="modal" onclick="closeModalOnBackdrop(event, 'modalConfirm')" style="z-index: 10100 !important;">
        <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 400px; display: block !important; visibility: visible !important;">
            <div class="modal-header confirm-title">Confirmar acción</div>
            <div class="form-group" style="margin-bottom: 16px;">
                <p class="confirm-message" style="font-size: 14px; color: var(--text-primary); white-space: pre-line; line-height: 1.6;"></p>
            </div>
            <div class="btn-group" style="margin-top: 16px; gap: 8px; display: flex !important; visibility: visible !important;">
                <button class="btn btn-outline" style="flex: 1; display: block !important; visibility: visible !important;" onclick="if (confirmModalResolve) { confirmModalResolve(false); cerrarConfirmModal(); }">Cancelar</button>
                <button id="confirmModalBtn" class="btn btn-primary" style="flex: 1; display: block !important; visibility: visible !important;" onclick="if (confirmModalResolve) { confirmModalResolve(true); cerrarConfirmModal(); }">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- MODAL HISTORIAL CLIENTE RECURRENTE -->
    <div id="modalHistorialRecurrente" class="modal" onclick="closeModalOnBackdrop(event, 'modalHistorialRecurrente')">
        <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 400px;">
            <div class="modal-header confirm-title" id="modalHistorialRecurrenteTitulo">⭐ Cliente recurrente</div>
            <div class="form-group" style="margin-bottom: 16px;">
                <p id="modalHistorialRecurrenteCuerpo" style="font-size: 14px; color: var(--text-primary); white-space: pre-line; line-height: 1.6;"></p>
            </div>
            <div id="btnCompartirHistorialWrap" style="display: none; margin-top: 16px; text-align: center;">
                <button type="button" class="btn btn-primary" style="width: 100%; background: #25D366; border-color: #25D366; color: white;" onclick="compartirHistorialPorWhatsApp()">📱 Compartir por WhatsApp</button>
            </div>
            <div id="btnAnadirRutaPasadaWrap" style="margin-top: 12px; text-align: center;">
                <button type="button" class="btn btn-outline" style="width: 100%;" onclick="abrirModalAnadirRutaPasadaDesdeHistorial()">➕ Añadir ruta pasada</button>
            </div>
            <div style="margin-top: 16px; text-align: center;">
                <button type="button" class="btn btn-primary" style="width: 100%; max-width: 100%;" onclick="cerrarModalHistorialRecurrente()">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- MODAL: AÑADIR RUTA PASADA (a persona existente, sin reserva) -->
    <div id="modalAnadirRutaPasada" class="modal" onclick="closeModalOnBackdrop(event, 'modalAnadirRutaPasada')">
        <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 400px;">
            <div class="modal-header">➕ Añadir ruta pasada</div>
            <div class="form-group">
                <p id="modalAnadirRutaPasadaPersona" style="font-size: 14px; color: var(--text-secondary); margin-bottom: 12px;"></p>
            </div>
            <div class="form-group">
                <label class="form-label">Ruta asistida (pasada o archivada)</label>
                <select id="selectRutaPasada" class="form-input">
                    <option value="">-- Elegir ruta --</option>
                </select>
            </div>
            <div class="btn-group">
                <button type="button" class="btn btn-outline" onclick="closeModal('modalAnadirRutaPasada')">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="guardarRutaPasada()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- MODAL: AÑADIR AVENTURADO AL HISTORIAL (participante sin reserva, varias rutas) -->
    <div id="modalAnadirAventuradoHistorial" class="modal" onclick="closeModalOnBackdrop(event, 'modalAnadirAventuradoHistorial')">
        <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 420px;">
            <div class="modal-header">➕ Añadir aventurado al historial</div>
            <div class="form-group">
                <label class="form-label">Nombre completo</label>
                <input type="text" id="nuevoAventuradoNombre" class="form-input" placeholder="Ej: María García">
            </div>
            <div class="form-group">
                <label class="form-label">Rutas asistidas (pasadas/archivadas) — marcar las que asistió</label>
                <div id="listaRutasPasadasCheckboxes" style="max-height: 220px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; padding: 12px; background: rgba(0,0,0,0.2);"></div>
            </div>
            <div class="btn-group">
                <button type="button" class="btn btn-outline" onclick="closeModal('modalAnadirAventuradoHistorial')">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="guardarAventuradoHistorial()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Indicador pull-to-refresh (fixed, se muestra al tirar hacia abajo) -->
    <div id="pullRefreshIndicator" class="pull-refresh-indicator" aria-hidden="true">
        <span class="pull-refresh-icon">↻</span>
        <span class="pull-refresh-label">Suelta para actualizar</span>
        <div class="pull-refresh-spinner"></div>
    </div>

    <!-- APP -->
    <div id="app" class="app">
        <!-- TOAST NOTIFICATIONS -->
        <div id="toastContainer" class="toast-container"></div>
        
        <div class="app-header">
            <div class="logo-text">
                <img src="../logo.png" alt="SomosAventura2" class="app-header-logo">
                <h1>Gestión de Rutas</h1>
            </div>
            <button class="logout-btn" onclick="logout()">Salir</button>
        </div>

        <!-- Nav tabs -->
        <div class="nav-tabs">
    <button class="nav-tab active" onclick="showTab('rutas')">
        📍 <span class="text">Rutas</span>
    </button>
    <button class="nav-tab" onclick="showTab('reservas')">
        🎫 <span class="text">Reservas</span>
    </button>
    <button class="nav-tab" onclick="showTab('participantes')">
        👥 <span class="text">Personas</span>
    </button>
    <button class="nav-tab" onclick="showTab('asistencia')">
        📋 <span class="text">Asistencia</span>
    </button>
    <button class="nav-tab" onclick="showTab('gastos')">
        💸 <span class="text">Gastos</span>
    </button>
    <button class="nav-tab" onclick="showTab('ranking')">
        🏆 <span class="text">Ranking</span>
    </button>
    <button class="nav-tab" onclick="showTab('abonados')">
        💰 <span class="text">Abonados</span>
    </button>
    <button class="nav-tab" onclick="showTab('historial')">
        📚 <span class="text">Historial</span>
    </button>
        </div>

        <!-- Check-in rápido -->
        <div id="checkinRapido" class="checkin-rapido">
    <div class="checkin-header">
        <div class="checkin-title">
            📋 Check-in rápido
            <span class="checkin-contador" id="checkinContador">0/0</span>
        </div>
        <div class="checkin-actions">
            <button class="btn btn-success btn-small" onclick="marcarTodosPresentes()" style="padding: 6px 12px; font-size: 12px;">
                ✅ Todos
            </button>
            <button class="btn btn-outline btn-small" onclick="toggleCheckinRapido(false)" style="padding: 6px 12px; font-size: 12px;">
                ✖️
            </button>
        </div>
    </div>
    <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
        Selecciona un líder para comenzar el check-in
    </div>
</div>

        <!-- RUTAS -->
        <div id="rutas" class="section active">
            <div class="search-filter-container">
                <input type="text" class="search-box" id="searchRutas" placeholder="Buscar rutas..." oninput="debouncedRenderRutas()">
            </div>
            <div id="listaRutas"></div>
        </div>

        <!-- RESERVAS -->
        <div id="reservas" class="section">
            <div class="search-filter-container">
                <input type="text" class="search-box" id="searchReservas" placeholder="Buscar reservas..." oninput="debouncedRenderReservas()">
                <div class="search-filter-separator"></div>
                <div class="search-filter-wrapper">
                    <select id="filtroRutaReservas" class="search-filter-select" onchange="renderReservas(); ajustarSelectFiltro(this);">
                        <option value="">Todas las rutas</option>
                    </select>
                </div>
            </div>
            <div id="listaReservas"></div>
        </div>

        <!-- PARTICIPANTES -->
        <div id="participantes" class="section">
            <div class="search-filter-container">
                <input type="text" class="search-box" id="searchParticipantes" placeholder="Buscar personas..." oninput="debouncedRenderParticipantes()">
                <div class="search-filter-separator"></div>
                <div class="search-filter-wrapper">
                    <select id="filtroRutaParticipantes" class="search-filter-select" onchange="renderParticipantes(); ajustarSelectFiltro(this);">
                        <option value="">Todas las rutas</option>
                    </select>
                </div>
            </div>
            <div id="listaParticipantes"></div>
        </div>

        <!-- ASISTENCIA -->
        <div id="asistencia" class="section">
            <div class="search-filter-container">
                <input type="text" class="search-box" id="searchAsistencia" placeholder="Buscar por líder..." oninput="debouncedRenderAsistencia()">
                <div class="search-filter-separator"></div>
                <div class="search-filter-wrapper">
                    <select id="filtroLiderAsistencia" class="search-filter-select" onchange="renderAsistencia(); ajustarSelectFiltro(this);">
                        <option value="">Todos los líderes</option>
                    </select>
                </div>
                <div class="search-filter-separator"></div>
                <div class="search-filter-wrapper">
                    <select id="filtroRutaAsistencia" class="search-filter-select" onchange="renderAsistencia(); ajustarSelectFiltro(this);">
                        <option value="">Todas las rutas</option>
                    </select>
                </div>
            </div>
            <div id="listaAsistencia"></div>
        </div>

        <!-- GASTOS -->
        <div id="gastos" class="section">
            <div class="search-filter-container">
                <input type="text" class="search-box" id="searchGastos" placeholder="Buscar gastos..." oninput="debouncedRenderGastos()">
                <div class="search-filter-separator"></div>
                <div class="search-filter-wrapper">
                    <select id="filtroRutaGastos" class="search-filter-select" onchange="renderGastos(); ajustarSelectFiltro(this);">
                        <option value="">Todas las rutas</option>
                    </select>
                </div>
            </div>
            <div id="listaGastos"></div>
        </div>

        <!-- BOTÓN FLOTANTE (FAB) CONTEXTUAL -->
        <button class="fab" id="fab-main" onclick="handleFabClick()">
            +
        </button>

        <!-- HISTORIAL -->
        <div id="historial" class="section">
            <div class="search-filter-container">
                <input type="text" class="search-box" id="searchHistorial" placeholder="Buscar en historial..." oninput="debouncedRenderHistorial()">
            </div>
            <div id="listaHistorial"></div>
        </div>

        <!-- RANKING -->
        <div id="ranking" class="section">
            <div class="search-filter-container">
                <input type="text" class="search-box" id="searchRanking" placeholder="Buscar aventurado..." oninput="debouncedRenderRanking()">
                <div class="search-filter-separator"></div>
                <div class="search-filter-wrapper">
                    <select id="filtroRangoRanking" class="search-filter-select" onchange="renderRanking(); ajustarSelectFiltro(this);">
                        <option value="">Todos los rangos</option>
                        <option value="Diamante">✨ Diamante</option>
                        <option value="Platino">💎 Platino</option>
                        <option value="Oro">🥇 Oro</option>
                        <option value="Plata">🥈 Plata</option>
                        <option value="Bronce">🥉 Bronce</option>
                        <option value="Novato">🌱 Novato</option>
                    </select>
                </div>
            </div>
            <div id="estadisticasGlobales" class="card" style="margin-bottom: 16px;">
                <div class="card-title">📈 Estadísticas Globales</div>
                <div id="statsGlobalesContent" style="padding: 16px 0;">Cargando...</div>
            </div>
            <div id="top10Aventurados" class="card" style="margin-bottom: 16px;">
                <div class="card-title">🏆 TOP 10 AVENTURADOS</div>
                <div id="top10Content" style="padding: 16px 0;">Cargando...</div>
            </div>
            <div class="card">
                <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
                    <div class="card-title">📊 Ranking Completo</div>
                    <button type="button" class="btn btn-success btn-small" onclick="abrirModalAnadirAventuradoHistorial()">➕ Añadir aventurado al historial</button>
                </div>
                <div id="listaRanking" style="padding: 16px 0;">Cargando...</div>
            </div>
        </div>

        <!-- ABONADOS -->
        <div id="abonados" class="section">
            <div class="search-filter-container">
                <input type="text" class="search-box" id="searchAbonados" placeholder="Buscar líder..." oninput="debouncedRenderAbonados()">
            </div>
            <div class="card" style="margin-bottom: 16px;">
                <div class="card-title">💰 Resumen de Abonados</div>
                <div id="resumenAbonados" style="padding: 16px 0;">
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                        <div class="stat"><span class="stat-value" id="totalAbonados">0</span><span class="stat-label">Total abonados</span></div>
                        <div class="stat"><span class="stat-value" id="totalSaldoEuros">€0</span><span class="stat-label">Saldo total</span></div>
                        <div class="stat"><span class="stat-value" id="promedioSaldo">€0</span><span class="stat-label">Promedio</span></div>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
                    <div class="card-title">👥 Abonados Activos</div>
                    <button type="button" class="btn btn-success btn-small" onclick="abrirModalNuevoAbono()">+ Nuevo Abono</button>
                </div>
                <div id="listaAbonados" style="padding: 16px 0;">Cargando abonados...</div>
            </div>
        </div>
    </div>

    <!-- MODAL: NUEVA RUTA -->
    <div id="modalNuevaRuta" class="modal" onclick="closeModalOnBackdrop(event, 'modalNuevaRuta')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">📍 Nueva Ruta</div>
            <div class="form-group">
                <label class="form-label">Nombre de la Ruta</label>
                <input type="text" id="rutaNombre" class="form-input" placeholder="Ej: Cascada Mirandina">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Fecha</label>
                    <input type="date" id="rutaFecha" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Cupos</label>
                    <input type="number" id="rutaCupos" class="form-input" placeholder="20" min="0" step="1" inputmode="numeric" onkeydown="if(['e','E','+','-'].includes(event.key)) event.preventDefault();">
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Precio en Euros (€)</label>
                <input type="number" id="rutaPrecioEuros" class="form-input" placeholder="10.00" step="0.01" min="0" inputmode="decimal" onkeydown="if(['e','E','+','-'].includes(event.key)) event.preventDefault();">
            </div>
            <div class="form-group">
                <label class="form-label">Flyer / Foto de Portada</label>
                <input type="file" id="rutaFoto" class="form-input" accept="image/*">
            </div>
            <div class="btn-group">
                <button class="btn btn-outline" onclick="closeModal('modalNuevaRuta')">Cancelar</button>
                <button class="btn btn-primary" onclick="agregarRuta()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- MODAL: NUEVA RESERVA -->
    <div id="modalNuevaReserva" class="modal" onclick="closeModalOnBackdrop(event, 'modalNuevaReserva')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">👥 Nueva Reserva</div>
            <div class="form-group">
                <label class="form-label">Nombre del Líder</label>
                <input type="text" id="reservaLider" class="form-input" placeholder="Ej: Valeria">
            </div>
            <div class="form-group">
                <label class="form-label">Ruta</label>
                <select id="reservaRuta" class="form-input" onchange="actualizarPersonasEnReserva()">
                    <option value="">Selecciona una ruta</option>
                </select>
            </div>
            <div id="infoPrecioRuta" style="display: none; background: rgba(118, 200, 147, 0.1); padding: 14px; border-radius: 14px; margin-bottom: 16px; border: 1px solid var(--border);">
                <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">Precio Referencial</div>
                <div style="font-size: 20px; font-weight: 800; color: var(--accent);" id="precioReferencialRuta"></div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Cupos Reservados</label>
                    <input type="number" id="reservaCantidad" class="form-input" placeholder="5" min="0" step="1" inputmode="numeric" onkeydown="if(['e','E','+','-'].includes(event.key)) event.preventDefault();" onchange="actualizarPersonasEnReserva()">
                </div>
                <div class="form-group">
                    <label class="form-label">Monto Inicial</label>
                    <input type="number" id="reservaMontoPagado" class="form-input" placeholder="17500" step="0.01" min="0" inputmode="decimal" onkeydown="if(['e','E','+','-'].includes(event.key)) event.preventDefault();">
                </div>
            </div>
            <div class="form-group" id="reservaCuposMontoInicialGroup">
                <label class="form-label">Cupos pagados con este monto</label>
                <input type="number" id="reservaCuposMontoInicial" class="form-input" placeholder="Ej: 2" min="0" step="1" value="1">
                <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">Solo aplica cuando el pago es en Bs</div>
            </div>
            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="reservaEnDolares" style="width: 18px; height: 18px; cursor: pointer;" onchange="toggleReferenciaNuevaReserva()">
                    <span>💵 Pagar en dólares efectivo</span>
                </label>
            </div>
            <div id="grupoReferenciaPagoNuevaReserva" class="form-group">
                <label class="form-label">📎 Referencia del Pago Inicial (Opcional)</label>
                <input type="text" id="reservaReferenciaPago" class="form-input" placeholder="Ej: 001, 12345" inputmode="numeric" pattern="[0-9]*" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
            </div>
            <div id="infoSaldoLiderNuevaReserva" style="display: none; background: rgba(6, 182, 212, 0.1); padding: 14px; border-radius: 14px; margin-bottom: 16px; border: 1px solid rgba(6, 182, 212, 0.3);">
                <div style="font-size: 13px; font-weight: 700; color: #06b6d4; margin-bottom: 8px;">💰 Líder con saldo</div>
                <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 6px;">Saldo disponible: <strong id="saldoLiderNuevaReserva">€0.00</strong></div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label" style="font-size: 12px;">Cupos a pagar con saldo</label>
                    <input type="number" id="reservaCuposConSaldo" class="form-input" placeholder="0" min="0" step="1" value="0" style="max-width: 120px;">
                    <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">Máx: <span id="reservaCuposConSaldoMax">0</span> cupos</div>
                </div>
            </div>
            
            <!-- SECCIÓN DE PERSONAS -->
            <div class="personas-section">
                <div class="personas-header">
                    <label class="form-label" style="margin: 0;">👥 Agregar Personas</label>
                </div>
                <div class="personas-input-group">
                    <input type="text" id="personaNombreInput" class="form-input" placeholder="Ej: Juan Carlos Pérez (nombre completo)" 
                           onkeypress="if(event.key==='Enter') { event.preventDefault(); agregarPersonaTemporal(); }"
                           oninput="actualizarPersonasEnReserva()">
                    <button type="button" id="btnAgregarPersona" onclick="agregarPersonaTemporal()">+ Agregar</button>
                </div>
                <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px; margin-bottom: 8px;">
                    💡 Presiona Enter para agregar rápidamente
                </div>
                <div id="personasTemporalesList" class="personas-list"></div>
                <div id="personasInfo" class="personas-info"></div>
            </div>
            
            <div class="btn-group">
                <button class="btn btn-outline" onclick="closeModal('modalNuevaReserva')">Cancelar</button>
                <button class="btn btn-primary" onclick="agregarReserva()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- MODAL: EDITAR RESERVA -->
    <div id="modalEditarReserva" class="modal" onclick="closeModalOnBackdrop(event, 'modalEditarReserva')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">✏️ Editar Reserva</div>
            <input type="hidden" id="editarReservaId">
            <div class="form-group">
                <label class="form-label">Nombre del Líder</label>
                <input type="text" id="editarReservaLider" class="form-input" placeholder="Ej: Valeria">
            </div>
            <div class="form-group">
                <label class="form-label">Ruta</label>
                <input type="text" id="editarReservaRutaNombre" class="form-input" disabled>
            </div>
            <div class="form-group">
                <label class="form-label">Cantidad de Cupos</label>
                <input type="number" id="editarReservaCantidad" class="form-input" placeholder="5" min="0" step="1" inputmode="numeric" onkeydown="if(['e','E','+','-'].includes(event.key)) event.preventDefault();">
            </div>
            <div class="btn-group">
                <button class="btn btn-outline" onclick="closeModal('modalEditarReserva')">Cancelar</button>
                <button class="btn btn-primary" onclick="guardarEdicionReserva()">Guardar Cambios</button>
            </div>
        </div>
    </div>

    <!-- MODAL: NUEVO PARTICIPANTE (asociado a una reserva, sin campo de líder) -->
    <div id="modalNuevoParticipante" class="modal" onclick="closeModalOnBackdrop(event, 'modalNuevoParticipante')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">✅ Nueva Persona en Reserva</div>
            <div class="form-group">
                <label class="form-label">Nombre Completo *</label>
                <input type="text" id="participanteNombreCompleto" class="form-input" 
                       placeholder="Ej: Juan Carlos Pérez (o Juan Pérez)" 
                       required
                       onkeypress="if(event.key==='Enter') { event.preventDefault(); agregarParticipante(); }">
                <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">
                    💡 Escribe el nombre completo. Si hay 3 palabras, la del medio será el segundo nombre.
                </div>
            </div>
            <div style="margin-top: 16px; padding: 12px; background: rgba(118, 200, 147, 0.05); border-radius: 8px; border: 1px dashed var(--border);">
                <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px; font-weight: 600;">💰 Pago Opcional</div>
                <div class="form-group" style="margin-bottom: 12px;">
                    <label class="form-label" style="font-size: 12px;">Monto</label>
                    <input type="number" id="participanteMonto" class="form-input" placeholder="0.00" step="0.01" min="0" inputmode="decimal" onkeydown="if(['e','E','+','-'].includes(event.key)) event.preventDefault();">
                </div>
                <div class="form-group" style="margin-bottom: 12px;">
                    <label class="form-label" style="font-size: 12px;">Cupos pagados con este monto</label>
                    <input type="number" id="participanteCuposPagados" class="form-input" placeholder="1" min="0" step="1" value="1" title="Cantidad de cupos que cubre este pago (se refleja en el resumen de la reserva)">
                </div>
                <div class="form-group" style="margin-bottom: 12px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 12px;">
                        <input type="checkbox" id="participanteEnDolares" style="width: 18px; height: 18px; cursor: pointer;">
                        <span>💵 Pagar en dólares efectivo</span>
                    </label>
                </div>
                <div class="form-group">
                    <label class="form-label" style="font-size: 12px;">Referencia de Pago</label>
                    <input type="text" id="participanteReferencia" class="form-input" placeholder="Ej: 12345" inputmode="numeric" pattern="[0-9]*" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                </div>
            </div>
            <div class="btn-group">
                <button class="btn btn-outline" onclick="closeModal('modalNuevoParticipante')">Cancelar</button>
                <button class="btn btn-primary" onclick="agregarParticipante()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- MODAL: DETALLE RESERVA / PAGOS -->
    <div id="modalDetalleReserva" class="modal" onclick="closeModalOnBackdrop(event, 'modalDetalleReserva')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">💰 Gestión de Pagos</div>
            <div id="detalleReservaContent"></div>
        </div>
    </div>

    <!-- MODAL: CARGAR SALDO ABONADO -->
    <div id="modalCargaAbonados" class="modal" onclick="closeModalOnBackdrop(event, 'modalCargaAbonados')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">💰 Cargar Saldo a Líder</div>
            <div class="form-group">
                <label class="form-label">Nombre del líder</label>
                <input type="text" id="inputLiderAbono" class="form-input" placeholder="Nombre del líder">
            </div>
            <div class="form-group">
                <label class="form-label">Saldo en €</label>
                <input type="number" id="inputSaldoEuros" class="form-input" placeholder="0.00" step="0.01" min="0">
            </div>
            <div class="form-group">
                <label class="form-label">Notas (opcional)</label>
                <textarea id="inputNotasAbono" class="form-input" placeholder="Notas" rows="2"></textarea>
            </div>
            <button type="button" class="btn btn-success" onclick="cargarAbonadoManualDesdeModal()">Cargar Saldo</button>
            <button type="button" class="btn btn-outline" style="margin-top: 12px;" onclick="closeModal('modalCargaAbonados')">Cerrar</button>
        </div>
    </div>

    <!-- MODAL: NUEVO GASTO -->
    <div id="modalNuevoGasto" class="modal" onclick="closeModalOnBackdrop(event, 'modalNuevoGasto')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">💰 Nuevo Gasto</div>
            <div class="form-group">
                <label class="form-label">Concepto</label>
                <input type="text" id="gastoConcepto" class="form-input" placeholder="Ej: Combustible, Alimentos, Guía">
            </div>
            <div class="form-group">
                <label class="form-label">Ruta</label>
                <select id="gastoRuta" class="form-input">
                    <option value="">Selecciona una ruta</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Monto (Bs)</label>
                <input type="number" id="gastoMonto" class="form-input" placeholder="0.00" step="0.01" min="0" inputmode="decimal" onkeydown="if(['e','E','+','-'].includes(event.key)) event.preventDefault();">
            </div>
            <div class="btn-group">
                <button class="btn btn-outline" onclick="closeModal('modalNuevoGasto')">Cancelar</button>
                <button class="btn btn-primary" onclick="agregarGasto()">Guardar</button>
            </div>
        </div>
    </div>
    <script>
// --- 1. CONFIGURACIÓN ---
const SUPABASE_URL = 'https://dgubxitmqegounjyeciw.supabase.co';
const SUPABASE_ANON_KEY = 'sb_publishable_EY4EoqiHn7om0Qf-HYpJZQ_HwDJXlan';

let db = null;
let usuariosCache = [];
let liderActualParaNuevoParticipante = null;
let rutaActualParaNuevoParticipante = null;

// Al cargar: verificar sesión con Supabase; si no hay sesión → redirigir a login.html
document.addEventListener('DOMContentLoaded', async () => {
    const appEl = document.getElementById('app');
    const loaderEl = document.getElementById('loader');

    try {
        const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        const { data } = await client.auth.getSession();

        if (!data?.session) {
            window.location.href = 'login.html';
            return;
        }

        if (loaderEl) loaderEl.style.display = 'none';
        conectarBaseDeDatos();
        await loadData();
        updateSelects();
        renderAll();
        if (appEl) appEl.classList.add('active');
    } catch (error) {
        console.error('Error verificando sesión:', error);
        window.location.href = 'login.html';
    }
});

/** Inicializa el cliente Supabase y carga la lista de usuarios. */
function conectarBaseDeDatos() {
    // Verificamos si la librería de Supabase cargó en el navegador
    if (typeof supabase !== 'undefined') {
        try {
            // Usamos la librería para crear el cliente en nuestra variable 'db'
            db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            loadUsuarios();
        } catch (error) {
            console.error('❌ Error en la configuración:', error);
        }
    } else {
        setTimeout(conectarBaseDeDatos, 500);
    }
}

/** Carga usuarios desde Supabase y los guarda en usuariosCache. */
async function loadUsuarios() {
    try {
        if (!db) return;
        const { data: users, error } = await db.from('usuarios').select('*');
        if (error) throw error;
        usuariosCache = users || [];
    } catch (err) {
        console.error("Error cargando usuarios", err);
        usuariosCache = [];
    }
}

    // --- DATOS DE LA APLICACIÓN ---
    let data = {
        rutas: [],
        reservas: [],
        participantes: [],
        gastos: []
    };

    // --- ESTADO DE CARDS EXPANDIDOS (para mantener estado al actualizar) ---
    let cardsAsistenciaExpandidos = new Set();
    /** IDs de participantes modificados por nosotros (para no mostrar toast en Realtime) */
    let misAccionesRecientes = new Set();

    let personasTemporales = [];
    let realtimeChannel = null;

        // =============================================
        // 4.5. UTILIDADES - TOAST Y LOADER
        // =============================================
        
        // Mostrar/Ocultar Loader (skeleton solo en carga inicial; después solo spinner)
        function showLoader(text = 'Cargando datos...') {
            const loader = document.getElementById('loader');
            if (!loader) return;
            if (loader.querySelector('.loader-skeleton')) {
                loader.innerHTML = '<div class="loader-spinner"></div><div class="loader-text">' + (text || 'Cargando...') + '</div>';
                loader.style.alignItems = 'center';
                loader.style.paddingTop = '';
            } else {
                const loaderText = loader.querySelector('.loader-text');
                if (loaderText) loaderText.textContent = text;
            }
            loader.style.display = 'flex';
        }

        function hideLoader() {
            const loader = document.getElementById('loader');
            if (loader) loader.style.display = 'none';
        }

        /** Debounce: ejecuta fn tras ms ms sin nuevas llamadas (para búsquedas). */
        function debounce(fn, ms) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => fn.apply(this, args), ms);
            };
        }

        /** Escape para contenido HTML (evita XSS). */
        function escapeHtml(str) {
            if (str == null) return '';
            const s = String(str);
            return s
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;');
        }

        /** Escape para valores en atributos HTML (onclick, title, etc.). Incluye comillas para no romper el atributo. */
        function escapeAttr(str) {
            if (str == null) return '';
            const s = String(str);
            return s
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        // Toast Notifications
        function showToast(message, type = 'info', title = null) {
            const container = document.getElementById('toastContainer');
            if (!container) return;

            // 🔒 ANTI-SPAM: Verificar si ya existe un toast con el mismo mensaje
            const existingToasts = container.querySelectorAll('.toast:not(.fade-out) .toast-message');
            for (let toastMessage of existingToasts) {
                if (toastMessage.textContent.trim() === message.trim()) {
                    // Ya existe un toast con este mensaje, no crear duplicado
                    return;
                }
            }

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            const icons = {
                success: '✅',
                error: '❌',
                warning: '⚠️',
                info: 'ℹ️'
            };

            const titlesDefault = {
                success: 'Éxito',
                error: 'Error',
                warning: 'Advertencia',
                info: 'Información'
            };

            toast.innerHTML = `
                <div class="toast-icon">${icons[type] || icons.info}</div>
                <div class="toast-content">
                    <div class="toast-title">${title || titlesDefault[type] || 'Información'}</div>
                    <div class="toast-message">${message}</div>
                </div>
            `;

            container.appendChild(toast);

            // Auto-remover después de 1.2 segundos
            setTimeout(() => {
                toast.classList.add('fade-out');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 1200);
        }

        // =============================================
        // 5. LOGOUT
        // =============================================
        window.logout = async function() {
            const ok = await openConfirmModal({
                titulo: 'Cerrar sesión',
                mensaje: '¿Estás seguro de que deseas cerrar sesión?',
                tipo: 'pregunta',
                confirmarLabel: 'Cerrar sesión'
            });
            if (!ok) return;
            try {
                const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                await client.auth.signOut();
            } catch (error) {
                console.error('Error al cerrar sesión en Supabase:', error);
            }
            location.reload();
        };

        // =============================================
        // 7. CONFIRMACIONES MEJORADAS
        // =============================================
        // Modal de confirmación (reemplazo visual de confirm())
        let confirmModalResolve = null;

        function openConfirmModal({ titulo, mensaje, tipo = 'pregunta', confirmarLabel }) {
            return new Promise(resolve => {
                confirmModalResolve = resolve;

                const modal = document.getElementById('modalConfirm');
                if (!modal) {
                    console.error('Modal de confirmación no encontrado');
                    resolve(false);
                    return;
                }

                // NO cerrar otros modales - mantenerlos abiertos pero detrás
                // El z-index se encargará de que el modal de confirmación esté por encima
                
                const titleEl = modal.querySelector('.confirm-title');
                const messageEl = modal.querySelector('.confirm-message');
                const confirmBtn = document.getElementById('confirmModalBtn');
                
                if (titleEl) titleEl.textContent = titulo || 'Confirmar acción';
                if (messageEl) messageEl.textContent = mensaje;
                if (confirmBtn) confirmBtn.textContent = confirmarLabel || 'Confirmar';

                // Estilos por tipo (solo clases, colores manejados en CSS inline)
                modal.setAttribute('data-tipo', tipo);

                // Asegurar que el modal esté visible y por encima de cualquier otro modal
                modal.style.display = 'flex';
                modal.style.zIndex = '10100';
                modal.style.visibility = 'visible';
                modal.style.opacity = '1';
                modal.style.pointerEvents = 'auto';
                modal.classList.add('active');
                
                // Forzar que el contenido también sea visible
                const modalContent = modal.querySelector('.modal-content');
                if (modalContent) {
                    modalContent.style.display = 'block';
                    modalContent.style.visibility = 'visible';
                    modalContent.style.pointerEvents = 'auto';
                }
                
                // Forzar que los botones sean visibles
                const buttons = modal.querySelectorAll('.btn');
                buttons.forEach(btn => {
                    btn.style.display = 'block';
                    btn.style.visibility = 'visible';
                    btn.style.pointerEvents = 'auto';
                });
            });
        }

        function cerrarConfirmModal() {
            const modal = document.getElementById('modalConfirm');
            if (modal) {
                modal.classList.remove('active');
                modal.style.display = 'none';
                modal.style.zIndex = '';
                modal.style.visibility = '';
                modal.style.opacity = '';
            }
            confirmModalResolve = null;
        }

        function confirmarAccion(mensaje, tipo = 'pregunta') {
            const titulos = {
                'peligro': 'Confirmar acción',
                'pregunta': '¿Estás seguro?',
                'eliminar': 'Confirmar eliminación',
                'archivar': 'Archivar ruta'
            };
            const titulo = titulos[tipo] || titulos['pregunta'];
            return openConfirmModal({ titulo, mensaje, tipo });
        }

        // =============================================
        // 8. CARGAR DATOS DESDE SUPABASE (OPTIMIZADO)
        // =============================================
        
        // Función auxiliar para retry con exponential backoff
        async function retryWithBackoff(fn, maxRetries = 3, baseDelay = 1000) {
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    return await fn();
                } catch (error) {
                    if (attempt === maxRetries - 1) throw error;
                    const delay = baseDelay * Math.pow(2, attempt);
                    console.warn(`⚠️ Intento ${attempt + 1} fallido, reintentando en ${delay}ms...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        /**
         * Carga todos los datos desde Supabase y los normaliza
         * Muestra loader y toast de confirmación
         * @returns {Promise<void>}
         */
        async function loadData() {
            showLoader('Cargando datos...');
            
            try {
                if (!db) {
                    throw new Error('Supabase no está inicializado');
                }
                
                // Cargar todas las tablas en paralelo para mejor performance
                const [rutasResult, reservasResult, participantesResult, gastosResult] = await Promise.all([
                    retryWithBackoff(() => db
                        .from('rutas')
                        .select('*')
                        .order('fecha', { ascending: true })),
                    retryWithBackoff(() => db
                        .from('reservas')
                        .select('*')),
                    retryWithBackoff(() => db
                        .from('participantes')
                        .select('*')),
                    retryWithBackoff(() => db
                        .from('gastos')
                        .select('*')
                        .order('fecha', { ascending: false }))
                ]);

                // Normalizar y asignar datos (reutiliza función centralizada)
                const datosNormalizados = normalizarDatos({ rutasResult, reservasResult, participantesResult, gastosResult });
                data.rutas = datosNormalizados.rutas;
                data.reservas = datosNormalizados.reservas;
                data.participantes = datosNormalizados.participantes;
                data.gastos = datosNormalizados.gastos;

                // Inicializar sincronización en tiempo real (no crítico si falla)
                try {
                    initRealtimeSync();
                } catch (realtimeError) {
                    console.warn('⚠️ Error inicializando Realtime (no crítico):', realtimeError);
                }
                
                hideLoader();

            } catch (error) {
                console.error('❌ Error cargando datos:', error);
                hideLoader();
                
                if (!db) {
                    showToast('Base de datos no inicializada. Reintentando...', 'warning');
                    setTimeout(async () => {
                        if (db) {
                            await loadData();
                        }
                    }, 1000);
                } else {
                    showToast('Error al cargar los datos. Verifica la conexión.', 'error', 'Error de Conexión');
                }
            }
        }

        // =============================================
        // 8b. MIGRACIÓN Y CÁLCULO DE PAGOS (cuposPagados)
        // =============================================
        /** Migra pagos antiguos sin cuposPagados: asigna 0 para $ o calcula aproximado para Bs */
        function migrarPagosAntiguos(reserva, ruta) {
            if (!reserva.pagos || !Array.isArray(reserva.pagos)) return reserva;
            const precioCupo = ruta && (ruta.precioEuros != null) ? ruta.precioEuros : 10;
            reserva.pagos = reserva.pagos.map(pago => {
                if (pago.cuposPagados !== undefined) return pago;
                if (pago.enDolares) return { ...pago, cuposPagados: 0 };
                const tasaPromedio = 400;
                const eurosAprox = (pago.monto || 0) / tasaPromedio;
                const cuposAprox = Math.floor(eurosAprox / precioCupo);
                return { ...pago, cuposPagados: Math.max(1, cuposAprox), _cuposCalculado: true };
            });
            return reserva;
        }

        function calcularCuposPagados(reserva) {
            if (!reserva.pagos || !Array.isArray(reserva.pagos)) return 0;
            return reserva.pagos.reduce((sum, p) => sum + (p.cuposPagados || 0), 0);
        }

        function calcularEurosRecibidos(reserva, ruta) {
            const cuposPagados = calcularCuposPagados(reserva);
            const precioCupoEuros = ruta ? (ruta.precioEuros || 0) : 0;
            return cuposPagados * precioCupoEuros;
        }

        function calcularTotalesPorMoneda(reserva) {
            if (!reserva.pagos || !Array.isArray(reserva.pagos)) {
                return { totalBs: 0, totalDolares: 0, cuposPagados: 0 };
            }
            return reserva.pagos.reduce((totales, pago) => {
                totales.cuposPagados += pago.cuposPagados || 0;
                if (pago.enDolares) {
                    totales.totalDolares += pago.monto || 0;
                } else {
                    totales.totalBs += pago.monto || 0;
                }
                return totales;
            }, { totalBs: 0, totalDolares: 0, cuposPagados: 0 });
        }

        /** Cupos pagados con saldo (para mostrar en resumen). */
        function calcularCuposPagadosConSaldo(reserva) {
            if (!reserva.pagos || !Array.isArray(reserva.pagos)) return 0;
            return reserva.pagos
                .filter(p => p.saldo_usado != null && p.saldo_usado > 0)
                .reduce((sum, p) => sum + (p.cuposPagados || 0), 0);
        }

        // =============================================
        // 9. NORMALIZACIÓN DE DATOS (función auxiliar reutilizable)
        // =============================================
        /**
         * Normaliza los datos obtenidos de Supabase al formato usado en el frontend
         * @param {Object} results - Objeto con resultados de las queries de Supabase
         * @returns {Object} Datos normalizados listos para usar en el frontend
         */
        function normalizarDatos({ rutasResult, reservasResult, participantesResult, gastosResult }) {
            // Validar errores
            if (rutasResult.error) throw rutasResult.error;
            if (reservasResult.error) throw reservasResult.error;
            if (participantesResult.error) throw participantesResult.error;
            if (gastosResult.error) throw gastosResult.error;

            // Normalizar rutas PRIMERO (necesario para normalizar reservas después)
            const rutas = (rutasResult.data || []).map((r, index) => ({
                ...r,
                archivada: r.archivada === true,
                precioEuros: r.precio_euros || 0, // Normalizado: usar solo precioEuros después
                numero: r.numero || (index + 1)
            }));

            // Normalizar reservas (incluye normalizar pagos con cuposPagados)
            let reservas = (reservasResult.data || []).map(r => {
                const rutaId = r.ruta_id || r.rutaId;
                const ruta = rutas.find(rt => rt.id === rutaId);
                const pagosRaw = r.pagos || [];
                const pagos = pagosRaw.map(p => ({
                    ...p,
                    cuposPagados: p.cuposPagados !== undefined ? p.cuposPagados : 0
                }));
                return {
                    ...r,
                    rutaId: rutaId,
                    ruta: ruta ? ruta.nombre : null,
                    cantidad: Number((r.cantidad_personas ?? r.cupos ?? r.cantidad) ?? 0),
                    montoPagado: r.monto_pagado || 0,
                    pagos: pagos
                };
            });
            // Migrar pagos antiguos (sin cuposPagados) a valor calculado o 0
            reservas = reservas.map(r => migrarPagosAntiguos(r, rutas.find(rt => rt.id === r.rutaId)));

            // Normalizar participantes
            const participantes = (participantesResult.data || []).map(p => ({
                ...p,
                rutaId: p.ruta_id || p.rutaId // 🔥 NUEVO: Normalizar ruta_id
            }));

            // Normalizar gastos
            const gastos = (gastosResult.data || []).map(g => {
                const rutaId = g.ruta_id || g.rutaId;
                // Buscar la ruta para obtener el nombre (compatibilidad)
                const ruta = rutas.find(rt => rt.id === rutaId);
                return {
                    ...g,
                    rutaId: rutaId, // 🔥 NUEVO: Usar ID de ruta en lugar de nombre
                    ruta: ruta ? ruta.nombre : null // 🔥 Campo derivado para compatibilidad
                };
            });

            return { rutas, reservas, participantes, gastos };
        }

        // =============================================
        // 10. GUARDAR DATOS (refactorizado - sin duplicación)
        // =============================================
        /**
         * Recarga todos los datos desde Supabase y los normaliza
         * @param {boolean} sinLoader - Si es true, no muestra el loader (útil para evitar parpadeo)
         * @returns {Promise<void>}
         */
        async function saveData(sinLoader = false) {
            try {
                // Cargar datos desde Supabase
                const [rutasResult, reservasResult, participantesResult, gastosResult] = await Promise.all([
                    retryWithBackoff(() => db.from('rutas').select('*').order('fecha', { ascending: true })),
                    retryWithBackoff(() => db.from('reservas').select('*')),
                    retryWithBackoff(() => db.from('participantes').select('*')),
                    retryWithBackoff(() => db.from('gastos').select('*').order('fecha', { ascending: false }))
                ]);

                // Normalizar y asignar datos (reutiliza lógica centralizada)
                const datosNormalizados = normalizarDatos({ rutasResult, reservasResult, participantesResult, gastosResult });
                data.rutas = datosNormalizados.rutas;
                data.reservas = datosNormalizados.reservas;
                data.participantes = datosNormalizados.participantes;
                data.gastos = datosNormalizados.gastos;
            } catch (error) {
                console.error('❌ Error al sincronizar datos:', error);
                throw error;
            }
        }

        /** Suscribe a cambios en tiempo real de rutas, reservas y gastos en Supabase. */
        function initRealtimeSync() {
            if (!db || realtimeChannel) return;
            
            realtimeChannel = db
                .channel('db-changes')
                .on('postgres_changes', 
                    { event: '*', schema: 'public', table: 'rutas' },
                    () => { loadData().then(() => { renderRutas(); renderReservas(); }); }
                )
                .on('postgres_changes',
                    { event: '*', schema: 'public', table: 'reservas' },
                    () => { loadData().then(() => { renderReservas(); renderRutas(); }); }
                )
                .on('postgres_changes',
                    { event: '*', schema: 'public', table: 'gastos' },
                    () => { loadData().then(() => { renderGastos(); renderRutas(); }); }
                )
                .on('postgres_changes',
                    { event: '*', schema: 'public', table: 'participantes' },
                    (payload) => { manejarCambioParticipanteEnTiempoReal(payload); }
                )
                .subscribe();
        }

        /** Desuscribe el canal Realtime para evitar memory leaks al cerrar/recargar la página. */
        function destroyRealtimeSync() {
            if (realtimeChannel && typeof realtimeChannel.unsubscribe === 'function') {
                realtimeChannel.unsubscribe();
                realtimeChannel = null;
            }
        }

        // Limpiar Realtime al cerrar/ocultar la pestaña
        if (typeof window !== 'undefined') {
            window.addEventListener('pagehide', destroyRealtimeSync);
            window.addEventListener('beforeunload', destroyRealtimeSync);
        }

        // ========== PULL-TO-REFRESH ==========
        (function initPullToRefresh() {
            const PULL_THRESHOLD = 70;
            const indicator = document.getElementById('pullRefreshIndicator');
            const labelEl = indicator ? indicator.querySelector('.pull-refresh-label') : null;
            let startY = 0;
            let pullDistance = 0;

            function getScrollTop() {
                return document.documentElement.scrollTop || document.body.scrollTop || 0;
            }

            function showIndicator(distance) {
                if (!indicator) return;
                indicator.classList.add('visible');
                indicator.classList.remove('refreshing');
                if (labelEl) labelEl.textContent = distance >= PULL_THRESHOLD ? 'Suelta para actualizar' : 'Desliza para actualizar';
            }

            function hideIndicator() {
                if (!indicator) return;
                indicator.classList.remove('visible', 'refreshing');
                if (labelEl) labelEl.textContent = 'Suelta para actualizar';
            }

            async function doRefresh() {
                if (!indicator || !labelEl) return;
                indicator.classList.add('refreshing');
                labelEl.textContent = 'Actualizando...';
                try {
                    await loadData();
                    updateSelects();
                    renderAll();
                    showToast('Datos actualizados', 'success');
                } catch (e) {
                    console.error('Error en pull-to-refresh:', e);
                    showToast('Error al actualizar', 'error');
                }
                setTimeout(hideIndicator, 300);
            }

            document.addEventListener('touchstart', function (e) {
                if (getScrollTop() === 0) startY = e.touches[0].pageY;
            }, { passive: true });

            document.addEventListener('touchmove', function (e) {
                if (getScrollTop() > 0) return;
                const currentY = e.touches[0].pageY;
                pullDistance = Math.max(0, currentY - startY);
                if (pullDistance > 20) showIndicator(pullDistance);
            }, { passive: true });

            document.addEventListener('touchend', function () {
                if (pullDistance >= PULL_THRESHOLD) {
                    doRefresh();
                } else {
                    hideIndicator();
                }
                pullDistance = 0;
            }, { passive: true });
        })();

        function esMiAccion(payload) {
            const id = payload.new?.id || payload.old?.id;
            return id && misAccionesRecientes.has(id);
        }

        function getMensajeCambioParticipante(payload) {
            const { eventType, new: nuevo, old: viejo } = payload;
            if (eventType === 'INSERT') return 'Nuevo participante agregado';
            if (eventType === 'DELETE') return 'Participante eliminado';
            if (eventType === 'UPDATE' && nuevo?.asiste !== viejo?.asiste) return 'Asistencia actualizada';
            return 'Participante actualizado';
        }

        function manejarCambioParticipanteEnTiempoReal(payload) {
            const { eventType, new: nuevo, old: viejo } = payload;
            const norm = (row) => row ? { ...row, rutaId: row.ruta_id || row.rutaId } : null;
            switch (eventType) {
                case 'INSERT':
                    if (nuevo) data.participantes.push(norm(nuevo));
                    break;
                case 'UPDATE':
                    if (nuevo) {
                        const idx = data.participantes.findIndex(p => p.id === nuevo.id);
                        if (idx !== -1) data.participantes[idx] = norm({ ...data.participantes[idx], ...nuevo });
                    }
                    break;
                case 'DELETE':
                    if (viejo) data.participantes = data.participantes.filter(p => p.id !== viejo.id);
                    break;
            }
            const cardsAActualizar = new Set();
            if (eventType === 'UPDATE' || eventType === 'DELETE') {
                const p = eventType === 'UPDATE' ? norm(nuevo) : norm(viejo);
                const cardId = encontrarCardPorParticipante(p);
                if (cardId) cardsAActualizar.add(cardId);
            }
            if (eventType === 'INSERT' && nuevo) {
                const cardId = encontrarCardPorParticipante(norm(nuevo));
                if (cardId) cardsAActualizar.add(cardId);
            }
            cardsAActualizar.forEach(cardId => actualizarCardAsistencia(cardId));
            actualizarContadorCheckin();
            if (!esMiAccion(payload)) showToast(getMensajeCambioParticipante(payload), 'info', 'Asistencia actualizada');
        }

        // =============================================
        // 11. NAVEGACIÓN ENTRE PESTAÑAS - VERSIÓN CORREGIDA
        // =============================================
        window.showTab = function(tabName) {
            // Obtener el evento del elemento que hizo clic
            const event = window.event || arguments.callee.caller.arguments[0];
            
            // Actualizar pestañas activas
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            document.getElementById(tabName).classList.add('active');

            // Mostrar/ocultar check-in rápido
            toggleCheckinRapido(tabName === 'asistencia');
            
            // Actualizar y renderizar
            updateSelects();
            renderAll();
            
            // Actualizar visibilidad del FAB según la pestaña activa
            if (typeof updateFabVisibility === 'function') {
                updateFabVisibility();
            }
        };
        
        // Función para manejar el clic del FAB según la pestaña activa
        window.handleFabClick = function() {
            const activeSection = document.querySelector('.section.active');
            if (!activeSection) return;
            
            const sectionId = activeSection.id;
            
            // Mapear cada pestaña a su modal correspondiente
            const modalMap = {
                'rutas': 'modalNuevaRuta',
                'reservas': 'modalNuevaReserva',
                'gastos': 'modalNuevoGasto'
            };
            
            const modalId = modalMap[sectionId];
            if (modalId) {
                openModal(modalId);
            }
        };
        
        // Función para actualizar la visibilidad del FAB según la pestaña activa
        window.updateFabVisibility = function() {
            const fab = document.getElementById('fab-main');
            if (!fab) return;
            
            const activeSection = document.querySelector('.section.active');
            if (!activeSection) {
                fab.style.display = 'none';
                return;
            }
            
            const sectionId = activeSection.id;
            // Mostrar FAB solo en pestañas con acción de creación
            if (sectionId === 'rutas' || sectionId === 'reservas' || sectionId === 'gastos') {
                fab.style.display = 'flex';
            } else {
                fab.style.display = 'none';
            }
        };
        
        // Inicializar visibilidad del FAB al cargar la página
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                setTimeout(updateFabVisibility, 100);
            });
        } else {
            setTimeout(updateFabVisibility, 100);
        }

        // =============================================
        // 12. MODALES
        // =============================================
        window.openModal = function(modalId) {
            updateSelects();
            if (modalId === 'modalNuevaReserva') {
                personasTemporales = [];
                renderPersonasTemporales();
            }
            if (modalId === 'modalNuevoGasto') {
                updateSelects();
            }
            document.getElementById(modalId).classList.add('active');
        };

        window.closeModal = function(modalId) {
            document.getElementById(modalId).classList.remove('active');
            if (modalId === 'modalNuevaReserva') {
                personasTemporales = [];
                document.getElementById('reservaLider').value = '';
                document.getElementById('reservaRuta').value = '';
                document.getElementById('reservaCantidad').value = '';
                document.getElementById('reservaMontoPagado').value = '';
                document.getElementById('reservaReferenciaPago').value = '';
                const reservaEnDolaresInput = document.getElementById('reservaEnDolares');
                if (reservaEnDolaresInput) reservaEnDolaresInput.checked = false;
                document.getElementById('personaNombreInput').value = '';
                document.getElementById('infoPrecioRuta').style.display = 'none';
            }
            if (modalId === 'modalNuevoGasto') {
                document.getElementById('gastoConcepto').value = '';
                document.getElementById('gastoRuta').value = '';
                document.getElementById('gastoMonto').value = '';
            }
            if (modalId === 'modalNuevoParticipante') {
                // Limpiar campos del formulario de nueva persona en reserva
                document.getElementById('participanteNombreCompleto').value = '';
                document.getElementById('participanteMonto').value = '';
                const participanteCuposInput = document.getElementById('participanteCuposPagados');
                if (participanteCuposInput) participanteCuposInput.value = '1';
                document.getElementById('participanteReferencia').value = '';
                const participanteEnDolaresInput = document.getElementById('participanteEnDolares');
                if (participanteEnDolaresInput) participanteEnDolaresInput.checked = false;
                liderActualParaNuevoParticipante = null;
                rutaActualParaNuevoParticipante = null;
            }
        };

        window.closeModalOnBackdrop = function(event, modalId) {
            // Si es el modal de confirmación, solo cerrar ese modal, no otros
            if (modalId === 'modalConfirm') {
                if (event.target.classList.contains('modal') && event.target.id === 'modalConfirm') {
                    if (confirmModalResolve) {
                        confirmModalResolve(false);
                        cerrarConfirmModal();
                    }
                }
                return;
            }
            
            // Para otros modales, comportamiento normal
            if (event.target.classList.contains('modal')) {
                closeModal(modalId);
            }
        };

        /** Genera el HTML de una opción &lt;option&gt; para una ruta (valor = id, texto escapado). */
        function buildOptionRuta(ruta, opts) {
            const conDisponibles = opts && opts.conDisponibles === true;
            const numeroRuta = ruta.numero ? `#${String(ruta.numero).padStart(4, '0')}` : '';
            const nombreEsc = escapeHtml(ruta.nombre);
            const fecha = formatearFechaRuta(ruta.fecha);
            let texto = `${nombreEsc} ${numeroRuta} - ${fecha}`;
            if (conDisponibles) {
                const ocupados = calcularCuposOcupados(ruta.id);
                const disponibles = calcularCuposDisponibles(ruta.id);
                const haySobreventa = ocupados > ruta.cupos;
                const textoDisponibles = haySobreventa
                    ? `⚠️ Sobrevendida (${ocupados}/${ruta.cupos})`
                    : `(${disponibles} disponibles)`;
                texto += ' ' + textoDisponibles;
            }
            return `<option value="${ruta.id}">${texto}</option>`;
        }

        function updateSelects() {
            const rutasActivas = data.rutas.filter(r => !r.archivada);

            const selectRuta = document.getElementById('reservaRuta');
            if (selectRuta) {
                selectRuta.innerHTML = '<option value="">Selecciona una ruta</option>' +
                    rutasActivas.map(r => buildOptionRuta(r, { conDisponibles: true })).join('');
            }

            const opcionesRutaSimple = rutasActivas.map(r => buildOptionRuta(r)).join('');
            const gastoRuta = document.getElementById('gastoRuta');
            if (gastoRuta) gastoRuta.innerHTML = '<option value="">Selecciona una ruta</option>' + opcionesRutaSimple;

            const filtroRutaReservas = document.getElementById('filtroRutaReservas');
            if (filtroRutaReservas) filtroRutaReservas.innerHTML = '<option value="">Todas las rutas</option>' + opcionesRutaSimple;

            const filtroRutaParticipantes = document.getElementById('filtroRutaParticipantes');
            if (filtroRutaParticipantes) filtroRutaParticipantes.innerHTML = '<option value="">Todas las rutas</option>' + opcionesRutaSimple;

            const filtroLiderAsistencia = document.getElementById('filtroLiderAsistencia');
            if (filtroLiderAsistencia) {
                const lideresUnicos = new Set();
                data.reservas.forEach(reserva => {
                    const ruta = data.rutas.find(r => r.id === reserva.rutaId);
                    if (ruta && !ruta.archivada) lideresUnicos.add(reserva.lider);
                });
                const lideresOrdenados = Array.from(lideresUnicos).sort((a, b) => a.localeCompare(b, 'es', { sensitivity: 'base' }));
                filtroLiderAsistencia.innerHTML = '<option value="">Todos los líderes</option>' +
                    lideresOrdenados.map(lider => `<option value="${escapeAttr(lider)}">${escapeHtml(lider)}</option>`).join('');
            }

            const filtroRutaAsistencia = document.getElementById('filtroRutaAsistencia');
            if (filtroRutaAsistencia) filtroRutaAsistencia.innerHTML = '<option value="">Todas las rutas</option>' + opcionesRutaSimple;

            const filtroRutaGastos = document.getElementById('filtroRutaGastos');
            if (filtroRutaGastos) filtroRutaGastos.innerHTML = '<option value="">Todas las rutas</option>' + opcionesRutaSimple;

            const selectReserva = document.getElementById('participanteReserva');
            if (selectReserva) {
                const optsReserva = data.reservas
                    .filter(reserva => {
                        const ruta = data.rutas.find(r => r.id === reserva.rutaId);
                        return ruta && !ruta.archivada;
                    })
                    .map(reserva => {
                        const ruta = data.rutas.find(r => r.id === reserva.rutaId);
                        const numeroRuta = ruta && ruta.numero ? `#${String(ruta.numero).padStart(4, '0')}` : '';
                        return `<option value="${escapeAttr(reserva.lider)}">${escapeHtml(reserva.lider)} - ${escapeHtml(ruta ? ruta.nombre : '')} ${numeroRuta}</option>`;
                    });
                selectReserva.innerHTML = '<option value="">Selecciona un líder</option>' + optsReserva.join('');
            }

            setTimeout(ajustarSelectsFiltro, 50);
        }
        // CÁLCULOS
        /**
         * Devuelve color y estado de completitud para X/Y (registrados vs cupos).
         * @param {number} registrados - Número de participantes registrados
         * @param {number} total - Cupos de la reserva
         * @returns {{ color: string, label: string }} color CSS y texto para tooltip/label
         */
        function getColorCompletitud(registrados, total) {
            if (registrados === 0) return { color: 'var(--danger)', label: 'Sin participantes' };
            if (registrados < total) return { color: '#f59e0b', label: 'Faltan ' + (total - registrados) };
            if (registrados === total) return { color: '#10b981', label: 'Completo' };
            return { color: 'var(--danger)', label: 'Sobrevendido' };
        }

        /**
         * Calcula el número de cupos ocupados en una ruta específica
         * SUMA la columna 'cantidad' de todas las reservas confirmadas (igual que Landing)
         * @param {string} rutaId - ID (UUID) de la ruta a calcular
         * @returns {number} Suma de cupos reservados (cantidad) de todas las reservas de la ruta
         */
        function calcularCuposOcupados(rutaId) {
            // Solo contar reservas de rutas no archivadas
            const ruta = data.rutas.find(r => r.id === rutaId);
            if (!ruta || ruta.archivada) return 0;
            
            // 🔥 NUEVA LÓGICA: Sumar la columna 'cantidad' de todas las reservas de esta ruta
            // Esto refleja la ocupación real independientemente de si se han cargado nombres o no
            const cuposReservados = data.reservas
                .filter(r => r.rutaId === rutaId)
                .reduce((sum, r) => sum + (getCuposReserva(r) || 0), 0);
            
            return cuposReservados;
        }

        /**
         * Calcula los cupos disponibles en una ruta
         * Puede retornar valores negativos si hay sobreventa
         * @param {string} rutaId - ID (UUID) de la ruta a calcular
         * @returns {number} Cupos disponibles (puede ser negativo si hay sobreventa)
         */
        function calcularCuposDisponibles(rutaId) {
            const ruta = data.rutas.find(r => r.id === rutaId);
            if (!ruta) return 0;
            const ocupados = calcularCuposOcupados(rutaId);
            const disponibles = ruta.cupos - ocupados;
            // Permitir valores negativos (sobreventa)
            return disponibles;
        }

        /**
         * Cuenta el total de participantes de un líder (todas sus rutas)
         * @param {string} lider - Nombre del líder
         * @returns {number} Total de participantes del líder
         */
        function contarParticipantes(lider) {
            // Conteo global por líder (se mantiene para usos generales)
            return data.participantes.filter(p => p.lider === lider).length;
        }

        /**
         * Devuelve el nombre de la columna real de cupos en la tabla 'reservas'
         * Prioridad: cantidad_personas -> cupos -> cantidad
         * @param {Object} reserva
         * @returns {string}
         */
        function getCantidadColumnName(reserva) {
            if (reserva && ('cantidad_personas' in reserva)) return 'cantidad_personas';
            if (reserva && ('cupos' in reserva)) return 'cupos';
            return 'cantidad';
        }

        /**
         * Obtiene cupos/cantidad de una reserva (compatible con distintas columnas)
         * @param {Object} reserva
         * @returns {number}
         */
        function getCuposReserva(reserva) {
            if (!reserva) return 0;
            const col = getCantidadColumnName(reserva);
            const val = reserva[col] ?? reserva.cantidad_personas ?? reserva.cupos ?? reserva.cantidad ?? 0;
            const n = Number(val);
            return Number.isFinite(n) ? n : 0;
        }

        // Nuevo: contar participantes por reserva específica (líder + ruta)
        /**
         * Cuenta los participantes registrados para una reserva específica (líder + ruta)
         * @param {string} lider - Nombre del líder de la reserva
         * @param {string} rutaNombre - Nombre de la ruta
         * @returns {number} Cantidad de participantes para esa reserva específica
         */
        function contarParticipantesReserva(lider, rutaId) {
            return data.participantes.filter(p => 
                p.lider === lider && 
                (p.rutaId === rutaId || p.ruta_id === rutaId)
            ).length;
        }

        /** Devuelve array de participantes de una reserva (líder + rutaId), ordenado por nombre */
        function obtenerParticipantesReserva(lider, rutaId) {
            const list = (data.participantes || []).filter(p => 
                p.lider === lider && 
                (p.rutaId === rutaId || p.ruta_id === rutaId)
            );
            return list.slice().sort((a, b) => (a.nombre || '').localeCompare(b.nombre || '', 'es', { sensitivity: 'base' }));
        }

        /** ID estable del card de asistencia (líder + rutaId) */
        function getAsistenciaCardId(lider, rutaId) {
            const slug = (lider || '').replace(/\s+/g, '-').toLowerCase();
            return `asistencia-card-${slug}-${rutaId || ''}`;
        }

        /** Dado un participante, devuelve el cardId del card de asistencia que lo contiene */
        function encontrarCardPorParticipante(participante) {
            if (!participante) return null;
            const rutaId = participante.rutaId || participante.ruta_id;
            const lider = participante.lider;
            if (!lider || !rutaId) return null;
            const reserva = data.reservas.find(r => r.lider === lider && r.rutaId === rutaId);
            return reserva ? getAsistenciaCardId(lider, rutaId) : null;
        }

        function getRutaParticipante(lider) {
            // Buscar la primera reserva del líder (puede tener múltiples)
            const reserva = data.reservas.find(r => r.lider === lider);
            if (reserva) {
                // 🔥 CORRECCIÓN: Buscar ruta por ID y obtener el nombre
                const ruta = data.rutas.find(r => r.id === reserva.rutaId);
                return ruta ? ruta.nombre : (reserva.ruta || 'Sin ruta');
            }
            return 'Sin ruta';
        }

        /** Rango del aventurado según asistencias totales (no rutas diferentes). Novato (0-1), luego Bronce (2+). */
        function calcularRangoAventurado(asistenciasTotales) {
            if (asistenciasTotales < 2) return { nombre: 'Novato', emoji: '🌱', color: '#22c55e', minRutas: 0 };
            if (asistenciasTotales <= 4) return { nombre: 'Bronce', emoji: '🥉', color: '#CD7F32', minRutas: 2 };
            if (asistenciasTotales <= 9) return { nombre: 'Plata', emoji: '🥈', color: '#C0C0C0', minRutas: 5 };
            if (asistenciasTotales <= 14) return { nombre: 'Oro', emoji: '🥇', color: '#FFD700', minRutas: 10 };
            if (asistenciasTotales <= 19) return { nombre: 'Platino', emoji: '💎', color: '#E5E4E2', minRutas: 15 };
            return { nombre: 'Diamante', emoji: '✨', color: '#b9f2ff', minRutas: 20 };
        }

        /** Siguiente rango en la escala (para barra de progreso) */
        function getSiguienteRango(rango) {
            if (!rango) return null;
            if (rango.nombre === 'Novato') return calcularRangoAventurado(2);
            if (rango.nombre === 'Bronce') return calcularRangoAventurado(5);
            if (rango.nombre === 'Plata') return calcularRangoAventurado(10);
            if (rango.nombre === 'Oro') return calcularRangoAventurado(15);
            if (rango.nombre === 'Platino') return calcularRangoAventurado(20);
            return null; // Diamante es el máximo
        }

        // Calcular cuántas rutas ha hecho una persona (cliente recurrente)
        // totalRutas = solo rutas con asistencia; totalTodasLasRutas = todas las participadas
        function calcularRutasPorPersona(nombrePersona) {
            const nombreNormalizado = (nombrePersona || '').toLowerCase().trim();
            const todasParticipaciones = (data.participantes || []).filter(p =>
                (p.nombre || '').toLowerCase().trim() === nombreNormalizado
            );

            if (todasParticipaciones.length === 0) {
                return {
                    totalRutas: 0, totalRutasAsistidas: 0, totalTodasLasRutas: 0,
                    totalParticipaciones: 0, totalAsistidas: 0, totalNoAsistidas: 0, porcentajeAsistencia: 0,
                    rutasAsistidas: [], todasLasRutas: [], participacionesDetalladas: [],
                    rango: null, siguienteRango: null, progresoHaciaSiguiente: 0, totalParaSiguiente: 0
                };
            }

            const totalParticipaciones = todasParticipaciones.length;
            const totalAsistidas = todasParticipaciones.filter(p => p.asiste === true).length;
            const totalNoAsistidas = todasParticipaciones.filter(p => p.asiste === false).length;
            const porcentajeAsistencia = totalParticipaciones > 0
                ? ((totalAsistidas / totalParticipaciones) * 100).toFixed(0)
                : 0;

            const todasLasRutasUnicas = new Set();
            const rutasAsistidasUnicas = new Set();
            const rutasAsistidasDetalle = [];

            todasParticipaciones.forEach(p => {
                const rutaObj = data.rutas.find(r => r.id === (p.rutaId || p.ruta_id));
                const nombreRuta = (rutaObj && rutaObj.nombre) ? rutaObj.nombre : ((p.ruta_nombre || p.ruta || '').trim());
                if (!nombreRuta) return;

                todasLasRutasUnicas.add(nombreRuta);

                if (p.asiste === true) {
                    if (!rutasAsistidasUnicas.has(nombreRuta)) {
                        rutasAsistidasUnicas.add(nombreRuta);
                        const ruta = data.rutas.find(r => r.nombre === nombreRuta || r.id === (p.rutaId || p.ruta_id));
                        rutasAsistidasDetalle.push({
                            nombre: nombreRuta,
                            fecha: ruta ? ruta.fecha : null,
                            archivada: ruta ? ruta.archivada : false,
                            vecesAsistio: todasParticipaciones.filter(pa => {
                                const ro = data.rutas.find(r => r.id === (pa.rutaId || pa.ruta_id));
                                const nr = (ro && ro.nombre) ? ro.nombre : (pa.ruta_nombre || pa.ruta);
                                return nr === nombreRuta && pa.asiste === true;
                            }).length,
                            ultimaAsistencia: p.fecha || null,
                            lider: p.lider
                        });
                    }
                }
            });

            rutasAsistidasDetalle.sort((a, b) => {
                if (!a.fecha && !b.fecha) return 0;
                if (!a.fecha) return 1;
                if (!b.fecha) return -1;
                return new Date(b.fecha) - new Date(a.fecha);
            });

            const rutasAsistidasCount = rutasAsistidasUnicas.size;
            /* Rango por asistencias totales (no por rutas diferentes) */
            const rango = calcularRangoAventurado(totalAsistidas);
            const siguienteRango = rango ? getSiguienteRango(rango) : null;

            return {
                totalRutas: rutasAsistidasCount,
                totalRutasAsistidas: rutasAsistidasCount,
                totalTodasLasRutas: todasLasRutasUnicas.size,
                totalParticipaciones: totalParticipaciones,
                totalAsistidas: totalAsistidas,
                totalNoAsistidas: totalNoAsistidas,
                porcentajeAsistencia: porcentajeAsistencia,
                rutasAsistidas: rutasAsistidasDetalle,
                todasLasRutas: Array.from(todasLasRutasUnicas),
                participacionesDetalladas: todasParticipaciones.map(p => ({
                    ruta: (data.rutas.find(r => r.id === (p.rutaId || p.ruta_id)) || {}).nombre || p.ruta_nombre || p.ruta,
                    asiste: p.asiste,
                    fecha: p.fecha,
                    lider: p.lider,
                    rutaId: p.rutaId || p.ruta_id
                })),
                rango: rango,
                siguienteRango: siguienteRango,
                progresoHaciaSiguiente: rango ? totalAsistidas - rango.minRutas : 0,
                totalParaSiguiente: rango && siguienteRango ? siguienteRango.minRutas - rango.minRutas : 0
            };
        }

        function generarRankingAventurados() {
            const personasMap = new Map();
            (data.participantes || []).forEach(p => {
                const nombre = (p.nombre || '').trim();
                if (!nombre) return;
                if (!personasMap.has(nombre)) {
                    personasMap.set(nombre, { nombre: nombre, rutasAsistidasSet: new Set(), participaciones: [] });
                }
                const persona = personasMap.get(nombre);
                persona.participaciones.push(p);
                if (p.asiste === true) {
                    const claveRuta = p.rutaId || p.ruta_id || (p.ruta_nombre || p.ruta);
                    if (claveRuta) persona.rutasAsistidasSet.add(claveRuta);
                }
            });

            const ordenRangos = { 'Diamante': 6, 'Platino': 5, 'Oro': 4, 'Plata': 3, 'Bronce': 2, 'Novato': 1 };
            let ranking = Array.from(personasMap.values()).map(persona => {
                const rutasAsistidas = persona.rutasAsistidasSet.size;
                const totalParticipaciones = persona.participaciones.length;
                const totalAsistidas = persona.participaciones.filter(pa => pa.asiste === true).length;
                const porcentajeAsistencia = totalParticipaciones > 0 ? Math.round((totalAsistidas / totalParticipaciones) * 100) : 0;
                /* Rango por asistencias totales (no por rutas diferentes) */
                const rango = calcularRangoAventurado(totalAsistidas);
                const siguienteRango = rango ? getSiguienteRango(rango) : null;
                return {
                    nombre: persona.nombre,
                    rutasAsistidas: rutasAsistidas,
                    totalParticipaciones: totalParticipaciones,
                    totalAsistidas: totalAsistidas,
                    porcentajeAsistencia: porcentajeAsistencia,
                    rango: rango,
                    siguienteRango: siguienteRango,
                    progreso: rango ? totalAsistidas - rango.minRutas : 0,
                    totalParaSiguiente: rango && siguienteRango ? siguienteRango.minRutas - rango.minRutas : 0
                };
            }).filter(p => p.rango !== null && p.totalAsistidas >= 2);

            ranking.sort((a, b) => {
                const pesoA = ordenRangos[a.rango.nombre] || 0;
                const pesoB = ordenRangos[b.rango.nombre] || 0;
                if (pesoB !== pesoA) return pesoB - pesoA;
                if (b.totalAsistidas !== a.totalAsistidas) return b.totalAsistidas - a.totalAsistidas;
                if (b.porcentajeAsistencia !== a.porcentajeAsistencia) return b.porcentajeAsistencia - a.porcentajeAsistencia;
                return (a.nombre || '').localeCompare(b.nombre || '', 'es');
            });
            return ranking.slice(0, 50);
        }

        function calcularTotalRecaudado(rutaId) {
            // Solo contar pagos en Bs (los gastos son en Bs)
            return data.reservas
                .filter(r => r.rutaId === rutaId)
                .reduce((sum, r) => {
                    const totalBs = (r.pagos || [])
                        .filter(p => !p.enDolares)
                        .reduce((s, p) => s + p.monto, 0);
                    return sum + totalBs;
                }, 0);
        }
        
        function calcularTotalDolares(rutaId) {
            // Calcular total en dólares efectivo
            return data.reservas
                .filter(r => r.rutaId === rutaId)
                .reduce((sum, r) => {
                    const totalDolares = (r.pagos || [])
                        .filter(p => p.enDolares)
                        .reduce((s, p) => s + p.monto, 0);
                    return sum + totalDolares;
                }, 0);
        }

        /**
         * Calcula el total de gastos registrados para una ruta
         * @param {string} rutaId - ID (UUID) de la ruta
         * @returns {number} Total de gastos en Bs
         */
        function calcularTotalGastos(rutaId) {
            return data.gastos
                .filter(g => g.rutaId === rutaId)
                .reduce((sum, g) => sum + (g.monto || 0), 0);
        }

        /**
         * Calcula el profit neto (recaudado - gastos) para una ruta
         * @param {string} rutaId - ID (UUID) de la ruta
         * @returns {number} Profit neto en Bs
         */
        function calcularProfitNeto(rutaId) {
            const recaudado = calcularTotalRecaudado(rutaId);
            const gastos = calcularTotalGastos(rutaId);
            return recaudado - gastos;
        }

        function calcularMontoEsperado(rutaId) {
            const cuposReservados = data.reservas
                .filter(r => r.rutaId === rutaId)
                .reduce((sum, r) => sum + r.cantidad, 0);
            return cuposReservados;
        }

        // MOSTRAR PRECIO REFERENCIAL EN MODAL RESERVA
        function mostrarPrecioRuta() {
            const rutaId = document.getElementById('reservaRuta').value;
            if (rutaId) {
                const ruta = data.rutas.find(r => r.id === rutaId);
                if (ruta) {
                    const precioEuros = ruta.precioEuros || 0;
                    document.getElementById('infoPrecioRuta').style.display = 'block';
                    document.getElementById('precioReferencialRuta').textContent = `${precioEuros}€ por cupo`;
                } else {
                    document.getElementById('infoPrecioRuta').style.display = 'none';
                }
            } else {
                document.getElementById('infoPrecioRuta').style.display = 'none';
            }
        }

        async function actualizarSaldoLiderNuevaReserva() {
            const lider = (document.getElementById('reservaLider')?.value || '').trim();
            const rutaId = document.getElementById('reservaRuta')?.value;
            const cantidad = parseInt(document.getElementById('reservaCantidad')?.value, 10) || 0;
            const block = document.getElementById('infoSaldoLiderNuevaReserva');
            const inputCupos = document.getElementById('reservaCuposConSaldo');
            const elMax = document.getElementById('reservaCuposConSaldoMax');
            const elSaldo = document.getElementById('saldoLiderNuevaReserva');
            if (!block || !inputCupos || !elMax || !elSaldo) return;
            if (!lider || !rutaId) {
                block.style.display = 'none';
                inputCupos.value = '0';
                return;
            }
            const ruta = data.rutas.find(r => r.id === rutaId);
            const precioCupo = ruta ? (ruta.precioEuros || 0) : 0;
            const saldo = await obtenerSaldoLider(lider);
            if (saldo <= 0 || precioCupo <= 0) {
                block.style.display = 'none';
                inputCupos.value = '0';
                return;
            }
            const maxCupos = Math.floor(saldo / precioCupo);
            block.style.display = 'block';
            elSaldo.textContent = '€' + saldo.toFixed(2);
            elMax.textContent = String(maxCupos);
            inputCupos.max = maxCupos;
            const actual = parseInt(inputCupos.value, 10) || 0;
            if (actual > maxCupos) inputCupos.value = maxCupos;
            if (actual === 0 && maxCupos > 0 && cantidad > 0) inputCupos.value = Math.min(cantidad, maxCupos);
        }

        // GESTIÓN DE PERSONAS TEMPORALES EN RESERVA
        function agregarPersonaTemporal() {
            const nombre = document.getElementById('personaNombreInput').value.trim();
            const cantidad = parseInt(document.getElementById('reservaCantidad').value) || 0;
            const lider = document.getElementById('reservaLider').value.trim();
            
            if (!nombre) {
                showToast('Ingresa un nombre', 'warning');
                document.getElementById('personaNombreInput').focus();
                return;
            }
            
            if (!lider) {
                showToast('Primero ingresa el nombre del líder', 'warning');
                document.getElementById('reservaLider').focus();
                return;
            }
            
            // Verificar duplicados
            if (personasTemporales.includes(nombre)) {
                showToast('Esta persona ya está agregada', 'warning');
                document.getElementById('personaNombreInput').value = '';
                document.getElementById('personaNombreInput').focus();
                return;
            }
            
            // Verificar si el líder ya está agregado
            if (nombre.toLowerCase() === lider.toLowerCase()) {
                showToast('El líder se agregará automáticamente al guardar', 'info');
                document.getElementById('personaNombreInput').value = '';
                document.getElementById('personaNombreInput').focus();
                return;
            }
            
            // Verificar cupos (incluyendo el líder que se agregará automáticamente)
            const totalPersonas = personasTemporales.length + 1; // +1 por el líder
            if (cantidad > 0 && totalPersonas >= cantidad) {
                showToast(`Ya has agregado el máximo de personas (${cantidad} cupos). El líder cuenta como uno.`, 'warning');
                document.getElementById('personaNombreInput').value = '';
                return;
            }
            
            personasTemporales.push(nombre);
            document.getElementById('personaNombreInput').value = '';
            renderPersonasTemporales();
            
            // Enfocar de nuevo en el input para agregar más personas rápidamente
            setTimeout(() => {
                document.getElementById('personaNombreInput').focus();
            }, 50);
        }

        function eliminarPersonaTemporal(index) {
            personasTemporales.splice(index, 1);
            renderPersonasTemporales();
        }

        function renderPersonasTemporales() {
            const container = document.getElementById('personasTemporalesList');
            const info = document.getElementById('personasInfo');
            const cantidad = parseInt(document.getElementById('reservaCantidad').value) || 0;
            const lider = document.getElementById('reservaLider').value.trim();
            
            if (personasTemporales.length === 0 && !lider) {
                container.innerHTML = '';
                info.innerHTML = '';
                return;
            }
            
            let html = '';
            personasTemporales.forEach((nombre, index) => {
                html += `
                    <div class="persona-item">
                        <span class="persona-nombre">${nombre}</span>
                        <button class="persona-remove" onclick="eliminarPersonaTemporal(${index})">Eliminar</button>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // Actualizar info
            const totalPersonas = personasTemporales.length + (lider ? 1 : 0);
            if (cantidad > 0) {
                const disponibles = cantidad - totalPersonas;
                const haySobreventa = totalPersonas > cantidad;
                if (haySobreventa) {
                    info.innerHTML = `<span style="color: var(--danger); font-weight: 700;">⚠️ Total: ${totalPersonas}/${cantidad} personas (Sobrevendido por ${Math.abs(disponibles)})</span>`;
                    info.className = 'personas-warning';
                } else if (disponibles >= 0) {
                    info.innerHTML = `Total: ${totalPersonas}/${cantidad} personas (${disponibles} disponibles)`;
                    info.className = 'personas-info';
                } else {
                    info.innerHTML = `<span style="color: var(--danger);">Total: ${totalPersonas}/${cantidad} personas (excede por ${Math.abs(disponibles)})</span>`;
                    info.className = 'personas-warning';
                }
            } else {
                info.innerHTML = `Total: ${totalPersonas} persona${totalPersonas !== 1 ? 's' : ''} agregada${totalPersonas !== 1 ? 's' : ''}`;
                info.className = 'personas-info';
            }
        }

        function actualizarPersonasEnReserva() {
            mostrarPrecioRuta();
            renderPersonasTemporales();
            actualizarSaldoLiderNuevaReserva();
        }

        /**
         * Crea una nueva ruta con validaciones mejoradas
         * Genera número automático y maneja archivado
         * @returns {Promise<void>}
         */
        async function agregarRuta() {
            const nombre = document.getElementById('rutaNombre').value.trim();
            const fecha = document.getElementById('rutaFecha').value;
            const cupos = parseInt(document.getElementById('rutaCupos').value);
            const precioEuros = parseFloat(document.getElementById('rutaPrecioEuros').value);
            const archivoFoto = document.getElementById('rutaFoto')?.files?.[0] || null;

            // Validaciones mejoradas
            if (!nombre || nombre.length < 2) {
                showToast('El nombre de la ruta debe tener al menos 2 caracteres', 'warning', 'Validación');
                document.getElementById('rutaNombre').focus();
                return;
            }

            if (!fecha) {
                showToast('Selecciona una fecha', 'warning', 'Validación');
                document.getElementById('rutaFecha').focus();
                return;
            }

            if (!cupos || cupos < 1 || cupos > 1000) {
                showToast('Los cupos deben estar entre 1 y 1000', 'warning', 'Validación');
                document.getElementById('rutaCupos').focus();
                return;
            }

            if (!precioEuros || precioEuros < 0) {
                showToast('El precio debe ser un valor positivo', 'warning', 'Validación');
                document.getElementById('rutaPrecioEuros').focus();
                return;
            }

    // 🔪 MODIFICACIÓN QUIRÚRGICA: generar número automático
    const ultimaRuta = data.rutas
        .filter(r => !r.archivada)
        .sort((a, b) => (b.numero || 0) - (a.numero || 0))[0];

    const nuevoNumero = (ultimaRuta?.numero || 0) + 1;

    // Guardar solo el nombre sin el # (el número se muestra por separado en el ID)
    try {
        showLoader('Creando ruta...');

        let fotoUrl = null;

        // Subir imagen a Supabase Storage si el usuario seleccionó un archivo
        if (archivoFoto) {
            try {
                showLoader('Subiendo foto...');
                const nombreLimpio = nombre.toLowerCase().replace(/[^a-z0-9]+/g, '-').slice(0, 50);
                const extension = archivoFoto.name.split('.').pop() || 'jpg';
                const nombreUnico = `ruta_${Date.now()}_${nombreLimpio}.${extension}`;

                const { error: errorUpload } = await db.storage
                    .from('flyers')
                    .upload(nombreUnico, archivoFoto, {
                        cacheControl: '3600',
                        upsert: false
                    });

                if (errorUpload) {
                    console.error('Error al subir la foto:', errorUpload);
                    showToast('No se pudo subir la foto, pero la ruta se guardará igual.', 'warning', 'Foto opcional');
                } else {
                    const { data: publicData } = db.storage
                        .from('flyers')
                        .getPublicUrl(nombreUnico);

                    fotoUrl = publicData?.publicUrl || null;
                }
            } catch (errorFoto) {
                console.error('Error inesperado al subir la foto:', errorFoto);
                showToast('Hubo un problema al subir la foto, pero la ruta se guardará igual.', 'warning', 'Foto opcional');
            } finally {
                showLoader('Creando ruta...');
            }
        }
        
        const { data: nuevaRuta, error } = await db
            .from('rutas')
            .insert([{
                nombre: nombre, // Nombre limpio sin #
                fecha,
                cupos,
                precio_euros: precioEuros,
                archivada: false,
                numero: nuevoNumero, // El número se guarda en el campo separado
                foto_url: fotoUrl
            }])
            .select()
            .single();

        if (error) throw error;

        document.getElementById('rutaNombre').value = '';
        document.getElementById('rutaFecha').value = '';
        document.getElementById('rutaCupos').value = '';
        document.getElementById('rutaPrecioEuros').value = '';
        if (document.getElementById('rutaFoto')) {
            document.getElementById('rutaFoto').value = '';
        }
        
        closeModal('modalNuevaRuta');
        await saveData(true); // Usar saveData sin loader para evitar parpadeo
        updateSelects();
        renderRutas();
        showToast(`Ruta creada: ${nombre} #${String(nuevoNumero).padStart(4, '0')}`, 'success', 'Éxito');
    } catch (error) {
        console.error('Error:', error);
        showToast('Error al crear la ruta: ' + error.message, 'error', 'Error');
    } finally {
        hideLoader();
    }
}


        /**
         * Crea una nueva reserva con validaciones mejoradas
         * Auto-registra al líder como participante
         * @returns {Promise<void>}
         */
        async function agregarReserva() {
            const lider = document.getElementById('reservaLider').value.trim();
            const rutaId = document.getElementById('reservaRuta').value; // 🔥 CAMBIO: Ahora es un ID
            const cantidad = parseInt(document.getElementById('reservaCantidad').value);
            const montoPagado = parseFloat(document.getElementById('reservaMontoPagado').value) || 0;

            // Validaciones mejoradas
            const partesNombreLider = lider.split(/\s+/).filter(p => p);
            if (!lider || partesNombreLider.length < 2) {
                showToast('Ingresa el nombre completo del líder (nombre y apellido)', 'warning', 'Validación');
                document.getElementById('reservaLider').focus();
                return;
            }

            if (!rutaId) {
                showToast('Selecciona una ruta', 'warning', 'Validación');
                document.getElementById('reservaRuta').focus();
                return;
            }

            if (!cantidad || cantidad < 1 || cantidad > 100) {
                showToast('La cantidad de cupos debe estar entre 1 y 100', 'warning', 'Validación');
                document.getElementById('reservaCantidad').focus();
                return;
            }

            if (montoPagado < 0) {
                showToast('El monto pagado no puede ser negativo', 'warning', 'Validación');
                document.getElementById('reservaMontoPagado').focus();
                return;
            }

            // Obtener el objeto de ruta completo
            const ruta = data.rutas.find(r => r.id === rutaId);
            if (!ruta) {
                showToast('Ruta no encontrada', 'error', 'Error');
                return;
            }

            // Permitir múltiples reservas del mismo líder, pero solo en rutas diferentes
            const reservaExistente = data.reservas.find(r => r.lider === lider && r.rutaId === rutaId);
            if (reservaExistente) {
                showToast(`Ya existe una reserva de "${lider}" para la ruta "${ruta.nombre}". Un líder solo puede tener una reserva por ruta.`, 'error', 'Reserva Duplicada');
                return;
            }

            const disponibles = calcularCuposDisponibles(rutaId);
            if (disponibles < 0) {
                // Ya hay sobreventa, permitir continuar con advertencia
                const continuar = await confirmarAccion(
                    `Esta ruta ya está sobrevendida (${calcularCuposOcupados(rutaId)}/${ruta.cupos} personas).\n\n` +
                    `¿Deseas continuar agregando ${cantidad} cupo${cantidad > 1 ? 's' : ''} más?`,
                    'peligro'
                );
                if (!continuar) return;
            } else if (cantidad > disponibles) {
                // Hay cupos pero no suficientes, permitir sobreventa con advertencia
                const continuar = await confirmarAccion(
                    `Solo hay ${disponibles} cupo${disponibles !== 1 ? 's' : ''} disponible${disponibles !== 1 ? 's' : ''}, pero quieres reservar ${cantidad}.\n\n` +
                    `¿Deseas continuar y crear sobreventa?`,
                    'peligro'
                );
                if (!continuar) return;
            }

            // Validar que las personas temporales no excedan los cupos (permitir sobreventa con advertencia)
            const totalPersonas = personasTemporales.length + 1; // +1 por el líder
            if (totalPersonas > cantidad) {
                const continuar = await confirmarAccion(
                    `Has agregado ${totalPersonas} personas pero solo reservaste ${cantidad} cupos. El líder cuenta como uno.\n\n` +
                    `¿Deseas continuar y crear sobreventa?`,
                    'peligro'
                );
                if (!continuar) return;
            }

            const cuposConSaldo = parseInt(document.getElementById('reservaCuposConSaldo')?.value, 10) || 0;
            const precioCupo = ruta.precioEuros || 0;
            let saldoUsar = 0;
            if (cuposConSaldo > 0 && precioCupo > 0) {
                saldoUsar = cuposConSaldo * precioCupo;
                const saldoDisponible = await obtenerSaldoLider(lider);
                if (saldoUsar > saldoDisponible) {
                    showToast(`Saldo insuficiente. Necesitas €${saldoUsar.toFixed(2)}, disponible: €${saldoDisponible.toFixed(2)}`, 'error');
                    return;
                }
                if (cuposConSaldo > cantidad) {
                    showToast('Cupos a pagar con saldo no pueden superar los cupos reservados', 'warning');
                    return;
                }
            }

            try {
                showLoader('Creando reserva...');
                
                const referenciaPago = document.getElementById('reservaReferenciaPago').value.trim();
                const enDolares = document.getElementById('reservaEnDolares')?.checked || false;
                const cuposMontoInicial = parseInt(document.getElementById('reservaCuposMontoInicial')?.value, 10);
                const pagosIniciales = [];
                if (montoPagado > 0) {
                    pagosIniciales.push({
                        monto: montoPagado,
                        referencia: referenciaPago || 'Pago inicial',
                        fecha: new Date().toISOString(),
                        enDolares: enDolares,
                        cuposPagados: enDolares ? 0 : (isNaN(cuposMontoInicial) || cuposMontoInicial < 1 ? 1 : cuposMontoInicial)
                    });
                }
                if (cuposConSaldo > 0 && saldoUsar > 0) {
                    pagosIniciales.push({
                        monto: 0,
                        cuposPagados: cuposConSaldo,
                        enDolares: false,
                        saldo_usado: saldoUsar,
                        referencia: referenciaPago || 'Pago con saldo',
                        fecha: new Date().toISOString()
                    });
                }
                
                const montoPagadoBs = enDolares ? 0 : montoPagado;

                const { data: nuevaReserva, error: errorReserva } = await db
                    .from('reservas')
                    .insert([{ 
                        lider, 
                        ruta_id: rutaId,
                        cantidad, 
                        monto_pagado: montoPagadoBs, 
                        pagos: pagosIniciales,
                        abonado_euros: saldoUsar || null,
                        pagado_con_abono: saldoUsar > 0
                    }])
                    .select()
                    .single();

                if (errorReserva) throw errorReserva;

                // AUTO-REGISTRO DEL LÍDER Y PERSONAS TEMPORALES — justo después de crear la reserva,
                // para que SIEMPRE se ejecute (con o sin saldo). Si falla el bloque de saldo después,
                // el líder ya estará en Asistencia.
                const liderExiste = data.participantes.find(p => 
                    p.nombre.toLowerCase() === lider.toLowerCase() && 
                    p.lider === lider &&
                    (p.rutaId === rutaId || p.ruta_id === rutaId)
                );
                
                if (!liderExiste) {
                    await db
                        .from('participantes')
                        .insert([{
                            nombre: lider,
                            lider: lider,
                            ruta_id: rutaId,
                            ruta_nombre: ruta.nombre,
                            asiste: false
                        }]);
                }
                
                const participantesInsert = [];
                personasTemporales.forEach(nombre => {
                    const existe = data.participantes.find(p => 
                        p.nombre.toLowerCase() === nombre.toLowerCase() && 
                        p.lider === lider &&
                        (p.rutaId === rutaId || p.ruta_id === rutaId)
                    );
                    
                    if (!existe) {
                        participantesInsert.push({
                            nombre: nombre,
                            lider: lider,
                            ruta_id: rutaId,
                            ruta_nombre: ruta.nombre,
                            asiste: false
                        });
                    }
                });

                if (participantesInsert.length > 0) {
                    await db.from('participantes').insert(participantesInsert);
                }

                if (saldoUsar > 0) {
                    const { abonado, saldoDespues } = await registrarMovimientoAbono({
                        lider: lider,
                        tipo: 'uso',
                        monto_euros: -saldoUsar,
                        descripcion: 'Pago al crear reserva',
                        referencia: referenciaPago || ('Ruta ' + rutaId),
                        ruta_id: rutaId
                    });
                    if (saldoDespues <= 0 && abonado && abonado.id) {
                        await db.from('abonados').delete().eq('id', abonado.id);
                    }
                    if (typeof renderAbonados === 'function') renderAbonados();
                }
                
                // Limpiar formulario
                document.getElementById('reservaLider').value = '';
                document.getElementById('reservaRuta').value = '';
                document.getElementById('reservaCantidad').value = '';
                document.getElementById('reservaMontoPagado').value = '';
                const reservaCuposMontoInicialEl = document.getElementById('reservaCuposMontoInicial');
                if (reservaCuposMontoInicialEl) reservaCuposMontoInicialEl.value = '1';
                document.getElementById('reservaReferenciaPago').value = '';
                const reservaEnDolaresInput2 = document.getElementById('reservaEnDolares');
                if (reservaEnDolaresInput2) reservaEnDolaresInput2.checked = false;
                document.getElementById('personaNombreInput').value = '';
                document.getElementById('infoPrecioRuta').style.display = 'none';
                const infoSaldo = document.getElementById('infoSaldoLiderNuevaReserva');
                if (infoSaldo) infoSaldo.style.display = 'none';
                const reservaCuposConSaldoEl = document.getElementById('reservaCuposConSaldo');
                if (reservaCuposConSaldoEl) reservaCuposConSaldoEl.value = '0';
                personasTemporales = [];
                renderPersonasTemporales();
                
                closeModal('modalNuevaReserva');
                // 🔇 Usar saveData en lugar de loadData para evitar toasts redundantes
                await saveData(true); // Silencioso, sin loader
                updateSelects();
                renderReservas();
                renderRutas();
                renderParticipantes();
                // ✅ Solo un toast específico de la acción
                showToast('Reserva creada exitosamente. El líder y las personas agregadas han sido registradas automáticamente.', 'success', 'Éxito');
            } catch (error) {
                console.error('Error:', error);
                showToast('Error al crear la reserva: ' + error.message, 'error', 'Error');
            } finally {
                hideLoader();
            }
        }

        // Primero, AGREGAR esta función para actualizar cupos de reserva:
/**
 * Actualiza la cantidad de cupos de una reserva
 * Maneja validaciones de sobreventa y confirmaciones
 * @param {string} lider - Nombre del líder de la reserva
 * @param {number} incremento - Cantidad de cupos a agregar (default: 1)
 * @param {boolean} sinConfirmacion - Si es true, no muestra confirmación de sobreventa
 * @returns {Promise<boolean>} true si se actualizó correctamente, false en caso contrario
 */
async function actualizarCuposReserva(lider, incremento = 1, sinConfirmacion = false) {
    const reserva = data.reservas.find(r => r.lider === lider);
    if (!reserva) return false;
    
    // 🔥 CORRECCIÓN: Buscar ruta por ID
    const ruta = data.rutas.find(r => r.id === reserva.rutaId);
    if (!ruta) return false;
    
    // Verificar cupos disponibles (permitir sobreventa)
    // 🔥 CORRECCIÓN: Usar rutaId en lugar de nombre
    const disponibles = calcularCuposDisponibles(reserva.rutaId);
    
    // Solo mostrar confirmación si no se pasó sinConfirmacion=true (para evitar doble confirmación)
    if (!sinConfirmacion && disponibles < incremento) {
        // Permitir sobreventa con advertencia usando modal
        // 🔥 CORRECCIÓN: Usar rutaId en lugar de nombre
        const ocupados = calcularCuposOcupados(reserva.rutaId);
        const continuar = await confirmarAccion(
            `Solo hay ${disponibles >= 0 ? disponibles : 0} cupo${disponibles !== 1 ? 's' : ''} disponible${disponibles !== 1 ? 's' : ''}.\n\n` +
            `Actualmente: ${ocupados}/${ruta.cupos} personas\n\n` +
            `¿Deseas continuar y crear sobreventa?`,
            'peligro'
        );
        if (!continuar) return false;
    }
    
    try {
        const nuevaCantidad = reserva.cantidad + incremento;
        const { error } = await db
            .from('reservas')
            .update({ cantidad: nuevaCantidad })
            .eq('lider', lider)
            .eq('ruta_id', reserva.rutaId);
            
        if (error) throw error;
        
        return true;
    } catch (error) {
        console.error('Error actualizando cupos:', error);
        showToast('Error al actualizar los cupos de la reserva', 'error', 'Error');
        return false;
    }
}

        /**
         * Separa un nombre completo en nombre, segundo nombre y apellido
         * @param {string} nombreCompleto - Nombre completo a separar
         * @returns {Object} Objeto con {nombre, segundoNombre, apellido}
         */
        function separarNombreCompleto(nombreCompleto) {
            const palabras = nombreCompleto.trim().split(/\s+/).filter(p => p);
            
            if (palabras.length === 0) {
                return { nombre: '', segundoNombre: '', apellido: '' };
            } else if (palabras.length === 1) {
                return { nombre: palabras[0], segundoNombre: '', apellido: '' };
            } else if (palabras.length === 2) {
                return { nombre: palabras[0], segundoNombre: '', apellido: palabras[1] };
            } else if (palabras.length === 3) {
                return { nombre: palabras[0], segundoNombre: palabras[1], apellido: palabras[2] };
            } else {
                // 4+ palabras: primera = nombre, segunda = segundo nombre, resto = apellido
                return { 
                    nombre: palabras[0], 
                    segundoNombre: palabras[1], 
                    apellido: palabras.slice(2).join(' ') 
                };
            }
        }

        /**
         * Agrega un nuevo participante a una reserva específica
         * El participante se asocia automáticamente al líder y ruta del contexto
         * Maneja sobreventa con confirmación única y permite pagos opcionales
         * @returns {Promise<void>}
         */
        async function agregarParticipante() {
    const nombreCompletoInput = document.getElementById('participanteNombreCompleto').value.trim();
    const lider = liderActualParaNuevoParticipante;
    const rutaAsociadaId = rutaActualParaNuevoParticipante; // Es un ID (UUID)
    const monto = parseFloat(document.getElementById('participanteMonto').value) || 0;
    const referencia = document.getElementById('participanteReferencia').value.trim();

    if (!nombreCompletoInput) {
        showToast('Ingresa el nombre completo', 'warning', 'Campo Requerido');
        return;
    }

    if (!lider || !rutaAsociadaId) {
        showToast('Abre este formulario desde el card de la reserva.', 'warning', 'Selecciona una reserva');
        return;
    }

    // Separar el nombre completo automáticamente
    const { nombre, segundoNombre, apellido } = separarNombreCompleto(nombreCompletoInput);
    if (!nombre || !apellido) { 
        showToast('Ingresa al menos nombre y apellido', 'warning', 'Nombre Incompleto'); 
        return; 
    }

    const nombreCompleto = [nombre, segundoNombre, apellido].filter(n => n).join(' ');

    // Buscar la reserva específica por líder + ruta ID
    const reserva = data.reservas.find(r => r.lider === lider && r.rutaId === rutaAsociadaId);
    if (!reserva) {
        showToast('No se encontró la reserva', 'error', 'Error');
        return;
    }

    // Buscar el objeto ruta para obtener el nombre y cupos
    const rutaParticipante = data.rutas.find(r => r.id === reserva.rutaId);
    if (!rutaParticipante) {
        showToast('No se encontró la ruta asociada', 'error', 'Error');
        return;
    }

    const registrados = contarParticipantesReserva(lider, reserva.rutaId);
    const ocupadosRuta = calcularCuposOcupados(reserva.rutaId);
    const haySobreventaRuta = ocupadosRuta >= rutaParticipante.cupos;
    const disponiblesRuta = rutaParticipante.cupos - ocupadosRuta;

    // Lógica de Sobreventa
    if (registrados >= reserva.cantidad) {
        let mensaje = `El líder ${lider} ya tiene ${reserva.cantidad} personas registradas.\n\n`;

        if (haySobreventaRuta) {
            mensaje += `⚠️ La ruta "${rutaParticipante.nombre}" ya está sobrevendida (${ocupadosRuta}/${rutaParticipante.cupos}).\n\n`;
        } else if (disponiblesRuta <= 0) {
            mensaje += `⚠️ Agregar uno más causará sobreventa en la ruta.\n\n`;
        } else if (disponiblesRuta === 1) {
            mensaje += `⚠️ Solo queda 1 cupo disponible en la ruta.\n\n`;
        }

        mensaje += `¿Deseas agregar un cupo extra a la reserva y registrar a esta persona?`;

        const agregarCupo = await confirmarAccion(mensaje, 'peligro');
        if (agregarCupo) {
            const nuevaCantidad = reserva.cantidad + 1;
            const { error } = await db
                .from('reservas')
                .update({ cantidad: nuevaCantidad })
                .eq('lider', lider)
                .eq('ruta_id', reserva.rutaId); // Usamos ID
            
            if (error) {
                showToast('Error al actualizar cupos', 'error');
                return;
            }
            await saveData(true); // Recarga silenciosa
        } else {
            return; // Cancelado por usuario
        }
    } else if (haySobreventaRuta) {
        const continuar = await confirmarAccion(
            `La ruta "${rutaParticipante.nombre}" ya está sobrevendida.\n¿Continuar?`, 'peligro'
        );
        if (!continuar) return;
    }

    // Verificar duplicados (usando ID)
    const existe = data.participantes.find(p => 
        p.nombre.toLowerCase() === nombreCompleto.toLowerCase() && 
        p.lider === lider &&
        (p.rutaId === reserva.rutaId || p.ruta_id === reserva.rutaId)
    );
    if (existe) { 
        showToast('Esta persona ya está registrada en esta reserva', 'warning', 'Duplicado'); 
        return; 
    }

    try {
        showLoader('Guardando...');
        
        // Insertar participante
        // AQUÍ ESTABA EL ERROR: Usamos rutaParticipante.nombre
        const { error: errorParticipante } = await db
            .from('participantes')
            .insert([{
                nombre: nombreCompleto,
                lider,
                ruta_id: reserva.rutaId,      // UUID Correcto
                ruta_nombre: rutaParticipante.nombre, // Nombre Correcto (antes daba error)
                asiste: false
            }]);
        if (errorParticipante) throw errorParticipante;

        // Registrar pago opcional (con cuposPagados para que se refleje en la card de cupos pagados)
        if (monto > 0) {
            const enDolares = document.getElementById('participanteEnDolares')?.checked || false;
            const cuposPagados = parseInt(document.getElementById('participanteCuposPagados')?.value, 10);
            const cupos = (Number.isFinite(cuposPagados) && cuposPagados >= 0) ? cuposPagados : (enDolares ? 0 : 1);
            const pagosActuales = reserva.pagos || [];
            pagosActuales.push({
                monto: monto,
                referencia: referencia || 'Pago al agregar persona',
                fecha: new Date().toISOString(),
                enDolares: enDolares,
                cuposPagados: cupos
            });
            
            const montoPagadoBs = pagosActuales
                .filter(p => !p.enDolares)
                .reduce((sum, p) => sum + p.monto, 0);
            
            await db.from('reservas').update({ 
                pagos: pagosActuales,
                monto_pagado: montoPagadoBs
            }).eq('lider', lider).eq('ruta_id', reserva.rutaId);
        }

        // Limpiar y cerrar
        document.getElementById('participanteNombreCompleto').value = '';
        document.getElementById('participanteMonto').value = '';
        const elCupos = document.getElementById('participanteCuposPagados');
        if (elCupos) elCupos.value = '1';
        document.getElementById('participanteReferencia').value = '';
        if (document.getElementById('participanteEnDolares')) document.getElementById('participanteEnDolares').checked = false;
        
        closeModal('modalNuevoParticipante');
        await saveData(true);
        renderAll();
        
        const msg = monto > 0 ? 'Persona y pago registrados exitosamente' : 'Persona registrada exitosamente';
        showToast(msg, 'success');
    } catch (error) {
        console.error(error);
        showToast('Error: ' + error.message, 'error');
    } finally {
        hideLoader();
    }
}

// AGREGAR PERSONA RÁPIDA DESDE CARD DE RESERVA
async function agregarPersonaRapida(lider, ruta) {
    const reserva = data.reservas.find(r => r.lider === lider && r.rutaId === ruta);
    if (!reserva) {
        showToast('No se encontró la reserva', 'error', 'Error');
        return;
    }

    // Reutilizar el mismo flujo que abrirAgregarPersonaAReserva
    abrirAgregarPersonaAReserva(lider, ruta);
}


        function toggleReferenciaNuevaReserva() {
            const enDolares = document.getElementById('reservaEnDolares')?.checked || false;
            const grupo = document.getElementById('grupoReferenciaPagoNuevaReserva');
            if (grupo) grupo.style.display = enDolares ? 'none' : 'block';
        }

        /** Toggle Bs / $ efectivo en formulario de pago: muestra/oculta campos y referencia */
        function toggleTipoPago(tipo) {
            const camposBs = document.getElementById('camposBsPago');
            const camposDolares = document.getElementById('camposDolaresPago');
            const grupoRef = document.getElementById('grupoReferenciaPagoDetalle');
            if (!camposBs || !camposDolares) return;
            if (tipo === 'bs') {
                camposBs.style.display = 'block';
                camposDolares.style.display = 'none';
                if (grupoRef) grupoRef.style.display = 'block';
            } else {
                camposBs.style.display = 'none';
                camposDolares.style.display = 'block';
                if (grupoRef) grupoRef.style.display = 'none';
            }
        }

        /** Lee el formulario de pago (Bs/$) y llama a actualizarPagos */
        function registrarPagoConTipo(lider, rutaId) {
            const tipoBs = (document.querySelector('input[name="tipoPago"]:checked') || {}).value === 'bs';
            const referencia = (document.getElementById('nuevoPagoReferencia') || {}).value.trim() || '';
            if (tipoBs) {
                const monto = parseFloat((document.getElementById('nuevoPagoMontoBs') || {}).value);
                const cupos = parseInt((document.getElementById('nuevoPagoCupos') || {}).value, 10) || 0;
                if (!monto || monto < 0) {
                    showToast('Ingresa un monto en Bs válido', 'warning', 'Monto Inválido');
                    return;
                }
                actualizarPagos(lider, rutaId, 'bs', monto, cupos, referencia);
            } else {
                const monto = parseFloat((document.getElementById('nuevoPagoMontoDolares') || {}).value);
                const cupos = parseInt((document.getElementById('nuevoPagoCuposDolares') || {}).value, 10) || 0;
                if (!monto || monto < 0) {
                    showToast('Ingresa un monto en $ válido', 'warning', 'Monto Inválido');
                    return;
                }
                actualizarPagos(lider, rutaId, 'dolares', monto, cupos, referencia);
            }
        }

        // ACTUALIZAR PAGOS (con cuposPagados: Bs = cupos, $ = 0)
        async function actualizarPagos(lider, rutaId, tipoPago, monto, cupos, referencia) {
            const reserva = data.reservas.find(r => r.lider === lider && r.rutaId === rutaId);
            if (!reserva) return;
            if (monto == null || monto < 0) {
                showToast('Ingresa un monto válido', 'warning', 'Monto Inválido');
                return;
            }
            const enDolares = tipoPago === 'dolares';
            const pago = {
                monto: parseFloat(monto),
                referencia: referencia || '',
                fecha: new Date().toISOString(),
                enDolares: enDolares,
                cuposPagados: parseInt(cupos, 10) || 0
            };
            try {
                const pagosActuales = reserva.pagos || [];
                pagosActuales.push(pago);
                const montoPagadoBs = pagosActuales
                    .filter(p => !p.enDolares)
                    .reduce((sum, p) => sum + (p.monto || 0), 0);
                const { error } = await db
                    .from('reservas')
                    .update({ pagos: pagosActuales, monto_pagado: montoPagadoBs })
                    .eq('lider', lider)
                    .eq('ruta_id', reserva.rutaId);
                if (error) throw error;
                // Limpiar formulario
                const elBs = document.getElementById('nuevoPagoMontoBs');
                const elCupos = document.getElementById('nuevoPagoCupos');
                const elDol = document.getElementById('nuevoPagoMontoDolares');
                const elCuposDol = document.getElementById('nuevoPagoCuposDolares');
                const elRef = document.getElementById('nuevoPagoReferencia');
                if (elBs) elBs.value = '';
                if (elCupos) elCupos.value = '';
                if (elDol) elDol.value = '';
                if (elCuposDol) elCuposDol.value = '1';
                if (elRef) elRef.value = '';
                await saveData(true);
                renderReservas();
                renderRutas();
                verDetalleReserva(lider, reserva.rutaId);
                const simbolo = enDolares ? '$' : 'Bs';
                showToast(`Pago de ${simbolo} ${monto.toLocaleString()} registrado`, 'success', 'Éxito');
            } catch (error) {
                console.error('Error:', error);
                showToast('Error al registrar el pago: ' + error.message, 'error', 'Error');
            }
        }

        // ========== ABONADOS (saldo en € por líder) ==========
        async function obtenerSaldoLider(lider) {
            try {
                const { data, error } = await db.from('abonados').select('saldo_euros').eq('lider', lider).single();
                if (error && error.code !== 'PGRST116') throw error;
                return data ? parseFloat(data.saldo_euros || 0) : 0;
            } catch (e) {
                console.error('Error obteniendo saldo:', e);
                return 0;
            }
        }

        async function registrarMovimientoAbono({ lider, tipo, monto_euros, descripcion, referencia, ruta_id, reserva_id }) {
            let { data: abonado, error: errorAbonado } = await db.from('abonados').select('*').eq('lider', lider).single();
            if (errorAbonado && errorAbonado.code === 'PGRST116') {
                const { data: nuevo, error: errorCrear } = await db.from('abonados').insert({ lider: lider, saldo_euros: 0, ultima_actualizacion: new Date().toISOString() }).select().single();
                if (errorCrear) throw errorCrear;
                abonado = nuevo;
            } else if (errorAbonado) throw errorAbonado;

            const saldoAntes = parseFloat(abonado.saldo_euros || 0);
            const monto = parseFloat(monto_euros);
            const saldoDespues = saldoAntes + monto;

            const { error: errorUpdate } = await db.from('abonados').update({ saldo_euros: saldoDespues, ultima_actualizacion: new Date().toISOString() }).eq('id', abonado.id);
            if (errorUpdate) throw errorUpdate;

            const { error: errorMov } = await db.from('movimientos_abonos').insert({
                abonado_id: abonado.id,
                tipo: tipo,
                monto_euros: Math.abs(monto),
                saldo_antes: saldoAntes,
                saldo_despues: saldoDespues,
                descripcion: descripcion || null,
                referencia: referencia || null,
                ruta_id: ruta_id || null,
                reserva_id: reserva_id || null,
                fecha: new Date().toISOString(),
                usuario: 'admin'
            });
            if (errorMov) throw errorMov;
            return { abonado, saldoDespues };
        }

        async function cargarAbonadoManual(lider, saldoEuros, notas) {
            try {
                const saldo = parseFloat(saldoEuros);
                if (!lider || isNaN(saldo) || saldo <= 0) {
                    showToast('Líder y saldo positivo requeridos', 'warning');
                    return;
                }
                const liderTrim = lider.trim();
                const { data: existente } = await db.from('abonados').select('*').eq('lider', liderTrim).single();
                let abonado;
                let saldoAntes, saldoDespues, descripcion, referencia;
                if (existente) {
                    saldoAntes = parseFloat(existente.saldo_euros || 0);
                    saldoDespues = saldoAntes + saldo;
                    const { data: updated, error } = await db.from('abonados').update({
                        saldo_euros: saldoDespues,
                        notas: (notas || '').trim() || existente.notas,
                        ultima_actualizacion: new Date().toISOString()
                    }).eq('id', existente.id).select().single();
                    if (error) throw error;
                    abonado = updated;
                    descripcion = 'Carga de saldo';
                    referencia = 'CARGA';
                } else {
                    saldoAntes = 0;
                    saldoDespues = saldo;
                    const { data: nuevo, error } = await db.from('abonados').insert({
                        lider: liderTrim,
                        saldo_euros: saldo,
                        notas: (notas || '').trim() || null,
                        ultima_actualizacion: new Date().toISOString()
                    }).select().single();
                    if (error) throw error;
                    abonado = nuevo;
                    descripcion = 'Carga inicial desde notas';
                    referencia = 'INICIAL';
                }
                await db.from('movimientos_abonos').insert({
                    abonado_id: abonado.id,
                    tipo: 'carga',
                    monto_euros: saldo,
                    saldo_antes: saldoAntes,
                    saldo_despues: saldoDespues,
                    descripcion: descripcion,
                    referencia: referencia,
                    usuario: 'admin',
                    fecha: new Date().toISOString()
                });
                showToast(`✅ ${liderTrim}: €${saldo.toFixed(2)} cargados`, 'success');
                if (typeof renderAbonados === 'function') renderAbonados();
                closeModal('modalCargaAbonados');
                return data;
            } catch (err) {
                console.error('Error cargando abonado:', err);
                showToast('❌ Error: ' + (err.message || 'al cargar abonado'), 'error');
            }
        }

        function cargarAbonadoManualDesdeModal() {
            const lider = (document.getElementById('inputLiderAbono')?.value || '').trim();
            const saldo = document.getElementById('inputSaldoEuros')?.value;
            const notas = (document.getElementById('inputNotasAbono')?.value || '').trim();
            cargarAbonadoManual(lider, saldo, notas);
        }

        function abrirModalNuevoAbono() {
            const elLider = document.getElementById('inputLiderAbono');
            const elSaldo = document.getElementById('inputSaldoEuros');
            const elNotas = document.getElementById('inputNotasAbono');
            if (elLider) elLider.value = '';
            if (elSaldo) elSaldo.value = '';
            if (elNotas) elNotas.value = '';
            openModal('modalCargaAbonados');
        }

        function abrirModalCargarSaldo(lider) {
            const elLider = document.getElementById('inputLiderAbono');
            if (elLider) elLider.value = lider || '';
            document.getElementById('inputSaldoEuros').value = '';
            document.getElementById('inputNotasAbono').value = '';
            openModal('modalCargaAbonados');
        }

        /** Actualiza la etiqueta "Cupos a pagar con saldo" según el valor en usarSaldoEuros y precio por cupo. */
        function actualizarCuposConSaldoLabel(precioCupo) {
            const saldoUsar = parseFloat(document.getElementById('usarSaldoEuros')?.value) || 0;
            const cupos = precioCupo > 0 ? Math.floor(saldoUsar / precioCupo) : 0;
            const el = document.getElementById('cuposConSaldoLabel');
            if (el) el.textContent = cupos;
        }

        async function registrarPagoConSaldoDesdeModal(lider, rutaId) {
            const saldoEuros = parseFloat(document.getElementById('usarSaldoEuros')?.value) || 0;
            const referencia = (document.getElementById('nuevoPagoReferencia')?.value || '').trim();

            const saldoDisponible = await obtenerSaldoLider(lider);
            if (saldoEuros > saldoDisponible) {
                showToast(`Saldo insuficiente. Disponible: €${saldoDisponible.toFixed(2)}`, 'error');
                return;
            }
            if (saldoEuros <= 0) {
                showToast('Indica el saldo en € a usar', 'warning');
                return;
            }

            const reserva = data.reservas.find(r => r.lider === lider && r.rutaId === rutaId);
            const ruta = data.rutas.find(r => r.id === rutaId);
            const precioCupo = ruta ? (ruta.precioEuros || 0) : 0;
            const cuposConSaldo = precioCupo > 0 ? Math.floor(saldoEuros / precioCupo) : 0;
            if (cuposConSaldo < 1) {
                showToast('El saldo no alcanza para un cupo (precio/cupo: €' + (precioCupo || 0) + ')', 'warning');
                return;
            }

            try {
                const { abonado, saldoDespues } = await registrarMovimientoAbono({
                    lider: lider,
                    tipo: 'uso',
                    monto_euros: -saldoEuros,
                    descripcion: 'Pago para ruta',
                    referencia: referencia || ('Ruta ' + rutaId),
                    ruta_id: rutaId
                });

                if (saldoDespues <= 0 && abonado && abonado.id) {
                    await db.from('abonados').delete().eq('id', abonado.id);
                }

                const pagoConSaldo = {
                    monto: 0,
                    cuposPagados: cuposConSaldo,
                    enDolares: false,
                    saldo_usado: saldoEuros,
                    referencia: referencia || 'Pago con saldo',
                    fecha: new Date().toISOString()
                };
                const pagosActuales = (reserva.pagos || []).slice();
                pagosActuales.push(pagoConSaldo);
                const montoPagadoBs = pagosActuales
                    .filter(p => !p.enDolares && !(p.saldo_usado > 0))
                    .reduce((sum, p) => sum + (p.monto || 0), 0);

                await db.from('reservas')
                    .update({
                        pagos: pagosActuales,
                        monto_pagado: montoPagadoBs,
                        abonado_euros: (reserva.abonado_euros || 0) + saldoEuros,
                        pagado_con_abono: true
                    })
                    .eq('lider', lider)
                    .eq('ruta_id', rutaId);

                if (document.getElementById('usarSaldoEuros')) document.getElementById('usarSaldoEuros').value = '';
                actualizarCuposConSaldoLabel(precioCupo);
                await saveData(true);
                renderReservas();
                renderRutas();
                if (typeof renderAbonados === 'function') renderAbonados();
                verDetalleReserva(lider, rutaId);
                showToast(`✅ Pago con saldo: ${cuposConSaldo} cupo${cuposConSaldo !== 1 ? 's' : ''} (€${saldoEuros.toFixed(2)})`, 'success');
            } catch (err) {
                console.error('Error en pago con saldo:', err);
                showToast('❌ Error al procesar pago', 'error');
            }
        }

        async function abonarReservaCancelada(reservaId, porcentaje) {
            const reserva = data.reservas.find(r => r.id === reservaId);
            if (!reserva) { showToast('Reserva no encontrada', 'error'); return; }
            const ruta = data.rutas.find(r => r.id === reserva.rutaId);
            const precioCupo = ruta ? (ruta.precioEuros || 0) : 0;
            const totalEuros = (reserva.cantidad || 0) * precioCupo;
            const eurosAAbonar = totalEuros * ((porcentaje || 100) / 100);

            const ok = await confirmarAccion(
                `¿Abonar €${eurosAAbonar.toFixed(2)} a ${reserva.lider}?\n\nRuta: ${ruta ? ruta.nombre : 'N/A'}\nCupos: ${reserva.cantidad}\nPrecio/cupo: €${precioCupo}\nTotal: €${totalEuros}\nPorcentaje: ${porcentaje || 100}%`,
                'pregunta'
            );
            if (!ok) return;

            try {
                await registrarMovimientoAbono({
                    lider: reserva.lider,
                    tipo: 'carga',
                    monto_euros: eurosAAbonar,
                    descripcion: `Abono por cancelación: ${ruta ? ruta.nombre : ''}`,
                    referencia: 'RES-' + reservaId,
                    ruta_id: reserva.rutaId,
                    reserva_id: reservaId
                });
                const { error: errPart } = await db
                    .from('participantes')
                    .delete()
                    .eq('lider', reserva.lider)
                    .eq('ruta_id', reserva.rutaId);
                if (errPart) throw errPart;
                const { error: errRes } = await db
                    .from('reservas')
                    .delete()
                    .eq('id', reservaId);
                if (errRes) throw errRes;
                closeModal('modalDetalleReserva');
                await saveData(true);
                updateSelects();
                renderReservas();
                renderRutas();
                if (typeof renderParticipantes === 'function') renderParticipantes();
                if (typeof renderAbonados === 'function') renderAbonados();
                showToast(`✅ €${eurosAAbonar.toFixed(2)} abonados a ${reserva.lider}. Reserva y participantes eliminados.`, 'success');
            } catch (err) {
                console.error('Error abonando:', err);
                showToast('❌ Error al abonar', 'error');
            }
        }

        // ELIMINAR PAGO INDIVIDUAL (con confirmación)
        async function eliminarPago(lider, rutaId, index) {
            try {
                const reserva = data.reservas.find(r => r.lider === lider && r.rutaId === rutaId);
                if (!reserva) {
                    showToast('No se encontró la reserva', 'error', 'Error');
                    return;
                }

                const pagosActuales = Array.isArray(reserva.pagos) ? [...reserva.pagos] : [];
                if (index < 0 || index >= pagosActuales.length) {
                    showToast('Pago no encontrado', 'error', 'Error');
                    return;
                }

                const pago = pagosActuales[index];
                const simbolo = pago.enDolares ? '$' : 'Bs';
                const mensaje =
                    `Eliminar este pago?\n\n` +
                    `• Monto: ${simbolo} ${pago.monto.toLocaleString()}\n` +
                    (pago.referencia ? `• Ref: ${pago.referencia}\n` : '') +
                    `• Líder: ${lider}`;

                const ok = await confirmarAccion(mensaje, 'eliminar');
                if (!ok) return;

                // Eliminar el pago por índice
                pagosActuales.splice(index, 1);

                // Recalcular monto_pagado solo con pagos en Bs
                const montoPagadoBs = pagosActuales
                    .filter(p => !p.enDolares)
                    .reduce((sum, p) => sum + (p.monto || 0), 0);

                const { error } = await db
                    .from('reservas')
                    .update({
                        pagos: pagosActuales,
                        monto_pagado: montoPagadoBs
                    })
                    .eq('lider', lider)
                    .eq('ruta_id', rutaId);

                if (error) throw error;

                await saveData(true); // Recarga silenciosa
                renderReservas();
                renderRutas();
                verDetalleReserva(lider, rutaId); // Refrescar modal

                showToast('Pago eliminado correctamente', 'success', 'Éxito');
            } catch (error) {
                console.error('Error al eliminar pago:', error);
                showToast('Error al eliminar el pago: ' + error.message, 'error', 'Error');
            }
        }

        // ACTUALIZAR CANTIDAD DE CUPOS DE UNA RESERVA
        async function actualizarCantidadReserva(lider, rutaId, nuevaCantidad) {
            if (!nuevaCantidad || nuevaCantidad < 1 || nuevaCantidad > 100) {
                showToast('La cantidad de cupos debe estar entre 1 y 100', 'warning', 'Validación');
                return;
            }
            
            const reserva = data.reservas.find(r => r.lider === lider && r.rutaId === rutaId);
            if (!reserva) {
                showToast('No se encontró la reserva', 'error', 'Error');
                return;
            }

            const cantidadActual = getCuposReserva(reserva);
            
            // Verificar si hay cambio
            if (cantidadActual === nuevaCantidad) {
                showToast('No hay cambios en la cantidad', 'info', 'Información');
                return;
            }
            
            // Obtener la ruta para validar cupos disponibles
            const ruta = data.rutas.find(r => r.id === rutaId);
            if (!ruta) {
                showToast('No se encontró la información de la ruta', 'error', 'Error');
                return;
            }
            
            // Calcular cupos ocupados actuales (sin contar esta reserva)
            const ocupadosSinEstaReserva = calcularCuposOcupados(rutaId) - cantidadActual;
            const nuevosOcupados = ocupadosSinEstaReserva + nuevaCantidad;
            const disponibles = ruta.cupos - nuevosOcupados;
            
            // Advertencia si hay sobreventa
            if (nuevosOcupados > ruta.cupos) {
                const continuar = await confirmarAccion(
                    `⚠️ Esta acción creará sobreventa.\n\n` +
                    `Cupos de la ruta: ${ruta.cupos}\n` +
                    `Cupos ocupados (sin esta reserva): ${ocupadosSinEstaReserva}\n` +
                    `Nueva cantidad a reservar: ${nuevaCantidad}\n` +
                    `Total después del cambio: ${nuevosOcupados}/${ruta.cupos}\n\n` +
                    `¿Deseas continuar?`,
                    'peligro'
                );
                if (!continuar) {
                    // Restaurar el valor original en el input
                    document.getElementById('editarCantidadReserva').value = cantidadActual;
                    return;
                }
            }
            
            try {
                const cantidadColumn = getCantidadColumnName(reserva);
                const updatePayload = {};
                updatePayload[cantidadColumn] = nuevaCantidad;
                const { error } = await db
                    .from('reservas')
                    .update(updatePayload)
                    .eq('lider', lider)
                    .eq('ruta_id', rutaId);
                
                if (error) throw error;
                
                // Actualizar en memoria local
                reserva[cantidadColumn] = nuevaCantidad;
                reserva.cantidad = nuevaCantidad; // mantener campo normalizado usado por el frontend
                
                // Recargar datos para actualizar cálculos de cupos en toda la app
                await loadData();
                
                // Refrescar el modal para mostrar el nuevo valor
                verDetalleReserva(lider, rutaId);
                
                showToast(`Cantidad de cupos actualizada a ${nuevaCantidad}`, 'success', 'Éxito');
            } catch (error) {
                console.error('Error al actualizar cantidad de cupos:', error);
                showToast('Error al actualizar la cantidad: ' + error.message, 'error', 'Error');
                // Restaurar el valor original en el input
                document.getElementById('editarCantidadReserva').value = cantidadActual;
            }
        }

        /** Genera HTML del resumen de pagos (cupos pagados, € recibidos/esperados, Bs/$, barra) */
        function crearResumenPagos(reserva, ruta) {
            const { totalBs, totalDolares, cuposPagados } = calcularTotalesPorMoneda(reserva);
            const precioCupo = ruta ? (ruta.precioEuros || 0) : 0;
            const cuposReservados = reserva.cantidad || 0;
            const eurosRecibidos = cuposPagados * precioCupo;
            const eurosEsperados = cuposReservados * precioCupo;
            const pendiente = eurosEsperados - eurosRecibidos;
            const porcentaje = cuposReservados > 0 ? (cuposPagados / cuposReservados * 100) : 0;
            return `
                <div class="payment-item">
                    <div style="font-weight: 700; margin-bottom: 12px;">💰 RESUMEN DE PAGOS</div>
                    <div style="margin-bottom: 16px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                            <span style="font-size: 13px;">Cupos pagados</span>
                            <span style="font-size: 13px; font-weight: 600;">${cuposPagados}/${cuposReservados} (${porcentaje.toFixed(0)}%)</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${porcentaje}%"></div>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Precio/cupo</div>
                            <div style="font-size: 16px; font-weight: 800;">${precioCupo}€</div>
                        </div>
                        <div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Total esperado</div>
                            <div style="font-size: 16px; font-weight: 800;">${eurosEsperados}€</div>
                        </div>
                        <div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Total recibido</div>
                            <div style="font-size: 16px; font-weight: 800; color: var(--success);">${eurosRecibidos}€</div>
                        </div>
                        <div>
                            <div style="font-size: 11px; color: var(--text-secondary);">Pendiente</div>
                            <div style="font-size: 16px; font-weight: 800; color: var(--warning);">${pendiente}€</div>
                        </div>
                    </div>
                    <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div>
                                <div style="font-size: 11px; color: var(--text-secondary);">Bs recibidos</div>
                                <div style="font-size: 16px; font-weight: 800; color: var(--success);">Bs ${totalBs.toLocaleString()}</div>
                            </div>
                            ${totalDolares > 0 ? `
                            <div>
                                <div style="font-size: 11px; color: var(--text-secondary);">$ efectivo</div>
                                <div style="font-size: 16px; font-weight: 800; color: #f59e0b;">$${totalDolares.toLocaleString()}</div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        // VER DETALLE RESERVA
        function verDetalleReserva(lider, rutaId) {
            const reserva = data.reservas.find(r => r.lider === lider && r.rutaId === rutaId);
            if (!reserva) return;
            const ruta = data.rutas.find(r => r.id === reserva.rutaId);
            const precioCupo = ruta ? (ruta.precioEuros || 0) : 0;

            const historialPagos = (reserva.pagos || []).map((pago, index) => {
                const esSaldo = pago.saldo_usado != null && pago.saldo_usado > 0;
                const esDolares = !esSaldo && (pago.enDolares || false);
                const simbolo = esSaldo ? '€ saldo' : (esDolares ? '$' : 'Bs');
                const color = esSaldo ? '#06b6d4' : (esDolares ? '#f59e0b' : 'var(--success)');
                const cuposNum = pago.cuposPagados || 0;
                const cuposTexto = esSaldo ? ` (${cuposNum} cupo${cuposNum !== 1 ? 's' : ''})` : (esDolares ? (cuposNum > 0 ? ` (${cuposNum} cupo${cuposNum !== 1 ? 's' : ''} = ${cuposNum * precioCupo}€)` : '') : (` (${cuposNum} cupo${cuposNum !== 1 ? 's' : ''} = ${cuposNum * precioCupo}€)`));
                const montoTexto = esSaldo ? `€${(pago.saldo_usado || 0).toFixed(2)}` : (esDolares ? '$' + (pago.monto || 0).toLocaleString() : 'Bs ' + (pago.monto || 0).toLocaleString());
                const migrado = !esSaldo && pago._cuposCalculado ? ' <span style="font-size: 10px; color: var(--text-secondary);">(calculado automáticamente)</span>' : '';
                return `
                <div style="padding: 12px; background: rgba(118, 200, 147, 0.1); border-radius: 12px; margin-bottom: 8px; border: 1px solid var(--border);">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 8px;">
                        <div style="flex: 1;">
                            <div style="font-weight: 700; color: ${color}; margin-bottom: 4px;">
                                ${montoTexto} ${simbolo}${cuposTexto}${migrado}
                            </div>
                            ${pago.referencia ? `<div style="font-size: 12px; color: var(--accent); margin-bottom: 4px;">📎 Ref: ${pago.referencia}</div>` : ''}
                            <div style="font-size: 12px; color: var(--text-secondary);">${new Date(pago.fecha).toLocaleDateString('es-ES', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' })}</div>
                        </div>
                        <button class="person-delete-btn" title="Eliminar pago" onclick="eliminarPago('${lider}', '${reserva.rutaId}', ${index})">🗑️</button>
                    </div>
                </div>
            `;
            }).join('');

            const html = `
                <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 16px;">Ruta: ${ruta ? ruta.nombre : 'N/A'}</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                    <div>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Cupos Reservados</div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <input type="number" id="editarCantidadReserva" value="${reserva.cantidad}" min="1" max="100"
                                   style="width: 80px; padding: 8px; background: rgba(255,255,255,0.1); border: 2px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 18px; font-weight: 800; text-align: center;"
                                   onchange="actualizarCantidadReserva('${lider}', '${reserva.rutaId}', parseInt(this.value))">
                            <button class="btn btn-success" style="padding: 6px 12px; font-size: 12px; min-height: auto;"
                                    onclick="actualizarCantidadReserva('${lider}', '${reserva.rutaId}', parseInt(document.getElementById('editarCantidadReserva').value))" title="Guardar cambios">💾</button>
                        </div>
                    </div>
                    <div>
                        <div style="font-size: 12px; color: var(--text-secondary);">Precio Referencial</div>
                        <div style="font-size: 20px; font-weight: 800; color: var(--text-primary);">${precioCupo}€</div>
                    </div>
                </div>
                <div class="divider"></div>
                ${crearResumenPagos(reserva, ruta)}
                ${(reserva.pagos && reserva.pagos.length > 0) ? `
                    <div style="margin-top: 20px;">
                        <div style="font-weight: 700; margin-bottom: 12px; color: var(--text-primary);">📝 Historial de Pagos</div>
                        ${historialPagos}
                    </div>
                ` : ''}
                <div class="divider"></div>
                <div style="margin-top: 20px; padding: 16px; background: rgba(118, 200, 147, 0.1); border-radius: 12px;">
                    <div style="font-weight: 700; margin-bottom: 12px;">💵 Registrar Nuevo Pago</div>
                    <div style="margin-bottom: 16px; padding: 12px; background: rgba(59, 130, 246, 0.1); border-radius: 12px; border: 1px solid rgba(59, 130, 246, 0.3);">
                        <div style="font-size: 13px; font-weight: 700; color: #3b82f6; margin-bottom: 8px;">💰 Saldo disponible: <span id="saldoDisponibleLider">€0.00</span></div>
                        <div class="form-group">
                            <label class="form-label" style="font-size: 12px;">Usar saldo (€)</label>
                            <input type="number" id="usarSaldoEuros" class="form-input" placeholder="0.00" step="0.01" min="0" oninput="actualizarCuposConSaldoLabel(${precioCupo})">
                        </div>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 8px;">Cupos a pagar con saldo: <strong id="cuposConSaldoLabel">0</strong> (precio/cupo: ${precioCupo}€)</div>
                        <button type="button" class="btn btn-primary" style="margin-top: 12px;" onclick="registrarPagoConSaldoDesdeModal('${lider}', '${reserva.rutaId}')">✅ Registrar con saldo</button>
                    </div>
                    <div style="display: flex; gap: 16px; margin-bottom: 16px;">
                        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                            <input type="radio" name="tipoPago" value="bs" checked onchange="toggleTipoPago('bs')">
                            <span>Bs (cupos)</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                            <input type="radio" name="tipoPago" value="dolares" onchange="toggleTipoPago('dolares')">
                            <span>$ Efectivo</span>
                        </label>
                    </div>
                    <div id="camposBsPago">
                        <div class="form-group">
                            <label class="form-label">Monto en Bs</label>
                            <input type="number" id="nuevoPagoMontoBs" class="form-input" placeholder="Ej: 8000" step="0.01" min="0" inputmode="decimal">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Cupos pagados con este monto</label>
                            <input type="number" id="nuevoPagoCupos" class="form-input" placeholder="Ej: 2" min="1" step="1">
                        </div>
                    </div>
                    <div id="camposDolaresPago" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">Monto en $ efectivo</label>
                            <input type="number" id="nuevoPagoMontoDolares" class="form-input" placeholder="Ej: 100" step="0.01" min="0" inputmode="decimal">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Cupos pagados con este monto</label>
                            <input type="number" id="nuevoPagoCuposDolares" class="form-input" placeholder="Ej: 2" min="0" step="1" value="1">
                        </div>
                    </div>
                    <div id="grupoReferenciaPagoDetalle" class="form-group">
                        <label class="form-label">📎 Referencia (Opcional)</label>
                        <input type="text" id="nuevoPagoReferencia" class="form-input" placeholder="Número de referencia" inputmode="numeric">
                    </div>
                    <button class="btn btn-success" onclick="registrarPagoConTipo('${lider}', '${reserva.rutaId}')">✅ Registrar Pago</button>
                </div>
                <button type="button" class="btn btn-outline" style="margin-top: 8px; width: 100%; font-size: 12px;" onclick="abonarReservaCancelada('${reserva.id}', 100)">💰 Abonar reserva cancelada (no asistió)</button>
                <button class="btn btn-outline" style="margin-top: 12px; width: 100%;" onclick="closeModal('modalDetalleReserva')">Cerrar</button>
            `;
            document.getElementById('detalleReservaContent').innerHTML = html;
            openModal('modalDetalleReserva');
            obtenerSaldoLider(lider).then(saldo => {
                const el = document.getElementById('saldoDisponibleLider');
                if (el) el.textContent = '€' + saldo.toFixed(2);
            });
        }

        // COMPARTIR RESERVA POR WHATSAPP (robusto por ID; no lee del DOM)
        // Recibe el ID de la reserva para evitar ambigüedades cuando un líder tiene varias reservas
        function compartirReservaPorWhatsapp(reservaId) {
            // Constantes Unicode para emojis (evita problemas de codificación en URL)
            const eReserva = '\ud83d\udccb'; // 📋
            const eLider = '\ud83d\udc64'; // 👤
            const eRuta = '\ud83c\udfd4\ufe0f'; // 🏔️
            const eFecha = '\ud83d\udcc5'; // 📅
            const eCupos = '\ud83c\udfab'; // 🎫
            const ePrecio = '\ud83d\udcb0'; // 💰
            const eGente = '\ud83d\udc65'; // 👥
            const ePagos = '\ud83d\udcb5'; // 💵
            
            // Buscar la reserva específica por ID (sin depender del DOM)
            const reserva = (data.reservas || []).find(r => String(r.id) === String(reservaId));
            if (!reserva) {
                console.error('No se encontró la reserva para compartir. ID:', reservaId);
                showToast('No se encontró la reserva seleccionada', 'error', 'Error');
                return;
            }
            
            // Obtener datos de la ruta por ID
            const ruta = data.rutas.find(r => r.id === reserva.rutaId);
            if (!ruta) {
                console.error('No se encontró la ruta para la reserva. rutaId:', reserva.rutaId, 'reservaId:', reservaId);
                showToast('No se encontró la información de la ruta', 'error', 'Error');
                return;
            }
            
            // Participantes asociados a este líder y a esta ruta específica (por ID)
            const participantes = (data.participantes || []).filter(p => 
                p.lider === reserva.lider && 
                (p.rutaId === reserva.rutaId || p.ruta_id === reserva.rutaId)
            );
            
            // Totales por moneda (para mostrar pagos)
            const totalBs = (reserva.pagos || [])
                .filter(p => !p.enDolares)
                .reduce((sum, p) => sum + (p.monto || 0), 0);
            const totalUsd = (reserva.pagos || [])
                .filter(p => p.enDolares)
                .reduce((sum, p) => sum + (p.monto || 0), 0);
            
            // Formatear fecha de la ruta usando formatearFechaRuta para evitar timezone issues
            const fechaFormateada = formatearFechaRuta(ruta.fecha);
            
            // Construir mensaje con el formato solicitado (sin leer del DOM)
            let mensaje = `*${eReserva} RESERVA CONFIRMADA*\n\n`;
            mensaje += `${eLider} Líder: ${reserva.lider}\n`;
            mensaje += `${eRuta} Ruta: ${ruta.nombre}\n`;
            mensaje += `${eFecha} Fecha: ${fechaFormateada}\n`;
            mensaje += `${eCupos} Cupos Reservados: ${getCuposReserva(reserva)}\n`;
            mensaje += `${ePrecio} Precio REF: ${ruta.precioEuros || 0}€\n\n`;

            mensaje += `${eGente} Participantes:\n`;
            if (participantes.length > 0) {
                participantes.forEach(p => {
                    mensaje += `• ${p.nombre}\n`;
                });
            } else {
                mensaje += `• (sin participantes registrados)\n`;
            }

            mensaje += `\n${ePagos} Pagos:\n`;
            if (reserva.pagos && reserva.pagos.length > 0) {
                reserva.pagos.forEach((pago, index) => {
                    const simbolo = pago.enDolares ? '$' : 'Bs';
                    const fecha = new Date(pago.fecha).toLocaleDateString('es-ES', { 
                        day: 'numeric', 
                        month: 'short' 
                    });
                    mensaje += `${index + 1}. ${simbolo} ${pago.monto.toLocaleString()} - ${fecha}`;
                    if (pago.referencia) {
                        mensaje += ` (Ref: ${pago.referencia})`;
                    }
                    mensaje += `\n`;
                });
            } else {
                // Mantener el bloque aunque esté vacío, pero dar contexto mínimo
                mensaje += `• Bs ${Number(totalBs || 0).toLocaleString()}${totalUsd > 0 ? ` + $${Number(totalUsd || 0).toLocaleString()}` : ''}\n`;
            }
            
            const mensajeCodificado = encodeURIComponent(mensaje);
            const urlWhatsApp = 'https://wa.me/?text=' + mensajeCodificado;
            window.open(urlWhatsApp, '_blank');
            showToast('Abriendo WhatsApp...', 'info');
        }

        // Alias de compatibilidad: por si algún onclick antiguo sigue llamando a este nombre
        function compartirReservaWhatsApp(reservaId) {
            return compartirReservaPorWhatsapp(reservaId);
        }

        // AGREGAR función para abrir modal de agregar persona desde un card de reserva
function abrirAgregarPersonaAReserva(lider, nombreRuta) {
    closeModal('modalDetalleReserva');
    
    // Verificar que la reserva existe
    const reserva = data.reservas.find(r => r.lider === lider && r.rutaId === nombreRuta);
    if (!reserva) {
        showToast('No se encontró la reserva', 'error', 'Error');
        return;
    }
    
    // Asociar el formulario a este líder de reserva y a su ruta
    liderActualParaNuevoParticipante = lider;
    rutaActualParaNuevoParticipante = nombreRuta;
    
    // Limpiar campos del formulario
    document.getElementById('participanteNombreCompleto').value = '';
    document.getElementById('participanteMonto').value = '';
    document.getElementById('participanteReferencia').value = '';
    const participanteEnDolaresInput = document.getElementById('participanteEnDolares');
    if (participanteEnDolaresInput) participanteEnDolaresInput.checked = false;
    
    // Abrir el modal de nueva persona en reserva y enfocar el nombre
    openModal('modalNuevoParticipante');
    setTimeout(() => {
        document.getElementById('participanteNombreCompleto').focus();
    }, 50);
}

        /** Archiva una ruta (la mueve al historial). Usa ID para soportar nombres duplicados. */
        async function archivarRuta(idRuta) {
    const ruta = data.rutas.find(r => r.id === idRuta);
    if (!ruta) return;

    if (ruta.archivada) {
        showToast('Esta ruta ya está archivada', 'info', 'Información');
        return;
    }

    // Filtrar reservas por nombre de ruta (frontend sigue usando nombre de ruta)
    const reservas = data.reservas.filter(r => r.rutaId === ruta.id);
    const participantes = data.participantes.filter(p =>
        reservas.some(r => r.lider === p.lider)
    );

    const numeroRuta = ruta.numero ? `#${String(ruta.numero).padStart(4, '0')}` : '';
    const fechaFormateada = formatearFechaCorta(ruta.fecha);

    const mensaje =
        `Archivar ruta "${ruta.nombre}"?\n\n` +
        `${numeroRuta ? `• Número: ${numeroRuta}\n` : ''}` +
        `• Fecha: ${fechaFormateada}\n` +
        `• Cupos: ${ruta.cupos}\n` +
        `• Reservas activas: ${reservas.length}\n` +
        `• Personas registradas: ${participantes.length}\n\n` +
        `La ruta se moverá al historial y no aparecerá en la lista principal.`;

    const ok = await confirmarAccion(mensaje, 'archivar');
    if (!ok) return;

    try {
        // Usar ID en lugar de nombre para evitar conflictos con rutas con mismo nombre
        const { error } = await db
            .from('rutas')
            .update({ archivada: true })
            .eq('id', ruta.id);

        if (error) throw error;

        // Recargar datos sin loader (ya se mostró el modal de confirmación antes)
        await saveData(true);
        updateSelects();
        renderRutas();
        renderReservas();

        showToast('Ruta archivada exitosamente', 'success', 'Éxito');
    } catch (error) {
        console.error('Error al archivar ruta:', error);
        showToast('Error al archivar la ruta: ' + error.message, 'error', 'Error');
    }
}

        async function eliminarReserva(lider, rutaId) {
    // 🔥 CORRECCIÓN: El parámetro es rutaId (UUID), no nombreRuta
    const reserva = data.reservas.find(r => r.lider === lider && r.rutaId === rutaId);
    if (!reserva) return;

    // 🔥 CORRECCIÓN: Buscar ruta por ID para obtener el nombre
    const ruta = data.rutas.find(r => r.id === reserva.rutaId);
    if (!ruta) {
        showToast('No se encontró la ruta de la reserva', 'error', 'Error');
        return;
    }

    // Solo eliminar participantes de esta reserva específica (lider + ruta)
    // 🔥 CORRECCIÓN: Filtrar participantes por rutaId para garantizar integridad
    const participantes = data.participantes.filter(p => {
        return p.lider === lider && 
               (p.rutaId === reserva.rutaId || p.ruta_id === reserva.rutaId); // Por ID (preferido)
    });

    const mensaje =
        `Eliminar reserva de "${lider}"?\n\n` +
        `• Ruta: ${ruta ? ruta.nombre : 'N/A'}\n` +
        `• Cupos: ${reserva.cantidad}\n` +
        `• Personas registradas: ${participantes.length}\n\n` +
        `Esta acción NO se puede deshacer.`;

    const ok = await confirmarAccion(mensaje, 'eliminar');
    if (!ok) return;

    try {
        // 🔥 NUEVO: Eliminar de Supabase PRIMERO
        
        // 1. Eliminar participantes asociados a esta reserva específica
        // Verificar si el líder tiene otras reservas
        // 🔥 CORRECCIÓN: Comparar por rutaId, no por nombre
        const otrasReservas = data.reservas.filter(r => r.lider === lider && r.rutaId !== rutaId);
        
        if (participantes.length > 0) {
            if (otrasReservas.length > 0) {
                // El líder tiene otras reservas, no eliminar participantes (pertenecen a otras reservas)
            } else {
                // Es la única reserva del líder, eliminar todos sus participantes
                // 🔥 CORRECCIÓN: Eliminar solo participantes de esta ruta específica
                const { error: errorParticipantes } = await db
                    .from('participantes')
                    .delete()
                    .eq('lider', lider)
                    .eq('ruta_id', rutaId);
                    
                if (errorParticipantes) throw errorParticipantes;
            }
        }
        
        // 2. Eliminar la reserva específica (lider + ruta)
        // 🔥 CORRECCIÓN: Usar rutaId directamente
        const { error: errorReserva } = await db
            .from('reservas')
            .delete()
            .eq('lider', lider)
            .eq('ruta_id', rutaId);
            
        if (errorReserva) throw errorReserva;

        // 3. Recargar datos desde BD (sin loader para evitar parpadeo)
        await saveData(true);
        
        // 4. Actualizar vistas
        updateSelects();
        renderReservas();
        renderParticipantes();
        renderRutas();
        renderAsistencia();
        
        showToast('Reserva eliminada exitosamente', 'success', 'Éxito');
        
    } catch (error) {
        console.error('Error al eliminar reserva:', error);
        showToast('Error al eliminar la reserva: ' + error.message, 'error', 'Error');
    }
}


        async function eliminarParticipante(id) {
    const p = data.participantes.find(part => part.id === id);
    if (!p) return;

    const mensaje =
        `Eliminar a "${p.nombre}"?\n\n` +
        `• Líder: ${p.lider}\n` +
        `• Asistencia: ${p.asiste ? '✅ Presente' : '❌ Ausente'}`;

    const ok = await confirmarAccion(mensaje, 'eliminar');
    if (!ok) return;

    try {
        // 🔥 NUEVO: Eliminar de Supabase PRIMERO
        const { error } = await db
            .from('participantes')
            .delete()
            .eq('id', id);
            
        if (error) throw error;

        // Recargar datos desde BD (sin loader para evitar parpadeo)
        await saveData(true);
        
        // Actualizar vistas
        renderParticipantes();
        renderReservas();
        renderAsistencia();
        
        showToast('Persona eliminada exitosamente', 'success', 'Éxito');
        
    } catch (error) {
        console.error('Error al eliminar participante:', error);
        showToast('Error al eliminar la persona: ' + error.message, 'error', 'Error');
    }
}


        // ASISTENCIA (actualización granular sin parpadeo)
        async function toggleAsistenciaGranular(participanteId, cardId) {
            const participante = data.participantes.find(p => p.id === participanteId);
            if (!participante) return;

            misAccionesRecientes.add(participanteId);
            setTimeout(() => misAccionesRecientes.delete(participanteId), 3000);

            const nuevoEstado = !participante.asiste;
            participante.asiste = nuevoEstado;

            const checkbox = document.querySelector(`input.attendance-checkbox-compact[data-participante-id="${participanteId}"]`);
            if (checkbox) checkbox.checked = nuevoEstado;
            const nombreSpan = document.querySelector(`.attendance-item-compact[data-participante-id="${participanteId}"] .attendance-name-compact`);
            if (nombreSpan) nombreSpan.classList.toggle('checked', nuevoEstado);

            actualizarCardAsistencia(cardId);
            actualizarContadorCheckin();

            try {
                const { error } = await db
                    .from('participantes')
                    .update({ asiste: nuevoEstado })
                    .eq('id', participanteId);
                if (error) throw error;
            } catch (error) {
                participante.asiste = !nuevoEstado;
                if (checkbox) checkbox.checked = !nuevoEstado;
                if (nombreSpan) nombreSpan.classList.toggle('checked', !nuevoEstado);
                actualizarCardAsistencia(cardId);
                actualizarContadorCheckin();
                console.error('Error:', error);
                showToast('Error al actualizar la asistencia: ' + error.message, 'error', 'Error');
            }
        }

        /** Actualiza solo los datos visibles de un card (contador, barra, %, lista si expandido) */
        function actualizarCardAsistencia(cardId) {
            const card = document.getElementById(cardId);
            if (!card) return;
            const lider = card.dataset.lider;
            const rutaId = card.dataset.rutaId;
            if (!lider || !rutaId) return;

            const participantes = obtenerParticipantesReserva(lider, rutaId);
            const presentes = participantes.filter(p => p.asiste).length;
            const total = participantes.length;
            const porcentaje = total > 0 ? Math.round((presentes / total) * 100) : 0;

            const contador = card.querySelector('.contador-presentes');
            if (contador) contador.textContent = `📊 ${presentes}/${total} presentes`;

            const barra = card.querySelector('.attendance-progress-fill');
            if (barra) {
                barra.style.width = `${porcentaje}%`;
                barra.style.background = porcentaje >= 80 ? 'var(--success)' : porcentaje >= 50 ? '#fbbf24' : 'var(--danger)';
            }

            const porcentajeEl = card.querySelector('.porcentaje-presentes');
            if (porcentajeEl) porcentajeEl.textContent = `${porcentaje}%`;

            const expanded = card.querySelector('.asistencia-expanded');
            if (expanded && expanded.style.display !== 'none') {
                actualizarListaParticipantesCard(cardId, participantes);
            }
        }

        /** Rellena la lista de participantes de un card (solo cuando está expandido) */
        function actualizarListaParticipantesCard(cardId, participantes) {
            const container = document.getElementById(`lista-participantes-${cardId}`);
            if (!container) return;
            const ordenados = participantes.slice().sort((a, b) => (a.nombre || '').localeCompare(b.nombre || '', 'es', { sensitivity: 'base' }));
            container.innerHTML = ordenados.map(p => `
                <div class="attendance-item-compact" data-participante-id="${p.id}">
                    <input type="checkbox" class="attendance-checkbox-compact" ${p.asiste ? 'checked' : ''}
                           data-participante-id="${p.id}"
                           onchange="toggleAsistenciaGranular('${p.id}', '${cardId}')"
                           onclick="event.stopPropagation();">
                    <span class="attendance-name-compact ${p.asiste ? 'checked' : ''}"
                          onclick="toggleAsistenciaGranular('${p.id}', '${cardId}'); event.stopPropagation();">${escapeHtml(p.nombre)}</span>
                </div>
            `).join('');
        }

        /** Renderiza la lista de rutas en la pestaña Rutas (cards desplegables). */
        function renderRutas() {
    const search = document.getElementById('searchRutas').value.toLowerCase();

    // Filtrar solo rutas no archivadas
    const filtered = data.rutas.filter(r => 
        !r.archivada && 
        (r.nombre.toLowerCase().includes(search) || r.fecha.includes(search))
    );
    
    const html = filtered.length === 0 ? 
        `<div class="empty-state">
            <div class="empty-state-icon">🏔️</div>
            <h3>No hay rutas registradas</h3>
            <p>Crea tu primera ruta de senderismo</p>
        </div>` :
        filtered.map(ruta => {
            const ocupados = calcularCuposOcupados(ruta.id);
            const disponibles = ruta.cupos - ocupados;
            const porcentaje = (ocupados / ruta.cupos * 100).toFixed(0);
            const recaudado = calcularTotalRecaudado(ruta.id);
            const gastos = calcularTotalGastos(ruta.id);
            const profitNeto = calcularProfitNeto(ruta.id);
            const totalDolares = calcularTotalDolares(ruta.id);
            const haySobreventa = ocupados > ruta.cupos;
            const badgeClass = haySobreventa ? 'badge-closed' : (disponibles > 5 ? 'badge-active' : disponibles > 0 ? 'badge-warning' : 'badge-closed');
            const badgeText = haySobreventa ? 'Sobrevendida' : (disponibles > 0 ? 'Activa' : 'Completa');
            const precioEuros = ruta.precioEuros || 0; // Usar campo normalizado
            const colorCupos = haySobreventa ? 'var(--danger)' : 'var(--text-primary)';
            
            // Calcular asistencia (presentes vs cupos reservados) por ruta específica
            const reservasRuta = data.reservas.filter(r => r.rutaId === ruta.id);
            const participantesRuta = data.participantes.filter(p => 
                reservasRuta.some(r => r.lider === p.lider && (p.ruta_nombre || p.ruta) === ruta.nombre)
            );
            const presentes = participantesRuta.filter(p => p.asiste).length;
            const cuposReservados = reservasRuta.reduce((sum, r) => sum + getCuposReserva(r), 0);
            const porcentajeAsistencia = cuposReservados > 0 ? (presentes / cuposReservados * 100).toFixed(0) : 0;

            const cardId = `ruta-${ruta.id || ruta.nombre.replace(/\s+/g, '-').toLowerCase()}`;
            
            return `
                <div class="card" id="${cardId}">
                    <!-- VISTA COMPACTA -->
                    <div class="reserva-compact">
                        <div class="card-header">
                            <div>
                                <div class="card-title">
                                    <div>🏔️ ${ruta.nombre}</div>
                                    <div style="font-size: 11px; color: var(--text-secondary); margin-top: 2px; font-weight: normal;">
                                        ID: ${ruta.numero ? `#${String(ruta.numero).padStart(4, '0')}` : 'N/A'}
                                    </div>
                                </div>
                                <div class="card-meta">
                                    📅 ${formatearFechaRuta(ruta.fecha)}
                                </div>
                            </div>
                            <span class="badge ${badgeClass}">${badgeText}</span>
                        </div>

                        <div class="stats-row">
                            <div class="stat">
                                <span class="stat-value" style="color: ${colorCupos};">${ocupados}/${ruta.cupos}</span>
                                <span class="stat-label">Cupos${haySobreventa ? ' ⚠️' : ''}</span>
                            </div>
                            <div class="stat">
                                <span class="stat-value" style="color: ${haySobreventa ? 'var(--danger)' : (disponibles > 0 ? 'var(--success)' : 'var(--text-secondary)')};">${haySobreventa ? `-${Math.abs(disponibles)}` : disponibles}</span>
                                <span class="stat-label">${haySobreventa ? 'Sobrevendidos' : 'Disponibles'}</span>
                            </div>
                            <div class="stat">
                                <span class="stat-value">${precioEuros}€</span>
                                <span class="stat-label">Precio Ref.</span>
                            </div>
                        </div>

                        <div class="progress-bar" style="margin-top: 16px;">
                            <div class="progress-fill" style="width: ${porcentaje}%"></div>
                        </div>

                        <div class="progress-text" style="justify-content: flex-end;">
                            <span>${porcentaje}% ocupado</span>
                        </div>
                    </div>

                    <!-- VISTA EXTENDIDA (oculta por defecto) -->
                    <div class="reserva-expanded" style="display: none; margin-top: 12px;">
                        ${cuposReservados > 0 ? `
                        <div style="margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                                <span style="font-size: 12px; color: var(--text-secondary);">📋 Asistencia: ${presentes}/${cuposReservados} presentes</span>
                                <span style="font-size: 12px; color: var(--text-secondary); font-weight: 600;">${porcentajeAsistencia}%</span>
                            </div>
                            <div class="progress-bar" style="height: 6px;">
                                <div class="progress-fill" style="width: ${porcentajeAsistencia}%; background: ${porcentajeAsistencia >= 80 ? 'var(--success)' : porcentajeAsistencia >= 50 ? '#fbbf24' : 'var(--danger)'};"></div>
                            </div>
                        </div>
                        ` : ''}

                        <div style="padding: 12px; background: rgba(118, 200, 147, 0.1); border-radius: 12px; border: 1px solid var(--border);">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 8px;">
                                <div>
                                    <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">💰 Recaudado (Bs)</div>
                                    <div style="font-size: 16px; font-weight: 800; color: var(--success);">
                                        Bs ${recaudado.toLocaleString()}
                                    </div>
                                </div>
                                <div>
                                    <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">💵 USD Efectivo</div>
                                    <div style="font-size: 16px; font-weight: 800; color: #f59e0b;">
                                        $${totalDolares.toLocaleString()}
                                    </div>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 8px;">
                                <div>
                                    <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">💸 Gastos</div>
                                    <div style="font-size: 16px; font-weight: 800; color: var(--danger);">
                                        Bs ${gastos.toLocaleString()}
                                    </div>
                                </div>
                            </div>

                            <div style="padding-top: 8px; border-top: 1px solid var(--border);">
                                <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">📊 Profit Neto</div>
                                <div style="font-size: 20px; font-weight: 800; color: ${profitNeto >= 0 ? 'var(--success)' : 'var(--danger)'};">
                                    Bs ${profitNeto.toLocaleString()}
                                </div>
                            </div>
                        </div>

                        <button class="btn btn-small" style="margin-top: 16px; background: var(--green-mountain); border-color: var(--green-mountain); color: #fff;" onclick="archivarRuta('${ruta.id}')">
                            📦 Archivar Ruta
                        </button>
                    </div>

                    <!-- Botón de expandir/colapsar -->
                    <div style="margin-top: 12px; display: flex; justify-content: center;">
                        <button class="btn btn-outline btn-small" onclick="toggleRutaCard('${cardId}')" title="Ver detalles" style="min-width: 140px; border-radius: 999px; display: inline-flex; align-items: center; justify-content: center; gap: 6px;">
                            <span class="expand-icon">▼</span>
                            <span>Ver detalles</span>
                        </button>
                    </div>
                </div>
            `;
        }).join('');
    
    document.getElementById('listaRutas').innerHTML = html;
}

/** Formatea fecha para mostrar en rutas (formato largo). Parseo manual para evitar problemas de timezone. */
function formatearFechaRuta(fechaString) {
    try {
        // Parseo manual para evitar problemas de timezone
        const fechaStr = fechaString.split('T')[0]; // Obtener solo la parte de fecha (YYYY-MM-DD)
        const partes = fechaStr.split('-');
        if (partes.length === 3) {
            const año = parseInt(partes[0], 10);
            const mes = parseInt(partes[1], 10) - 1; // Mes es 0-indexed
            const dia = parseInt(partes[2], 10);
            const fecha = new Date(año, mes, dia);
            
            return fecha.toLocaleDateString('es-ES', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        }
        // Fallback si no es formato ISO
        const fecha = new Date(fechaString);
        const fechaAjustada = new Date(fecha.getTime() + fecha.getTimezoneOffset() * 60000);
        return fechaAjustada.toLocaleDateString('es-ES', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });
    } catch (error) {
        console.error('Error formateando fecha:', error);
        return fechaString;
    }
}

/** Formatea fecha para listas y asistencia (formato corto). Parseo manual para evitar problemas de timezone. */
function formatearFechaCorta(fechaString) {
    try {
        // Parseo manual para evitar problemas de timezone
        const fechaStr = fechaString.split('T')[0]; // Obtener solo la parte de fecha (YYYY-MM-DD)
        const partes = fechaStr.split('-');
        if (partes.length === 3) {
            const año = parseInt(partes[0], 10);
            const mes = parseInt(partes[1], 10) - 1; // Mes es 0-indexed
            const dia = parseInt(partes[2], 10);
            const fecha = new Date(año, mes, dia);
            
            return fecha.toLocaleDateString('es-ES', { 
                day: 'numeric', 
                month: 'short' 
            });
        }
        // Fallback si no es formato ISO
        const fecha = new Date(fechaString);
        const fechaAjustada = new Date(fecha.getTime() + fecha.getTimezoneOffset() * 60000);
        return fechaAjustada.toLocaleDateString('es-ES', { 
            day: 'numeric', 
            month: 'short' 
        });
    } catch (error) {
        return fechaString;
    }
}


        // RENDER RESERVAS
        function renderReservas() {
            const search = document.getElementById('searchReservas').value.toLowerCase();
            const filtroRuta = document.getElementById('filtroRutaReservas').value;
            
            // Filtrar reservas: excluir las de rutas archivadas
            let filtered = data.reservas.filter(r => {
                // 🔥 CORRECCIÓN: Buscar ruta por ID, no por nombre
                const ruta = data.rutas.find(rt => rt.id === r.rutaId);
                // Excluir reservas de rutas archivadas o que no existan
                if (!ruta || ruta.archivada) {
                    return false;
                }
                
                // Aplicar filtro de búsqueda (usar nombre de ruta si está disponible)
                const nombreRuta = r.ruta || ruta.nombre || '';
                return r.lider.toLowerCase().includes(search) || 
                       nombreRuta.toLowerCase().includes(search);
            });
            
            if (filtroRuta) {
                filtered = filtered.filter(r => r.rutaId === filtroRuta);
            }
            
            const html = filtered.length === 0 ?
                `<div class="empty-state">
                    <div class="empty-state-icon">🎫</div>
                    <h3>No hay reservas</h3>
                    <p>Crea tu primera reserva grupal</p>
                </div>` :
                filtered.map(reserva => {
                    // 🔥 CORRECCIÓN: Buscar ruta por ID
                    const ruta = data.rutas.find(r => r.id === reserva.rutaId);
                    
                    // Validar que la ruta existe (ya filtrado arriba, pero por seguridad)
                    if (!ruta) {
                        return '';
                    }
                    
                    const registrados = contarParticipantesReserva(reserva.lider, reserva.rutaId);
                    const { totalBs, totalDolares, cuposPagados } = calcularTotalesPorMoneda(reserva);
                    const eurosRecibidos = calcularEurosRecibidos(reserva, ruta);
                    const eurosEsperados = (reserva.cantidad || 0) * (ruta ? (ruta.precioEuros || 0) : 0);
                    const precioEuros = ruta.precioEuros || 0;
                    const numPagos = (reserva.pagos && reserva.pagos.length > 0) ? reserva.pagos.length : 0;
                    const saldoUsado = (reserva.abonado_euros || 0) || (reserva.pagos || []).reduce((s, p) => s + (p.saldo_usado || 0), 0);
                    const tienePagos = totalBs > 0 || totalDolares > 0 || saldoUsado > 0;
                    // ID único por líder + ruta, para soportar mismo líder en varias rutas
                    // 🔥 CORRECCIÓN: Usar rutaId para cardId único (evita colisiones con rutas del mismo nombre)
                    const cardId = `reserva-${reserva.lider.replace(/\s+/g, '-').toLowerCase()}-${reserva.rutaId}`;
                    
                    return `
                        <div class="card reserva-card" id="${cardId}">
                            <!-- VISTA COMPACTA (siempre visible) -->
                            <div class="reserva-compact">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                    <div style="flex: 1;">
                                        <div class="card-title" style="margin-bottom: 4px;">👤 ${reserva.lider}</div>
                                        <div class="card-meta" style="margin-bottom: 8px;">📍 ${ruta ? ruta.nombre : 'N/A'}${ruta && ruta.fecha ? ' • ' + formatearFechaCorta(ruta.fecha) : ''}</div>
                                        <div style="display: flex; gap: 16px; font-size: 13px; color: var(--text-secondary);">
                                            ${(function() {
                                                const c = getColorCompletitud(cuposPagados, reserva.cantidad);
                                                const haySobreventa = cuposPagados > reserva.cantidad;
                                                return '<span style="color: ' + c.color + '; font-weight: ' + (haySobreventa ? '700' : '400') + ';" title="Cupos pagados / reservados • € recibidos / esperados">📊 ' + cuposPagados + '/' + reserva.cantidad + ' (' + eurosRecibidos + '€/' + eurosEsperados + '€)</span>';
                                            })()}
                                            ${tienePagos ? `<span>💰 ${totalBs > 0 || totalDolares > 0 ? `Bs ${totalBs.toLocaleString()}${totalDolares > 0 ? ` + $${totalDolares.toLocaleString()}` : ''}${saldoUsado > 0 ? ' + ' : ''}` : ''}${saldoUsado > 0 ? `€${(saldoUsado % 1 === 0 ? saldoUsado : saldoUsado.toFixed(2))} pagado con saldo` : (totalBs > 0 || totalDolares > 0 ? '' : '')}</span>` : '<span style="color: var(--text-tertiary);">Sin pagos</span>'}
                                        </div>
                                    </div>
                                    <div style="display: flex; flex-direction: column; gap: 8px;">
                                        <button class="btn-expand-reserva" onclick="abrirModalEditarReserva('${reserva.id}')" title="Editar reserva">
                                            ✏️
                                        </button>
                                        <button class="btn-expand-reserva" onclick="toggleReservaCard('${cardId}')" title="Ver detalles">
                                            <span class="expand-icon">▼</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- VISTA EXPANDIDA (oculta por defecto) -->
                            <div class="reserva-expanded" style="display: none;">
                                <div class="stats-row">
                                    <div class="stat">
                                        <span class="stat-value">${reserva.cantidad}</span>
                                        <span class="stat-label">Cupos</span>
                                    </div>
                                    <div class="stat">
                                        <span class="stat-value">${precioEuros}€</span>
                                        <span class="stat-label">Precio Ref.</span>
                                    </div>
                                <div class="stat">
                                    ${(function() {
                                        const c = getColorCompletitud(registrados, reserva.cantidad);
                                        const haySobreventa = registrados > reserva.cantidad;
                                        const labelStat = haySobreventa ? 'Sobrevendidos' : (registrados === reserva.cantidad ? 'Completo' : (registrados === 0 ? 'Personas/Cupos' : 'Faltan ' + (reserva.cantidad - registrados)));
                                        return '<span class="stat-value" style="color: ' + c.color + ';" title="' + c.label + '">' + registrados + '/' + reserva.cantidad + (haySobreventa ? ' ⚠️' : '') + '</span><span class="stat-label">' + labelStat + '</span>';
                                    })()}
                                </div>
                                </div>
                                ${tienePagos ? `
                                    <div style="margin-top: 16px; padding: 12px; background: rgba(118, 200, 147, 0.1); border-radius: 12px; border: 1px solid var(--border);">
                                        <div style="display: grid; grid-template-columns: 1fr ${totalDolares > 0 ? '1fr' : ''}${saldoUsado > 0 ? ' 1fr' : ''}; gap: 12px; margin-bottom: 4px;">
                                            ${(totalBs > 0 || totalDolares > 0) ? `
                                            <div>
                                                <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 2px;">💰 Bs</div>
                                                <div style="font-size: 16px; font-weight: 800; color: var(--success);">Bs ${totalBs.toLocaleString()}</div>
                                            </div>
                                            ${totalDolares > 0 ? `
                                            <div>
                                                <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 2px;">💵 USD Efectivo</div>
                                                <div style="font-size: 16px; font-weight: 800; color: #f59e0b;">$${totalDolares.toLocaleString()}</div>
                                            </div>
                                            ` : ''}
                                            ` : ''}
                                            ${saldoUsado > 0 ? `
                                            <div>
                                                <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 2px;">💳 Pagado con saldo</div>
                                                <div style="font-size: 16px; font-weight: 800; color: #06b6d4;">€${saldoUsado % 1 === 0 ? saldoUsado : saldoUsado.toFixed(2)}</div>
                                            </div>
                                            ` : ''}
                                        </div>
                                        ${numPagos > 0 ? `<div style="font-size: 11px; color: var(--text-secondary); text-align: right; margin-top: 4px;">${numPagos} pago${numPagos !== 1 ? 's' : ''} registrado${numPagos !== 1 ? 's' : ''}</div>` : ''}
                                    </div>
                                ` : ''}
                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 16px;">
                                    <button class="btn btn-success btn-small" onclick="agregarPersonaRapida('${reserva.lider}', '${reserva.rutaId}')" title="Agregar persona">
                                        +1
                                    </button>
                                    <button class="btn btn-primary btn-small" onclick="verDetalleReserva('${reserva.lider}', '${reserva.rutaId}')">
                                        💰 Pagos
                                    </button>
                                    <button class="btn btn-danger btn-small" onclick="eliminarReserva('${reserva.lider}', '${reserva.rutaId}')">
                                        🗑️ Eliminar
                                    </button>
                                </div>
                                <button class="btn btn-success btn-small" style="margin-top: 8px; width: 100%; background: #25D366; border-color: #25D366; color: white; display: flex; align-items: center; justify-content: center; gap: 6px;" 
                                        onclick="compartirReservaPorWhatsapp('${reserva.id}')">
                                    <span style="font-size: 16px;">📱</span> Compartir por WhatsApp
                                </button>
                            </div>
                        </div>
                    `;
                }).filter(html => html !== '').join('');
            
            document.getElementById('listaReservas').innerHTML = html;
        }

        // EDITAR RESERVA (líder + cupos)
        function abrirModalEditarReserva(reservaId) {
            const reserva = (data.reservas || []).find(r => String(r.id) === String(reservaId));
            if (!reserva) {
                showToast('No se encontró la reserva', 'error', 'Error');
                return;
            }

            const ruta = data.rutas.find(r => r.id === reserva.rutaId);
            document.getElementById('editarReservaId').value = reserva.id;
            document.getElementById('editarReservaLider').value = reserva.lider || '';
            document.getElementById('editarReservaRutaNombre').value = ruta ? ruta.nombre : (reserva.ruta || '');
            document.getElementById('editarReservaCantidad').value = getCuposReserva(reserva);

            openModal('modalEditarReserva');
            setTimeout(() => document.getElementById('editarReservaLider')?.focus(), 50);
        }

        async function guardarEdicionReserva() {
            const reservaId = document.getElementById('editarReservaId').value;
            const nuevoLider = (document.getElementById('editarReservaLider').value || '').trim();
            const nuevaCantidad = parseInt(document.getElementById('editarReservaCantidad').value, 10);

            if (!reservaId) {
                showToast('No se pudo identificar la reserva', 'error', 'Error');
                return;
            }
            if (!nuevoLider || nuevoLider.length < 2) {
                showToast('Ingresa un nombre de líder válido', 'warning', 'Validación');
                document.getElementById('editarReservaLider').focus();
                return;
            }
            if (!Number.isFinite(nuevaCantidad) || nuevaCantidad < 1 || nuevaCantidad > 100) {
                showToast('La cantidad de cupos debe estar entre 1 y 100', 'warning', 'Validación');
                document.getElementById('editarReservaCantidad').focus();
                return;
            }

            const reserva = (data.reservas || []).find(r => String(r.id) === String(reservaId));
            if (!reserva) {
                showToast('No se encontró la reserva', 'error', 'Error');
                return;
            }

            // Validar cupos de ruta (permitir sobreventa con confirmación)
            const ruta = data.rutas.find(r => r.id === reserva.rutaId);
            if (ruta) {
                const cantidadActual = getCuposReserva(reserva);
                const ocupadosSinEstaReserva = calcularCuposOcupados(ruta.id) - cantidadActual;
                const nuevosOcupados = ocupadosSinEstaReserva + nuevaCantidad;
                if (nuevosOcupados > ruta.cupos) {
                    const continuar = await confirmarAccion(
                        `⚠️ Esta edición creará sobreventa.\n\n` +
                        `Ruta: ${ruta.nombre}\n` +
                        `Cupos de la ruta: ${ruta.cupos}\n` +
                        `Cupos ocupados (sin esta reserva): ${ocupadosSinEstaReserva}\n` +
                        `Nueva cantidad: ${nuevaCantidad}\n` +
                        `Total después del cambio: ${nuevosOcupados}/${ruta.cupos}\n\n` +
                        `¿Deseas continuar?`,
                        'peligro'
                    );
                    if (!continuar) return;
                }
            }

            try {
                showLoader('Guardando cambios...');

                const cantidadColumn = getCantidadColumnName(reserva);
                const updatePayload = { lider: nuevoLider };
                updatePayload[cantidadColumn] = nuevaCantidad;

                const { error } = await db
                    .from('reservas')
                    .update(updatePayload)
                    .eq('id', reservaId);

                if (error) throw error;

                closeModal('modalEditarReserva');

                // CRUCIAL: recargar lista y recalcular cupos inmediatamente
                await saveData(true);
                updateSelects();
                renderReservas();
                renderRutas();

                showToast('Reserva actualizada correctamente', 'success', 'Éxito');
            } catch (error) {
                console.error('Error actualizando reserva:', error);
                showToast('Error al actualizar la reserva: ' + error.message, 'error', 'Error');
            } finally {
                hideLoader();
            }
        }

        // TOGGLE EXPANDIR/COLAPSAR CARD DE RESERVA
        function toggleReservaCard(cardId) {
            const card = document.getElementById(cardId);
            if (!card) return;
            
            const expanded = card.querySelector('.reserva-expanded');
            const compact = card.querySelector('.reserva-compact');
            const icon = card.querySelector('.expand-icon');
            
            if (!expanded || !compact || !icon) return;
            
            const isExpanded = expanded.style.display !== 'none';
            
            if (isExpanded) {
                // Colapsar
                expanded.style.display = 'none';
                icon.textContent = '▼';
                icon.style.transform = 'rotate(0deg)';
            } else {
                // Expandir
                expanded.style.display = 'block';
                icon.textContent = '▲';
                icon.style.transform = 'rotate(0deg)';
            }
        }

        // TOGGLE EXPANDIR/COLAPSAR CARD DE ASISTENCIA
        function toggleAsistenciaCard(cardId) {
            const card = document.getElementById(cardId);
            if (!card) return;
            const expanded = card.querySelector('.asistencia-expanded');
            const icon = card.querySelector('.expand-icon');
            if (!expanded || !icon) return;
            const isExpanded = expanded.style.display !== 'none';
            if (isExpanded) {
                expanded.style.display = 'none';
                icon.textContent = '▼';
                icon.style.transform = 'rotate(0deg)';
                cardsAsistenciaExpandidos.delete(cardId);
            } else {
                expanded.style.display = 'block';
                icon.textContent = '▲';
                icon.style.transform = 'rotate(0deg)';
                cardsAsistenciaExpandidos.add(cardId);
                const lider = card.dataset.lider;
                const rutaId = card.dataset.rutaId;
                if (lider && rutaId) actualizarListaParticipantesCard(cardId, obtenerParticipantesReserva(lider, rutaId));
            }
        }
        
        // TOGGLE EXPANDIR/COLAPSAR CARD DE RUTA ARCHIVADA
        function toggleRutaArchivadaCard(cardId) {
            const card = document.getElementById(cardId);
            if (!card) return;
            
            const expanded = card.querySelector('.reserva-expanded');
            const icon = card.querySelector('.expand-icon');
            
            if (!expanded || !icon) return;
            
            const isExpanded = expanded.style.display !== 'none';
            
            if (isExpanded) {
                // Colapsar
                expanded.style.display = 'none';
                icon.textContent = '▼';
                icon.style.transform = 'rotate(0deg)';
            } else {
                // Expandir
                expanded.style.display = 'block';
                icon.textContent = '▲';
                icon.style.transform = 'rotate(0deg)';
            }
        }

        // TOGGLE EXPANDIR/COLAPSAR CARD DE RUTA ACTIVA
        function toggleRutaCard(cardId) {
            const card = document.getElementById(cardId);
            if (!card) return;
            
            const expanded = card.querySelector('.reserva-expanded');
            const compact = card.querySelector('.reserva-compact');
            const icon = card.querySelector('.expand-icon');
            
            if (!expanded || !compact || !icon) return;
            
            const isExpanded = expanded.style.display !== 'none';
            
            if (isExpanded) {
                // Colapsar
                expanded.style.display = 'none';
                icon.textContent = '▼';
                icon.style.transform = 'rotate(0deg)';
            } else {
                // Expandir
                expanded.style.display = 'block';
                icon.textContent = '▲';
                icon.style.transform = 'rotate(0deg)';
            }
        }

        // VER HISTORIAL DE RUTAS DE UNA PERSONA (modal detallado)
        function verHistorialRutas(nombrePersona) {
            window._nombrePersonaHistorialActual = nombrePersona || '';
            const historial = calcularRutasPorPersona(nombrePersona);

            if (historial.totalParticipaciones === 0) {
                showToast('Esta persona no tiene historial de rutas', 'info', 'Información');
                return;
            }

            let mensaje = `📊 HISTORIAL COMPLETO: ${(nombrePersona || '').toUpperCase()}\n\n`;
            mensaje += `📈 RESUMEN ESTADÍSTICO:\n`;
            mensaje += `• Rutas asistidas: ${historial.totalRutasAsistidas}\n`;
            mensaje += `• Total de rutas participadas: ${historial.totalTodasLasRutas}\n`;
            mensaje += `• Participaciones totales: ${historial.totalParticipaciones}\n`;
            mensaje += `• ✅ Asistencias: ${historial.totalAsistidas}\n`;
            mensaje += `• ❌ Ausencias: ${historial.totalNoAsistidas}\n`;
            mensaje += `• Tasa de asistencia: ${historial.porcentajeAsistencia}%\n\n`;

            if (historial.rutasAsistidas.length > 0) {
                mensaje += `🏔️ RUTAS CON ASISTENCIA (${historial.rutasAsistidas.length}):\n\n`;
                historial.rutasAsistidas.forEach((ruta, index) => {
                    mensaje += `${index + 1}. ${ruta.nombre}\n`;
                    if (ruta.fecha) {
                        const fechaFormateada = new Date(ruta.fecha).toLocaleDateString('es-ES', { day: 'numeric', month: 'short', year: 'numeric' });
                        mensaje += `   📅 ${fechaFormateada}\n`;
                    }
                    if (ruta.vecesAsistio > 1) mensaje += `   🔄 ${ruta.vecesAsistio} veces asistió\n`;
                    if (ruta.lider) mensaje += `   👤 ${ruta.lider}\n`;
                    mensaje += '\n';
                });
            }

            mensaje += `📋 DETALLE DE TODAS LAS PARTICIPACIONES:\n\n`;
            const participacionesPorRuta = {};
            historial.participacionesDetalladas.forEach(p => {
                const r = (p.ruta || '').trim();
                if (!r) return;
                if (!participacionesPorRuta[r]) participacionesPorRuta[r] = [];
                participacionesPorRuta[r].push(p);
            });

            Object.entries(participacionesPorRuta).forEach(([nombreRuta, participaciones], rutaIndex) => {
                const totalEnRuta = participaciones.length;
                const asistidasEnRuta = participaciones.filter(pa => pa.asiste === true).length;
                mensaje += `${rutaIndex + 1}. ${nombreRuta}\n`;
                mensaje += `   ${asistidasEnRuta}/${totalEnRuta} veces asistió\n`;
                participaciones.forEach((p, pIndex) => {
                    const estado = p.asiste === true ? '✅' : '❌';
                    const fecha = p.fecha ? new Date(p.fecha).toLocaleDateString('es-ES', { day: 'numeric', month: 'short' }) : 'Sin fecha';
                    mensaje += `   ${pIndex + 1}) ${estado} ${fecha} - ${p.lider || 'Sin líder'}\n`;
                });
                mensaje += '\n';
            });

            const tituloEl = document.getElementById('modalHistorialRecurrenteTitulo');
            const cuerpoEl = document.getElementById('modalHistorialRecurrenteCuerpo');
            const nombreEsc = escapeHtml(nombrePersona || '');

            if (tituloEl) {
                const tituloColor = historial.porcentajeAsistencia >= 70 ? 'var(--success)' : historial.porcentajeAsistencia >= 30 ? '#f59e0b' : 'var(--danger)';
                tituloEl.innerHTML = `<span style="color: ${tituloColor}">⭐ ${nombreEsc} <span style="font-size: 14px; color: var(--text-secondary);">(${historial.totalRutas} ${historial.totalRutas === 1 ? 'ruta asistida' : 'rutas asistidas'})</span></span>`;
            }
            if (cuerpoEl) {
                cuerpoEl.innerHTML = `<div style="font-family: 'Poppins', sans-serif; font-size: 13px; line-height: 1.4; white-space: pre-wrap; max-height: 60vh; overflow-y: auto; padding-right: 8px;">${escapeHtml(mensaje)}</div>`;
            }
            const btnWrap = document.getElementById('btnCompartirHistorialWrap');
            if (btnWrap) btnWrap.style.display = 'none';
            const modal = document.getElementById('modalHistorialRecurrente');
            if (modal) modal.classList.add('active');
        }

        function cerrarModalHistorialRecurrente() {
            const modal = document.getElementById('modalHistorialRecurrente');
            if (modal) modal.classList.remove('active');
        }

        /** Comparte por WhatsApp el texto en window._shareHistorialTexto (usado por el perfil de aventurero desde Ranking). */
        function compartirHistorialPorWhatsApp() {
            const texto = window._shareHistorialTexto;
            if (!texto || typeof texto !== 'string') {
                showToast('No hay contenido para compartir', 'info');
                return;
            }
            const url = 'https://wa.me/?text=' + encodeURIComponent(texto);
            window.open(url, '_blank');
            showToast('Abriendo WhatsApp...', 'info');
        }

        /** Rutas pasadas o archivadas (para añadir al historial manualmente) */
        function getRutasPasadasParaHistorial() {
            const hoy = new Date();
            hoy.setHours(0, 0, 0, 0);
            return (data.rutas || []).filter(r => {
                const archivada = r.archivada === true;
                const fechaPasada = r.fecha && new Date(r.fecha + 'T12:00:00') < hoy;
                return archivada || fechaPasada;
            }).sort((a, b) => (b.fecha || '').localeCompare(a.fecha || ''));
        }

        function abrirModalAnadirRutaPasadaDesdeHistorial() {
            const nombre = window._nombrePersonaHistorialActual || '';
            if (!nombre.trim()) {
                showToast('No hay persona seleccionada', 'warning');
                return;
            }
            const elPersona = document.getElementById('modalAnadirRutaPasadaPersona');
            if (elPersona) elPersona.textContent = 'Añadir ruta asistida para: ' + nombre;
            const select = document.getElementById('selectRutaPasada');
            if (!select) return;
            select.innerHTML = '<option value="">-- Elegir ruta --</option>';
            const rutasPasadas = getRutasPasadasParaHistorial();
            rutasPasadas.forEach(r => {
                const opt = document.createElement('option');
                opt.value = r.id;
                opt.textContent = r.nombre + ' — ' + (r.fecha ? formatearFechaRuta(r.fecha) : 'Sin fecha');
                select.appendChild(opt);
            });
            if (rutasPasadas.length === 0) {
                showToast('No hay rutas pasadas o archivadas', 'info');
                return;
            }
            closeModal('modalHistorialRecurrente');
            openModal('modalAnadirRutaPasada');
        }

        async function guardarRutaPasada() {
            const nombre = (window._nombrePersonaHistorialActual || '').trim();
            const select = document.getElementById('selectRutaPasada');
            const rutaId = select ? select.value : '';
            if (!nombre) {
                showToast('No hay persona seleccionada', 'warning');
                return;
            }
            if (!rutaId) {
                showToast('Elige una ruta', 'warning');
                return;
            }
            const ruta = data.rutas.find(r => r.id === rutaId);
            if (!ruta) {
                showToast('Ruta no encontrada', 'error');
                return;
            }
            const yaExiste = (data.participantes || []).some(p =>
                (p.nombre || '').trim().toLowerCase() === nombre.toLowerCase() &&
                (p.rutaId === rutaId || p.ruta_id === rutaId)
            );
            if (yaExiste) {
                showToast('Esta persona ya tiene esa ruta en su historial', 'warning');
                return;
            }
            try {
                showLoader('Guardando...');
                const { error } = await db.from('participantes').insert([{
                    nombre: nombre,
                    lider: nombre,
                    ruta_id: rutaId,
                    ruta_nombre: ruta.nombre,
                    asiste: true
                }]);
                if (error) throw error;
                await saveData(true);
                closeModal('modalAnadirRutaPasada');
                showToast('Ruta añadida al historial', 'success');
                renderRanking();
                renderParticipantes();
                verHistorialRutas(nombre);
                openModal('modalHistorialRecurrente');
            } catch (e) {
                console.error(e);
                showToast('Error: ' + (e.message || e), 'error');
            } finally {
                hideLoader();
            }
        }

        function abrirModalAnadirAventuradoHistorial() {
            const input = document.getElementById('nuevoAventuradoNombre');
            if (input) input.value = '';
            const container = document.getElementById('listaRutasPasadasCheckboxes');
            if (!container) return;
            container.innerHTML = '';
            const rutasPasadas = getRutasPasadasParaHistorial();
            if (rutasPasadas.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); font-size: 13px;">No hay rutas pasadas o archivadas.</p>';
            } else {
                rutasPasadas.forEach(r => {
                    const label = document.createElement('label');
                    label.style.display = 'flex';
                    label.style.alignItems = 'center';
                    label.style.gap = '8px';
                    label.style.marginBottom = '8px';
                    label.style.cursor = 'pointer';
                    const cb = document.createElement('input');
                    cb.type = 'checkbox';
                    cb.value = r.id;
                    cb.dataset.nombre = r.nombre || '';
                    label.appendChild(cb);
                    label.appendChild(document.createTextNode(r.nombre + (r.fecha ? ' — ' + formatearFechaRuta(r.fecha) : '')));
                    container.appendChild(label);
                });
            }
            openModal('modalAnadirAventuradoHistorial');
        }

        async function guardarAventuradoHistorial() {
            const nombreInput = document.getElementById('nuevoAventuradoNombre');
            const nombre = (nombreInput && nombreInput.value || '').trim();
            if (!nombre) {
                showToast('Ingresa el nombre completo', 'warning');
                return;
            }
            const container = document.getElementById('listaRutasPasadasCheckboxes');
            const checkboxes = container ? container.querySelectorAll('input[type="checkbox"]:checked') : [];
            const rutaIds = Array.from(checkboxes).map(cb => cb.value).filter(Boolean);
            if (rutaIds.length === 0) {
                showToast('Marca al menos una ruta asistida', 'warning');
                return;
            }
            try {
                showLoader('Guardando...');
                const inserts = [];
                for (const rutaId of rutaIds) {
                    const ruta = data.rutas.find(r => r.id === rutaId);
                    if (!ruta) continue;
                    const yaExiste = (data.participantes || []).some(p =>
                        (p.nombre || '').trim().toLowerCase() === nombre.toLowerCase() &&
                        (p.rutaId === rutaId || p.ruta_id === rutaId)
                    );
                    if (yaExiste) continue;
                    inserts.push({
                        nombre: nombre,
                        lider: nombre,
                        ruta_id: rutaId,
                        ruta_nombre: ruta.nombre,
                        asiste: true
                    });
                }
                if (inserts.length === 0) {
                    showToast('Todas esas rutas ya están en el historial de esta persona', 'info');
                    hideLoader();
                    return;
                }
                const { error } = await db.from('participantes').insert(inserts);
                if (error) throw error;
                await saveData(true);
                closeModal('modalAnadirAventuradoHistorial');
                showToast(inserts.length === 1 ? 'Aventurado añadido al historial' : inserts.length + ' rutas añadidas al historial', 'success');
                renderRanking();
                renderParticipantes();
            } catch (e) {
                console.error(e);
                showToast('Error: ' + (e.message || e), 'error');
            } finally {
                hideLoader();
            }
        }

        // RENDER PARTICIPANTES
        function renderParticipantes() {
            const search = document.getElementById('searchParticipantes').value.toLowerCase();
            const filtroRuta = document.getElementById('filtroRutaParticipantes').value;
            
            // Partimos de todos los participantes cargados
            let filtered = [...(data.participantes || [])];
            
            // Filtrar participantes de rutas archivadas (solo mostrar participantes de rutas activas)
            // 🔥 CORRECCIÓN: Usar rutaId para filtrar correctamente
            filtered = filtered.filter(p => {
                const rutaIdParticipante = p.rutaId || p.ruta_id;
                if (!rutaIdParticipante) {
                    // Si no tiene ruta_id, intentar buscar por nombre (compatibilidad)
                    const rutaNombre = p.ruta_nombre || p.ruta || '';
                    if (!rutaNombre) return true; // Si no tiene ruta, mostrarlo (por si acaso)
                    const ruta = data.rutas.find(r => r.nombre === rutaNombre);
                    return !ruta || !ruta.archivada;
                }
                // Buscar ruta por ID
                const ruta = data.rutas.find(r => r.id === rutaIdParticipante);
                return !ruta || !ruta.archivada; // Mostrar solo si la ruta no existe o no está archivada
            });
            
            // Aplicar búsqueda por nombre o líder
            if (search) {
                filtered = filtered.filter(p =>
                    p.nombre?.toLowerCase().includes(search) ||
                    p.lider?.toLowerCase().includes(search)
                );
            }
            
            // Filtro por ruta (si está seleccionado)
            // 🔥 CORRECCIÓN: El filtro usa rutaId (UUID), comparar correctamente
            if (filtroRuta) {
                filtered = filtered.filter(p => 
                    (p.rutaId === filtroRuta || p.ruta_id === filtroRuta) || // Por ID
                    (p.ruta_nombre || p.ruta) === filtroRuta // Compatibilidad: por nombre si el filtro es nombre
                );
            }
            
            const html = filtered.length === 0 ?
                `<div class="empty-state">
                    <div class="empty-state-icon">👥</div>
                    <h3>No hay personas registradas</h3>
                    <p>Registra a los participantes</p>
                </div>` :
                `<div class="person-list-compact">
                    ${filtered.map((p) => {
                        // 🔥 CORRECCIÓN: Buscar ruta por ID primero, luego por nombre (compatibilidad)
                        const rutaIdParticipante = p.rutaId || p.ruta_id;
                        let ruta = null;
                        if (rutaIdParticipante) {
                            ruta = data.rutas.find(r => r.id === rutaIdParticipante);
                        }
                        if (!ruta) {
                            // Fallback: buscar por nombre (compatibilidad con datos antiguos)
                            const rutaNombre = p.ruta_nombre || p.ruta || '';
                            ruta = data.rutas.find(r => r.nombre === rutaNombre);
                        }
                        const rutaNombre = ruta ? ruta.nombre : (p.ruta_nombre || p.ruta || 'Sin ruta');
                        const rutaFecha = ruta ? formatearFechaCorta(ruta.fecha) : '';
                        
                        const historial = calcularRutasPorPersona(p.nombre);
                        const nombreEscAttr = escapeAttr(p.nombre || '');
                        let badgeHtml = '';
                        if (historial.rango) {
                            const tooltip = `${historial.rango.emoji} ${historial.rango.nombre}\n• Rutas asistidas: ${historial.totalRutas}\n• Participaciones: ${historial.totalParticipaciones}\n• Asistencias: ${historial.totalAsistidas} ✅\n• Ausencias: ${historial.totalNoAsistidas} ❌\n• Tasa: ${historial.porcentajeAsistencia}%`;
                            badgeHtml = `<span style="background: ${historial.rango.color}20; color: ${historial.rango.color}; padding: 2px 8px; border-radius: 12px; font-size: 10px; font-weight: 700; cursor: pointer; border: 1px solid ${historial.rango.color}40; display: inline-flex; align-items: center; gap: 4px;" onclick="verDetalleAventurero('${nombreEscAttr}')" title="${escapeAttr(tooltip)}">${historial.rango.emoji} ${historial.rango.nombre}</span>`;
                        }
                        return `
                            <div class="person-item-compact">
                                <div class="person-info-compact">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <div class="person-name-compact">${escapeHtml(p.nombre)}</div>
                                        ${badgeHtml}
                                    </div>
                                    <div class="person-meta-compact">
                                        <span>👤 ${escapeHtml(p.lider)}</span>
                                        <span>📍 ${escapeHtml(rutaNombre)}</span>
                                        ${rutaFecha ? `<span>📅 ${rutaFecha}</span>` : ''}
                                    </div>
                                </div>
                                <button class="person-delete-btn" onclick="eliminarParticipante('${p.id}')" title="Eliminar">
                                    🗑️
                                </button>
                            </div>
                        `;
                    }).join('')}
                </div>`;
            
            document.getElementById('listaParticipantes').innerHTML = html;
        }

        /** Devuelve reservas activas según filtros actuales de la pestaña Asistencia */
        function getReservasActivasAsistencia() {
            const liderFiltro = document.getElementById('filtroLiderAsistencia')?.value || '';
            const rutaFiltro = document.getElementById('filtroRutaAsistencia')?.value || '';
            const searchTerm = (document.getElementById('searchAsistencia')?.value || '').trim().toLowerCase();
            return (data.reservas || []).filter(reserva => {
                const ruta = data.rutas.find(r => r.id === reserva.rutaId);
                if (!ruta || ruta.archivada) return false;
                if (liderFiltro && reserva.lider !== liderFiltro) return false;
                if (rutaFiltro && reserva.rutaId !== rutaFiltro) return false;
                if (searchTerm && !reserva.lider.toLowerCase().includes(searchTerm)) return false;
                return true;
            });
        }

        /** Crea el DOM inicial de la lista de asistencia (solo si container está vacío o hay que reconstruir) */
        function crearEstructuraInicialAsistencia(container) {
            const reservasActivas = getReservasActivasAsistencia();
            if (reservasActivas.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📋</div>
                        <h3>No hay participantes</h3>
                        <p>Selecciona una ruta o registra personas</p>
                    </div>`;
                actualizarContadorCheckin();
                return;
            }
            const html = reservasActivas.map(reserva => {
                const lider = reserva.lider;
                const ruta = data.rutas.find(r => r.id === reserva.rutaId);
                if (!ruta) return '';
                const cardId = getAsistenciaCardId(lider, reserva.rutaId);
                const rutaNombre = ruta.nombre;
                const rutaFecha = formatearFechaCorta(ruta.fecha);
                const participantes = obtenerParticipantesReserva(lider, reserva.rutaId);
                const presentes = participantes.filter(p => p.asiste).length;
                const total = participantes.length || 1;
                const porcentaje = Math.round((presentes / total) * 100);
                const liderEsc = escapeAttr(lider || '');
                const rutaIdEsc = escapeAttr(reserva.rutaId || '');
                return `
                    <div class="attendance-group-compact asistencia-card" id="${cardId}" data-lider="${liderEsc}" data-ruta-id="${rutaIdEsc}">
                        <div class="asistencia-compact">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div style="flex: 1;">
                                    <div class="attendance-title-compact" style="margin-bottom: 4px;">📍 ${escapeHtml(rutaNombre || '')}${rutaFecha ? ` - ${rutaFecha}` : ''}</div>
                                    <div class="attendance-meta-compact" style="margin-bottom: 8px;">
                                        <span>👤 ${escapeHtml(lider || '')}</span>
                                        <span class="contador-presentes" data-for-card="${cardId}">📊 ${presentes}/${total} presentes</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 12px; font-size: 13px;">
                                        <div class="attendance-progress-container" style="flex: 1; max-width: 120px;">
                                            <div class="attendance-progress-bar" style="height: 6px; background: rgba(255,255,255,0.1); border-radius: 999px; overflow: hidden;">
                                                <div class="attendance-progress-fill" data-for-card="${cardId}" style="height: 100%; width: ${porcentaje}%; background: ${porcentaje >= 80 ? 'var(--success)' : porcentaje >= 50 ? '#fbbf24' : 'var(--danger)'};"></div>
                                            </div>
                                        </div>
                                        <span class="porcentaje-presentes" data-for-card="${cardId}" style="color: var(--text-secondary); font-weight: 600;">${porcentaje}%</span>
                                    </div>
                                </div>
                                <button class="btn-expand-reserva" onclick="toggleAsistenciaCard('${cardId}')" title="Ver lista completa">
                                    <span class="expand-icon">▼</span>
                                </button>
                            </div>
                        </div>
                        <div class="asistencia-expanded" style="display: none;">
                            <div class="attendance-list-compact" id="lista-participantes-${cardId}"></div>
                        </div>
                    </div>
                `;
            }).filter(h => h !== '').join('');
            container.innerHTML = html;
            reservasActivas.forEach(reserva => {
                const cardId = getAsistenciaCardId(reserva.lider, reserva.rutaId);
                actualizarCardAsistencia(cardId);
            });
            cardsAsistenciaExpandidos.forEach(cardId => {
                const card = document.getElementById(cardId);
                if (card) {
                    const expanded = card.querySelector('.asistencia-expanded');
                    const icon = card.querySelector('.expand-icon');
                    if (expanded && icon) {
                        expanded.style.display = 'block';
                        icon.textContent = '▲';
                        icon.style.transform = 'rotate(0deg)';
                        const lider = card.dataset.lider;
                        const rutaId = card.dataset.rutaId;
                        if (lider && rutaId) actualizarListaParticipantesCard(cardId, obtenerParticipantesReserva(lider, rutaId));
                    }
                }
            });
            actualizarContadorCheckin();
        }

        /** Actualiza solo los datos de los cards existentes (sin reemplazar DOM) */
        function actualizarDatosAsistencia() {
            const container = document.getElementById('listaAsistencia');
            if (!container) return;
            const reservasActivas = getReservasActivasAsistencia();
            const expectedIds = new Set(reservasActivas.map(r => getAsistenciaCardId(r.lider, r.rutaId)));
            const existingIds = new Set(Array.from(container.children).map(el => el.id).filter(Boolean));
            const sameSet = expectedIds.size === existingIds.size && [...expectedIds].every(id => existingIds.has(id));
            if (!sameSet || container.querySelector('.empty-state')) {
                crearEstructuraInicialAsistencia(container);
                return;
            }
            expectedIds.forEach(cardId => actualizarCardAsistencia(cardId));
            cardsAsistenciaExpandidos.forEach(cardId => {
                const card = document.getElementById(cardId);
                if (card) {
                    const expanded = card.querySelector('.asistencia-expanded');
                    if (expanded && expanded.style.display !== 'none') {
                        const participantes = obtenerParticipantesReserva(card.dataset.lider, card.dataset.rutaId);
                        actualizarListaParticipantesCard(cardId, participantes);
                    }
                }
            });
            actualizarContadorCheckin();
        }

        // RENDER ASISTENCIA (granular: solo crea estructura si vacía, sino actualiza datos)
        function renderAsistencia() {
            const container = document.getElementById('listaAsistencia');
            if (!container) return;
            if (container.children.length === 0 || container.querySelector('.empty-state')) {
                crearEstructuraInicialAsistencia(container);
                return;
            }
            actualizarDatosAsistencia();
        }

        // AGREGAR GASTO
        /**
         * Registra un nuevo gasto asociado a una ruta
         * Incluye validaciones mejoradas y feedback visual
         * @returns {Promise<void>}
         */
        async function agregarGasto() {
            const concepto = document.getElementById('gastoConcepto').value.trim();
            const rutaId = document.getElementById('gastoRuta').value; // 🔥 CORRECCIÓN: Variable se llama rutaId
            const monto = parseFloat(document.getElementById('gastoMonto').value);

            // Validaciones mejoradas
            if (!concepto || concepto.length < 2) {
                showToast('El concepto debe tener al menos 2 caracteres', 'warning', 'Validación');
                document.getElementById('gastoConcepto').focus();
                return;
            }

            if (!rutaId) {
                showToast('Selecciona una ruta', 'warning', 'Validación');
                document.getElementById('gastoRuta').focus();
                return;
            }

            if (!monto || monto <= 0 || monto > 10000000) {
                showToast('El monto debe ser un valor positivo menor a 10,000,000', 'warning', 'Validación');
                document.getElementById('gastoMonto').focus();
                return;
            }

            try {
                showLoader('Registrando gasto...');
                
                // 🔥 CORRECCIÓN: Usar ruta_id (UUID) en lugar de ruta_nombre
                const { error } = await db
                    .from('gastos')
                    .insert([{
                        concepto,
                        ruta_id: rutaId, // 🔥 CORRECCIÓN: Usar ruta_id con UUID
                        monto,
                        fecha: new Date().toISOString()
                    }]);

                if (error) throw error;

                document.getElementById('gastoConcepto').value = '';
                document.getElementById('gastoRuta').value = '';
                document.getElementById('gastoMonto').value = '';

                closeModal('modalNuevoGasto');
                await saveData(true); // Usar saveData sin loader para evitar parpadeo
                updateSelects();
                renderGastos();
                renderRutas();
                showToast('Gasto registrado exitosamente', 'success', 'Éxito');
            } catch (error) {
                console.error('Error:', error);
                showToast('Error al registrar el gasto: ' + error.message, 'error', 'Error');
            } finally {
                hideLoader();
            }
        }

        async function eliminarGasto(id) {
    const gasto = data.gastos.find(g => g.id === id);
    if (!gasto) return;

    const mensaje =
        `Eliminar gasto "${gasto.concepto}"?\n\n` +
        `• Monto: Bs ${gasto.monto.toLocaleString()}\n` +
        `• Ruta: ${gasto.ruta}`;

    const ok = await confirmarAccion(mensaje, 'eliminar');
    if (!ok) return;

    try {
        // 🔥 NUEVO: Eliminar de Supabase PRIMERO
        const { error } = await db
            .from('gastos')
            .delete()
            .eq('id', id);
            
        if (error) throw error;

        // Recargar datos desde BD (sin loader para evitar parpadeo)
        await saveData(true);
        
        // Actualizar vistas
        renderGastos();
        renderRutas(); // Los gastos afectan el profit de las rutas
        
        showToast('Gasto eliminado exitosamente', 'success', 'Éxito');
        
    } catch (error) {
        console.error('Error al eliminar gasto:', error);
        showToast('Error al eliminar el gasto: ' + error.message, 'error', 'Error');
    }
}


        // Función para mostrar/ocultar check-in rápido
function toggleCheckinRapido(mostrar) {
    const elemento = document.getElementById('checkinRapido');
    const liderFiltro = document.getElementById('filtroLiderAsistencia')?.value;

    if (!elemento) return;

    if (mostrar && liderFiltro) {
        elemento.classList.add('active');
        actualizarContadorCheckin();
    } else {
        elemento.classList.remove('active');
    }
}

// Actualizar contador de check-in
function actualizarContadorCheckin() {
    const liderFiltro = document.getElementById('filtroLiderAsistencia')?.value;
    if (!liderFiltro) {
        document.getElementById('checkinContador').textContent = "0/0";
        return;
    }

    // Participantes del líder seleccionado (todas sus rutas)
    const participantes = data.participantes.filter(p => p.lider === liderFiltro);

    const presentes = participantes.filter(p => p.asiste).length;
    const total = participantes.length;

    document.getElementById('checkinContador').textContent = `${presentes}/${total}`;

    const checkinTitle = document.querySelector('.checkin-title');
    if (checkinTitle) {
        checkinTitle.innerHTML =
            `📋 ${liderFiltro} <span class="checkin-contador">${presentes}/${total}</span>`;
    }
}

// Marcar todos como presentes (actualización granular, sin loadData)
async function marcarTodosPresentes() {
    const liderFiltro = document.getElementById('filtroLiderAsistencia')?.value;
    if (!liderFiltro) {
        showToast('Selecciona un líder primero', 'warning', 'Selección Requerida');
        return;
    }

    const participantes = data.participantes.filter(p =>
        !p.asiste && p.lider === liderFiltro
    );

    if (participantes.length === 0) {
        showToast('Todos ya están marcados', 'info', 'Información');
        return;
    }

    const ok = await confirmarAccion(
        `¿Marcar ${participantes.length} persona${participantes.length !== 1 ? 's' : ''} como presentes?`,
        'pregunta'
    );
    if (!ok) return;

    try {
        participantes.forEach(p => misAccionesRecientes.add(p.id));
        setTimeout(() => participantes.forEach(p => misAccionesRecientes.delete(p.id)), 3000);

        for (const p of participantes) {
            await db.from('participantes').update({ asiste: true }).eq('id', p.id);
            p.asiste = true;
        }

        const cardsAActualizar = new Set();
        participantes.forEach(p => {
            const cardId = encontrarCardPorParticipante(p);
            if (cardId) cardsAActualizar.add(cardId);
        });
        cardsAActualizar.forEach(cardId => actualizarCardAsistencia(cardId));
        actualizarContadorCheckin();
        showToast(`${participantes.length} marcados como presentes`, 'success', 'Éxito');
    } catch (err) {
        console.error(err);
        participantes.forEach(p => { p.asiste = false; });
        document.querySelectorAll('#listaAsistencia .attendance-group-compact').forEach(card => {
            const id = card.id;
            if (id) actualizarCardAsistencia(id);
        });
        actualizarContadorCheckin();
        showToast('Error al marcar asistencia', 'error', 'Error');
    }
}

        // RENDER GASTOS
        function renderGastos() {
            const search = document.getElementById('searchGastos').value.toLowerCase();
            const filtroRuta = document.getElementById('filtroRutaGastos').value;

            // Filtrar gastos: excluir los de rutas archivadas
            // 🔥 CORRECCIÓN: Buscar ruta por ID, no por nombre
            let filtered = data.gastos.filter(g => {
                const rutaIdGasto = g.rutaId || g.ruta_id;
                // Buscar ruta por ID
                const ruta = data.rutas.find(r => r.id === rutaIdGasto);
                if (!ruta || ruta.archivada) {
                    return false; // Excluir gastos de rutas archivadas o que no existan
                }
                
                // Aplicar filtro de búsqueda (usar nombre de ruta si está disponible)
                const nombreRuta = ruta ? ruta.nombre : (g.ruta || '');
                return g.concepto.toLowerCase().includes(search) ||
                       nombreRuta.toLowerCase().includes(search);
            });

            if (filtroRuta) {
                filtered = filtered.filter(g => g.rutaId === filtroRuta);
            }

            const html = filtered.length === 0 ?
                `<div class="empty-state">
                    <div class="empty-state-icon">💸</div>
                    <h3>No hay gastos registrados</h3>
                    <p>Registra los gastos de las rutas</p>
                </div>` :
                `<div class="person-list-compact">
                    ${filtered.map((gasto) => {
                        // 🔥 CORRECCIÓN: Buscar ruta por ID para obtener el nombre
                        const rutaIdGasto = gasto.rutaId || gasto.ruta_id;
                        const ruta = data.rutas.find(r => r.id === rutaIdGasto);
                        const nombreRuta = ruta ? ruta.nombre : (gasto.ruta || 'Sin ruta');
                        const fecha = new Date(gasto.fecha).toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
                        return `
                            <div class="person-item-compact">
                                <div class="person-info-compact">
                                    <div class="person-name-compact">${gasto.concepto}</div>
                                    <div class="person-meta-compact">
                                        <span>📍 ${nombreRuta}</span>
                                        <span>📅 ${fecha}</span>
                                        <span style="color: var(--danger); font-weight: 700;">Bs ${gasto.monto.toLocaleString()}</span>
                                    </div>
                                </div>
                                <button class="person-delete-btn" onclick="eliminarGasto('${gasto.id}')" title="Eliminar">
                                    🗑️
                                </button>
                            </div>
                        `;
                    }).join('')}
                </div>`;

            document.getElementById('listaGastos').innerHTML = html;
        }

        // RENDER HISTORIAL
        function renderHistorial() {
            const search = document.getElementById('searchHistorial').value.toLowerCase();
            
            // Filtrar solo rutas archivadas
            const rutasArchivadas = data.rutas
                .filter(r => r.archivada)
                .filter(r => 
                    r.nombre.toLowerCase().includes(search) || 
                    r.fecha.includes(search)
                )
                .sort((a, b) => new Date(b.fecha) - new Date(a.fecha)); // Más recientes primero

            const html = rutasArchivadas.length === 0 ?
                `<div class="empty-state">
                    <div class="empty-state-icon">📚</div>
                    <h3>No hay rutas archivadas</h3>
                    <p>Las rutas archivadas aparecerán aquí</p>
                </div>` :
                rutasArchivadas.map(ruta => {
                    const idCorto = ruta.numero ? `#${String(ruta.numero).padStart(4, '0')}` : '';
                    const reservasRuta = data.reservas.filter(r => r.rutaId === ruta.id);
                    const recaudado = calcularTotalRecaudado(ruta.id);
                    const gastos = calcularTotalGastos(ruta.id);
                    const profitNeto = calcularProfitNeto(ruta.id);
                    const totalDolares = calcularTotalDolares(ruta.id);
                    // Usar campo normalizado (siempre disponible después de loadData/saveData)
                    const precioEuros = ruta.precioEuros || 0;
                    
                    // Calcular asistencia (presentes vs cupos reservados) — solo participantes de esta ruta
                    const participantesRuta = data.participantes.filter(p => 
                        (p.rutaId === ruta.id || p.ruta_id === ruta.id) || ((p.ruta_nombre || p.ruta) === ruta.nombre)
                    );
                    const presentes = participantesRuta.filter(p => p.asiste).length;
                    const cuposReservados = reservasRuta.reduce((sum, r) => sum + r.cantidad, 0);
                    const porcentajeAsistencia = cuposReservados > 0 ? (presentes / cuposReservados * 100).toFixed(0) : 0;
                    const ocupados = calcularCuposOcupados(ruta.id);
                    const cardId = `ruta-archivada-${ruta.id || ruta.nombre.replace(/\s+/g, '-').toLowerCase()}`;
                    
                    return `
                        <div class="card" style="margin-bottom: 16px;" id="${cardId}">
                            <!-- VISTA COMPACTA (siempre visible) -->
                            <div class="reserva-compact">
                                <div class="card-header">
                                    <div>
                                        <div class="card-title" style="margin-bottom: 4px;">
                                            <span>🏔️ ${ruta.nombre}</span>
                                            ${idCorto ? `<span style="font-size: 11px; color: var(--text-secondary); font-weight: normal; margin-left: 6px;">${idCorto}</span>` : ''}
                                        </div>
                                        <div class="card-meta" style="margin-bottom: 8px;">
                                            📅 ${formatearFechaRuta(ruta.fecha)}
                                        </div>
                                    </div>
                                    <span class="badge badge-closed" style="font-size: 10px;">Archivada</span>
                                </div>
                                <div style="display: flex; gap: 16px; font-size: 13px; color: var(--text-secondary); margin-top: 4px;">
                                    <span>💰 Bs ${recaudado.toLocaleString()}${totalDolares > 0 ? ` + $${totalDolares.toLocaleString()}` : ''}</span>
                                    <span style="color: var(--danger);">💸 Bs ${gastos.toLocaleString()}</span>
                                    <span style="color: ${profitNeto >= 0 ? 'var(--success)' : 'var(--danger)'}; font-weight: 600;">📊 Bs ${profitNeto.toLocaleString()}</span>
                                </div>
                            </div>
                            
                            <!-- VISTA EXPANDIDA (oculta por defecto) -->
                            <div class="reserva-expanded" style="display: none; margin-top: 12px;">
                                <div style="margin-top: 16px; padding: 12px; background: rgba(118, 200, 147, 0.1); border-radius: 12px; border: 1px solid var(--border);">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 8px;">
                                        <div>
                                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">💰 Recaudado (Bs)</div>
                                            <div style="font-size: 16px; font-weight: 800; color: var(--success);">Bs ${recaudado.toLocaleString()}</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">💵 USD Efectivo</div>
                                            <div style="font-size: 16px; font-weight: 800; color: #f59e0b;">$${totalDolares.toLocaleString()}</div>
                                        </div>
                                    </div>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 8px;">
                                        <div>
                                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">💸 Gastos</div>
                                            <div style="font-size: 16px; font-weight: 800; color: var(--danger);">Bs ${gastos.toLocaleString()}</div>
                                        </div>
                                    </div>
                                    <div style="padding-top: 8px; border-top: 1px solid var(--border);">
                                        <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">📊 Profit Neto</div>
                                        <div style="font-size: 20px; font-weight: 800; color: ${profitNeto >= 0 ? 'var(--success)' : 'var(--danger)'};">Bs ${profitNeto.toLocaleString()}</div>
                                    </div>
                                </div>
                                
                                ${cuposReservados > 0 ? `
                                <div style="margin-top: 16px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                                        <span style="font-size: 12px; color: var(--text-secondary);">📋 Asistencia: ${presentes}/${cuposReservados} presentes</span>
                                        <span style="font-size: 12px; color: var(--text-secondary); font-weight: 600;">${porcentajeAsistencia}%</span>
                                    </div>
                                    <div class="progress-bar" style="height: 6px;">
                                        <div class="progress-fill" style="width: ${porcentajeAsistencia}%; background: ${porcentajeAsistencia >= 80 ? 'var(--success)' : porcentajeAsistencia >= 50 ? '#fbbf24' : 'var(--danger)'};"></div>
                                    </div>
                                </div>
                                ` : ''}

                                ${reservasRuta.length > 0 ? `
                                    <div style="margin-top: 20px;">
                                        <div style="font-weight: 700; margin-bottom: 16px; color: var(--accent); font-size: 16px;">👥 Reservas y Participantes</div>
                                        ${reservasRuta.map(reserva => {
                                            const participantesReserva = data.participantes.filter(p => 
                                                p.lider === reserva.lider && 
                                                (p.rutaId === reserva.rutaId || p.ruta_id === reserva.rutaId || (p.ruta_nombre || p.ruta) === ruta.nombre)
                                            );
                                            const presentes = participantesReserva.filter(p => p.asiste).length;
                                            const totalPagado = reserva.montoPagado || 0; // Usar campo normalizado
                                            
                                            // Calcular totales de pagos
                                            const totalBs = (reserva.pagos || [])
                                                .filter(p => !p.enDolares)
                                                .reduce((sum, p) => sum + p.monto, 0);
                                            const totalDolaresReserva = (reserva.pagos || [])
                                                .filter(p => p.enDolares)
                                                .reduce((sum, p) => sum + p.monto, 0);
                                            
                                            return `
                                                <div style="background: rgba(118, 200, 147, 0.05); border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin-bottom: 12px;">
                                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                                        <div>
                                                            <div style="font-weight: 700; font-size: 15px; color: var(--text-primary);">👤 ${reserva.lider}</div>
                                                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                                                                Cupos: ${reserva.cantidad} | Pagado: Bs ${totalBs.toLocaleString()}${totalDolaresReserva > 0 ? ` + $${totalDolaresReserva.toLocaleString()}` : ''}
                                                            </div>
                                                        </div>
                                                        <span class="badge badge-active">${presentes}/${participantesReserva.length} presentes</span>
                                                    </div>
                                                    
                                                    ${participantesReserva.length > 0 ? `
                                                        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);">
                                                            <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px; font-weight: 600;">Participantes:</div>
                                                            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                                                ${participantesReserva.map(p => `
                                                                    <span style="padding: 6px 12px; background: ${p.asiste ? 'rgba(16, 185, 129, 0.2)' : 'rgba(118, 200, 147, 0.1)'}; border-radius: 8px; font-size: 12px; border: 1px solid ${p.asiste ? 'rgba(16, 185, 129, 0.3)' : 'var(--border)'};">
                                                                        ${p.asiste ? '✅' : '⭕'} ${p.nombre}
                                                                    </span>
                                                                `).join('')}
                                                            </div>
                                                        </div>
                                                    ` : '<div style="font-size: 12px; color: var(--text-secondary); margin-top: 8px;">Sin participantes registrados</div>'}
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                ` : '<div style="margin-top: 16px; padding: 12px; background: rgba(118, 200, 147, 0.05); border-radius: 12px; text-align: center; color: var(--text-secondary);">No hay reservas para esta ruta</div>'}
                            </div>

                            <!-- Botón de expandir/colapsar -->
                            <div style="margin-top: 12px; display: flex; justify-content: center;">
                                <button class="btn btn-outline btn-small" onclick="toggleRutaArchivadaCard('${cardId}')" title="Ver detalles" style="min-width: 140px; border-radius: 999px; display: inline-flex; align-items: center; justify-content: center; gap: 6px;">
                                    <span class="expand-icon">▼</span>
                                    <span>Ver detalles</span>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            
            document.getElementById('listaHistorial').innerHTML = html;
        }

        function renderEstadisticasGlobales(ranking) {
            const container = document.getElementById('statsGlobalesContent');
            if (!container) return;
            const totalAventurados = ranking.length;
            const totalRutas = ranking.reduce((sum, p) => sum + p.rutasAsistidas, 0);
            const promedioRutas = totalAventurados > 0 ? (totalRutas / totalAventurados).toFixed(1) : 0;
            const mejorAsistencia = [...ranking].sort((a, b) => b.porcentajeAsistencia - a.porcentajeAsistencia)[0];
            const masRutas = [...ranking].sort((a, b) => b.rutasAsistidas - a.rutasAsistidas)[0];
            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 16px;">
                    <div class="stat"><span class="stat-value">${totalAventurados}</span><span class="stat-label">Aventurados</span></div>
                    <div class="stat"><span class="stat-value">${promedioRutas}</span><span class="stat-label">Prom. rutas</span></div>
                    <div class="stat"><span class="stat-value">${masRutas ? masRutas.rutasAsistidas : 0}</span><span class="stat-label">Máx. rutas</span>${masRutas ? `<div style="font-size: 10px; color: var(--text-secondary);">${escapeHtml(masRutas.nombre)}</div>` : ''}</div>
                    <div class="stat"><span class="stat-value">${mejorAsistencia ? mejorAsistencia.porcentajeAsistencia + '%' : '0%'}</span><span class="stat-label">Mejor %</span>${mejorAsistencia ? `<div style="font-size: 10px; color: var(--text-secondary);">${escapeHtml(mejorAsistencia.nombre)}</div>` : ''}</div>
                </div>`;
        }

        function renderTop10(top10) {
            const container = document.getElementById('top10Content');
            if (!container) return;
            if (top10.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-secondary);">No hay aventurados aún</div>';
                return;
            }
            container.innerHTML = `<div class="person-list-compact">${top10.map((aventurero, index) => {
                const medalla = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : `${index + 1}.`;
                const nombreEscAttr = escapeAttr(aventurero.nombre || '');
                const nombreEscHtml = escapeHtml(aventurero.nombre);
                return `<div class="person-item-compact" onclick="verDetalleAventurero('${nombreEscAttr}')" style="cursor: pointer; border-left: 4px solid ${aventurero.rango.color}; background: ${index < 3 ? 'rgba(118, 200, 147, 0.05)' : 'transparent'};">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="width: 32px; height: 32px; background: ${index < 3 ? 'rgba(118, 200, 147, 0.2)' : 'rgba(255,255,255,0.05)'}; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: ${index < 3 ? '16px' : '14px'}; color: ${index < 3 ? 'var(--accent)' : 'var(--text-secondary)'}; flex-shrink: 0; border: 2px solid ${index < 3 ? 'var(--accent)' : 'transparent'};">${medalla}</div>
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                <div style="font-weight: 700; font-size: 14px; color: var(--text-primary);">${nombreEscHtml}</div>
                                <span style="background: ${aventurero.rango.color}20; color: ${aventurero.rango.color}; padding: 2px 8px; border-radius: 12px; font-size: 10px; font-weight: 700;">${aventurero.rango.emoji} ${aventurero.rango.nombre}</span>
                            </div>
                            <div style="font-size: 12px; color: var(--text-secondary); display: flex; gap: 12px;"><span>🏔️ ${aventurero.rutasAsistidas} rutas</span><span>📊 ${aventurero.porcentajeAsistencia}% asistencia</span></div>
                        </div>
                    </div>
                </div>`;
            }).join('')}</div>`;
        }

        function renderListaRanking(ranking) {
            const container = document.getElementById('listaRanking');
            if (!container) return;
            if (ranking.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);"><div style="font-size: 32px; margin-bottom: 8px;">🔍</div><p>No hay aventurados que coincidan</p></div>';
                return;
            }
            container.innerHTML = `<div class="person-list-compact">${ranking.map(aventurero => {
                const nombreEscAttr = escapeAttr(aventurero.nombre || '');
                const nombreEscHtml = escapeHtml(aventurero.nombre);
                const progPct = aventurero.totalParaSiguiente > 0 ? Math.min(100, (aventurero.progreso / aventurero.totalParaSiguiente) * 100) : 0;
                return `<div class="person-item-compact" onclick="verDetalleAventurero('${nombreEscAttr}')" style="cursor: pointer; border-left: 4px solid ${aventurero.rango.color};">
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                            <div style="font-weight: 700; font-size: 14px; color: var(--text-primary);">${nombreEscHtml}</div>
                            <span style="background: ${aventurero.rango.color}20; color: ${aventurero.rango.color}; padding: 2px 8px; border-radius: 12px; font-size: 10px; font-weight: 700; display: inline-flex; align-items: center; gap: 4px;">${aventurero.rango.emoji} ${aventurero.rango.nombre}</span>
                        </div>
                        <div style="font-size: 12px; color: var(--text-secondary); display: flex; gap: 12px; margin-bottom: 8px;">
                            <span>🏔️ ${aventurero.rutasAsistidas} rutas</span><span>✅ ${aventurero.totalAsistidas}/${aventurero.totalParticipaciones}</span><span>📊 ${aventurero.porcentajeAsistencia}%</span>
                        </div>
                        ${aventurero.siguienteRango ? `<div style="margin-top: 8px;"><div style="display: flex; justify-content: space-between; font-size: 10px; color: var(--text-secondary); margin-bottom: 4px;"><span>Progreso a ${aventurero.siguienteRango.emoji} ${aventurero.siguienteRango.nombre}:</span><span>${aventurero.progreso}/${aventurero.totalParaSiguiente}</span></div><div style="height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden;"><div style="height: 100%; width: ${progPct}%; background: ${aventurero.siguienteRango.color}; border-radius: 2px;"></div></div></div>` : ''}
                    </div>
                </div>`;
            }).join('')}</div>`;
        }

        async function renderAbonados() {
            try {
                const { data: abonadosRaw, error } = await db.from('abonados').select('*').order('saldo_euros', { ascending: false });
                if (error) throw error;
                const abonados = (abonadosRaw || []).filter(a => parseFloat(a.saldo_euros || 0) > 0);
                const totalAbonados = abonados.length;
                const totalSaldo = abonados.reduce((sum, a) => sum + parseFloat(a.saldo_euros || 0), 0);
                const promedio = totalAbonados > 0 ? totalSaldo / totalAbonados : 0;
                const elTotal = document.getElementById('totalAbonados');
                const elSaldo = document.getElementById('totalSaldoEuros');
                const elProm = document.getElementById('promedioSaldo');
                if (elTotal) elTotal.textContent = totalAbonados;
                if (elSaldo) elSaldo.textContent = '€' + totalSaldo.toFixed(2);
                if (elProm) elProm.textContent = '€' + promedio.toFixed(2);

                const search = (document.getElementById('searchAbonados')?.value || '').toLowerCase();
                const abonadosFiltrados = abonados.filter(a => (a.lider || '').toLowerCase().includes(search));

                const container = document.getElementById('listaAbonados');
                if (!container) return;
                if (abonadosFiltrados.length === 0) {
                    container.innerHTML = `<div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);"><div style="font-size: 32px; margin-bottom: 8px;">💰</div><p>${search ? 'No hay abonados que coincidan' : 'No hay abonados con saldo'}</p>${!search ? `<button type="button" class="btn btn-primary" onclick="abrirModalNuevoAbono()" style="margin-top: 16px;">+ Agregar primer abonado</button>` : ''}</div>`;
                    return;
                }
                container.innerHTML = `<div class="person-list-compact">${abonadosFiltrados.map(abonado => {
                    const saldo = parseFloat(abonado.saldo_euros || 0);
                    const colorSaldo = saldo > 100 ? 'var(--success)' : saldo > 20 ? '#f59e0b' : 'var(--text-primary)';
                    const ultima = abonado.ultima_actualizacion ? new Date(abonado.ultima_actualizacion).toLocaleDateString('es-ES') : 'Sin movimientos';
                    const notas = abonado.notas ? (abonado.notas.substring(0, 30) + (abonado.notas.length > 30 ? '...' : '')) : '';
                    const liderAttr = escapeAttr(abonado.lider || '');
                    const liderHtml = escapeHtml(abonado.lider);
                    const notasHtml = notas ? escapeHtml(notas) : '';
                    return `<div class="person-item-compact"><div class="person-info-compact"><div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;"><div class="person-name-compact">${liderHtml}</div><span style="font-size: 18px; font-weight: 800; color: ${colorSaldo};">€${saldo.toFixed(2)}</span></div><div class="person-meta-compact"><span>📅 ${ultima}</span>${notas ? `<span>📝 ${notasHtml}</span>` : ''}</div></div><div style="display: flex; gap: 8px;"><button type="button" class="btn btn-success btn-small" onclick="verMovimientosAbonado('${abonado.id}', '${liderAttr}')">📋</button><button type="button" class="btn btn-primary btn-small" onclick="abrirModalCargarSaldo('${liderAttr}')">+€</button></div></div>`;
                }).join('')}</div>`;
            } catch (err) {
                console.error('Error cargando abonados:', err);
                const c = document.getElementById('listaAbonados');
                if (c) c.innerHTML = '<div style="text-align: center; padding: 40px 20px; color: var(--danger);">❌ Error al cargar abonados</div>';
            }
        }

        async function verMovimientosAbonado(abonadoId, lider) {
            try {
                const [{ data: abonado, error: errAbonado }, { data: movimientos, error: errMov }] = await Promise.all([
                    db.from('abonados').select('*').eq('id', abonadoId).single(),
                    db.from('movimientos_abonos').select('*').eq('abonado_id', abonadoId).order('fecha', { ascending: true })
                ]);
                if (errAbonado || !abonado) { showToast('Abonado no encontrado', 'error'); return; }
                if (errMov) throw errMov;

                const saldoActual = parseFloat(abonado.saldo_euros || 0).toFixed(2);
                let html = `<div style="margin-bottom: 20px;"><div style="font-size: 24px; font-weight: 800; color: var(--accent); margin-bottom: 4px;">${escapeHtml(lider)}</div><div style="font-size: 18px; font-weight: 700; color: var(--success);">Saldo actual: €${saldoActual}</div>${abonado.notas ? `<div style="margin-top: 8px; font-size: 14px; color: var(--text-secondary);">📝 ${escapeHtml(abonado.notas)}</div>` : ''}</div>`;

                if (movimientos && movimientos.length > 0) {
                    html += `<div style="margin-bottom: 16px;"><div style="font-size: 16px; font-weight: 700; margin-bottom: 12px;">📋 Historial de Movimientos</div><div style="max-height: 400px; overflow-y: auto; padding-right: 8px;">`;
                    movimientos.forEach(mov => {
                        const esCarga = mov.tipo === 'carga';
                        const color = esCarga ? 'var(--success)' : 'var(--danger)';
                        const signo = esCarga ? '+' : '-';
                        const fecha = new Date(mov.fecha).toLocaleDateString('es-ES', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                        const rutaObj = data.rutas && mov.ruta_id ? data.rutas.find(r => r.id === mov.ruta_id) : null;
                        const rutaIdTexto = rutaObj ? (rutaObj.numero != null && rutaObj.numero !== '' ? ('#' + String(rutaObj.numero).padStart(4, '0')) : (rutaObj.nombre || '')) : '';
                        const saldoAntes = parseFloat(mov.saldo_antes || 0).toFixed(2);
                        const saldoDespues = parseFloat(mov.saldo_despues || 0).toFixed(2);
                        html += `<div style="padding: 12px; background: rgba(118, 200, 147, 0.05); border-radius: 8px; margin-bottom: 8px; border-left: 4px solid ${color};"><div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 4px;"><div style="font-weight: 700; font-size: 14px; color: ${color};">${signo}€${parseFloat(mov.monto_euros || 0).toFixed(2)} (${mov.tipo})</div><div style="font-size: 12px; color: var(--text-secondary);">${fecha}</div></div>${mov.descripcion ? `<div style="font-size: 13px; margin-bottom: 4px;">${escapeHtml(mov.descripcion)}</div>` : ''}${rutaIdTexto ? `<div style="font-size: 11px; color: var(--text-secondary);">Ruta: ${escapeHtml(rutaIdTexto)}</div>` : ''}<div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">Saldo: €${saldoAntes} → €${saldoDespues}</div></div>`;
                    });
                    html += '</div></div>';
                } else {
                    html += '<div style="text-align: center; padding: 20px; color: var(--text-secondary);">No hay movimientos registrados</div>';
                }

                const tituloEl = document.getElementById('modalHistorialRecurrenteTitulo');
                const cuerpoEl = document.getElementById('modalHistorialRecurrenteCuerpo');
                if (tituloEl && cuerpoEl) {
                    tituloEl.innerHTML = `💰 ${escapeHtml(lider)} - Movimientos`;
                    cuerpoEl.innerHTML = html;
                    window._shareHistorialTexto = null;
                    const btnWrap = document.getElementById('btnCompartirHistorialWrap');
                    if (btnWrap) btnWrap.style.display = 'none';
                    const modal = document.getElementById('modalHistorialRecurrente');
                    if (modal) modal.classList.add('active');
                }
            } catch (err) {
                console.error('Error cargando movimientos:', err);
                showToast('Error al cargar movimientos', 'error');
            }
        }

        function renderRanking() {
            const search = (document.getElementById('searchRanking')?.value || '').toLowerCase();
            const filtroRango = document.getElementById('filtroRangoRanking')?.value || '';
            const rankingCompleto = generarRankingAventurados();
            let rankingFiltrado = rankingCompleto;
            if (search) rankingFiltrado = rankingFiltrado.filter(p => (p.nombre || '').toLowerCase().includes(search));
            if (filtroRango) rankingFiltrado = rankingFiltrado.filter(p => p.rango && p.rango.nombre === filtroRango);
            renderEstadisticasGlobales(rankingCompleto);
            renderTop10(rankingCompleto.slice(0, 10));
            renderListaRanking(rankingFiltrado);
        }

        function verDetalleAventurero(nombre) {
            window._nombrePersonaHistorialActual = nombre || '';
            const historial = calcularRutasPorPersona(nombre);
            if (!historial.rango) return;
            const nombreEsc = escapeHtml(nombre || '');
            const progPct = historial.siguienteRango && historial.totalParaSiguiente > 0
                ? Math.min(100, (historial.progresoHaciaSiguiente / historial.totalParaSiguiente) * 100)
                : 0;
            const faltanAsistencias = historial.siguienteRango ? historial.siguienteRango.minRutas - historial.totalAsistidas : 0;
            const rutasHtml = historial.rutasAsistidas.length > 0
                ? `<div><div style="font-size: 14px; font-weight: 700; margin-bottom: 12px;">🏔️ Rutas asistidas</div><div style="display: flex; flex-wrap: wrap; gap: 8px;">${historial.rutasAsistidas.slice(0, 8).map(r => {
                    const nombre = escapeHtml(r.nombre || '');
                    const veces = r.vecesAsistio || 1;
                    const badgeRepetida = veces > 1 ? ` <span style="background: var(--accent); color: var(--bg-dark); padding: 2px 6px; border-radius: 6px; font-size: 11px; font-weight: 700;">x${veces}</span>` : '';
                    return `<span style="background: rgba(118, 200, 147, 0.1); padding: 6px 10px; border-radius: 8px; font-size: 12px; border: 1px solid var(--border);">${nombre}${badgeRepetida}</span>`;
                }).join('')}${historial.rutasAsistidas.length > 8 ? `<span style="background: rgba(118, 200, 147, 0.05); padding: 6px 10px; border-radius: 8px; font-size: 12px; color: var(--text-secondary); border: 1px dashed var(--border);">+${historial.rutasAsistidas.length - 8} más</span>` : ''}</div></div>`
                : '';
            const siguienteHtml = historial.siguienteRango ? `<div style="margin-bottom: 20px; padding: 16px; background: rgba(118, 200, 147, 0.1); border-radius: 12px;"><div style="font-size: 14px; font-weight: 700; margin-bottom: 8px; color: ${historial.siguienteRango.color}">${historial.siguienteRango.emoji} Próximo rango: ${historial.siguienteRango.nombre}</div><div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">Necesitas ${faltanAsistencias} asistencia${faltanAsistencias !== 1 ? 's' : ''} más</div><div class="progress-bar" style="height: 8px; background: rgba(255,255,255,0.1); margin-bottom: 4px;"><div style="height: 100%; width: ${progPct}%; background: ${historial.siguienteRango.color}; border-radius: 4px;"></div></div><div style="display: flex; justify-content: space-between; font-size: 11px; color: var(--text-secondary);"><span>${historial.progresoHaciaSiguiente}/${historial.totalParaSiguiente}</span><span>${progPct.toFixed(0)}%</span></div></div>` : '';
            const html = `<div style="text-align: center; margin-bottom: 20px;"><div style="font-size: 48px; margin-bottom: 8px;">${historial.rango.emoji}</div><div style="font-size: 20px; font-weight: 800; color: ${historial.rango.color}; margin-bottom: 4px;">${historial.rango.nombre}</div><div style="font-size: 14px; color: var(--text-secondary);">${nombreEsc}</div></div><div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px;"><div class="stat"><span class="stat-value" style="color: ${historial.rango.color};">${historial.totalRutas}</span><span class="stat-label">Rutas asistidas</span></div><div class="stat"><span class="stat-value">${historial.totalParticipaciones}</span><span class="stat-label">Participaciones</span></div><div class="stat"><span class="stat-value" style="color: var(--success);">${historial.totalAsistidas}</span><span class="stat-label">✅ Asistencias</span></div><div class="stat"><span class="stat-value" style="color: var(--danger);">${historial.totalNoAsistidas}</span><span class="stat-label">❌ Ausencias</span></div></div><div style="margin-bottom: 20px;"><div style="font-size: 14px; font-weight: 700; margin-bottom: 8px;">📊 Tasa de asistencia</div><div class="progress-bar" style="height: 12px; margin-bottom: 8px;"><div class="progress-fill" style="width: ${historial.porcentajeAsistencia}%;"></div></div><div style="display: flex; justify-content: space-between; font-size: 12px;"><span>${historial.porcentajeAsistencia}%</span><span>${historial.totalAsistidas}/${historial.totalParticipaciones}</span></div></div>${siguienteHtml}${rutasHtml}`;
            const tituloEl = document.getElementById('modalHistorialRecurrenteTitulo');
            const cuerpoEl = document.getElementById('modalHistorialRecurrenteCuerpo');
            if (tituloEl && cuerpoEl) {
                tituloEl.innerHTML = `${historial.rango.emoji} ${nombreEsc} - ${historial.rango.nombre}`;
                cuerpoEl.innerHTML = html;
                let textoShare = `*${historial.rango.emoji} ${historial.rango.nombre}*\n\n`;
                textoShare += `👤 ${(nombre || '').replace(/\*/g, '')}\n\n`;
                textoShare += `📊 *Estadísticas* (rango por asistencias)\n`;
                textoShare += `• Rutas diferentes: ${historial.totalRutas}\n`;
                textoShare += `• Participaciones: ${historial.totalParticipaciones}\n\n`;
                if (historial.rutasAsistidas.length > 0) {
                    textoShare += `🏔️ *Rutas asistidas:*\n`;
                    historial.rutasAsistidas.slice(0, 15).forEach(r => {
                        const veces = r.vecesAsistio || 1;
                        const sufijo = veces > 1 ? ` x${veces}` : '';
                        textoShare += `• ${(r.nombre || '').replace(/\*/g, '')}${sufijo}\n`;
                    });
                    if (historial.rutasAsistidas.length > 15) textoShare += `• +${historial.rutasAsistidas.length - 15} más\n`;
                }
                if (historial.siguienteRango) {
                    const faltan = historial.siguienteRango.minRutas - historial.totalAsistidas;
                    textoShare += `\n🎯 Próximo rango: ${historial.siguienteRango.emoji} ${historial.siguienteRango.nombre} (faltan ${faltan} asistencias)`;
                }
                window._shareHistorialTexto = textoShare;
                const btnWrap = document.getElementById('btnCompartirHistorialWrap');
                if (btnWrap) btnWrap.style.display = 'block';
                const modal = document.getElementById('modalHistorialRecurrente');
                if (modal) modal.classList.add('active');
            }
        }

        // RENDER ALL
        function renderAll() {
            renderRutas();
            renderReservas();
            renderParticipantes();
            renderAsistencia();
            renderGastos();
            renderHistorial();
            renderRanking();
            if (typeof renderAbonados === 'function') renderAbonados();
            setTimeout(ajustarSelectsFiltro, 100);
        }

        // Versiones con debounce para inputs de búsqueda (300 ms)
        const DEBOUNCE_MS = 300;
        const debouncedRenderRutas = debounce(renderRutas, DEBOUNCE_MS);
        const debouncedRenderReservas = debounce(renderReservas, DEBOUNCE_MS);
        const debouncedRenderParticipantes = debounce(renderParticipantes, DEBOUNCE_MS);
        const debouncedRenderAsistencia = debounce(renderAsistencia, DEBOUNCE_MS);
        const debouncedRenderGastos = debounce(renderGastos, DEBOUNCE_MS);
        const debouncedRenderHistorial = debounce(renderHistorial, DEBOUNCE_MS);
        const debouncedRenderRanking = debounce(renderRanking, DEBOUNCE_MS);
        const debouncedRenderAbonados = typeof renderAbonados === 'function' ? debounce(renderAbonados, DEBOUNCE_MS) : function () {};

        // --- FUNCIÓN PARA AJUSTAR ESTILO DE SELECTS DE FILTRO ---
        function ajustarSelectFiltro(selectElement) {
            if (!selectElement) return;
            
            if (selectElement.value === '' || selectElement.value === null) {
                // Estado por defecto: solo flecha
                selectElement.classList.remove('has-value');
            } else {
                // Hay valor seleccionado: mostrar texto
                selectElement.classList.add('has-value');
            }
        }
        
        function ajustarSelectsFiltro() {
            const selects = document.querySelectorAll('.search-filter-select');
            selects.forEach(select => {
                ajustarSelectFiltro(select);
                
                // Ajustar al enfocar (para mostrar opciones)
                select.addEventListener('focus', () => {
                    select.classList.add('has-value');
                });
                
                // Ajustar al perder foco (volver al estado según valor)
                select.addEventListener('blur', () => {
                    ajustarSelectFiltro(select);
                });
            });
        }

    </script>
</body>
</html>